{
  "version": 3,
  "sources": ["../../../worker.mjs"],
  "sourceRoot": "C:\\Users\\leungs\\Documents\\Icenia-Website\\cloudflare-worker\\.wrangler\\tmp\\deploy-FEFamt",
  "sourcesContent": ["// Cloudflare Worker OAuth proxy for Decap CMS (based on sterlingwes/decap-proxy)\r\nconst GITHUB_AUTHORIZE = 'https://github.com/login/oauth/authorize';\r\nconst GITHUB_TOKEN = 'https://github.com/login/oauth/access_token';\r\nconst GITHUB_API = 'https://api.github.com';\r\n\r\n// Generate a simple random state\r\nfunction generateState() {\r\n  return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);\r\n}\r\n\r\n// Create OAuth client\r\nfunction createOAuth(env) {\r\n  return {\r\n    authorizeURL: ({ redirect_uri, scope, state }) => {\r\n      const params = new URLSearchParams({\r\n        response_type: 'code',\r\n        client_id: env.GITHUB_CLIENT_ID,\r\n        redirect_uri,\r\n        scope,\r\n        state\r\n      });\r\n      return `${GITHUB_AUTHORIZE}?${params.toString()}`;\r\n    },\r\n    \r\n    getToken: async ({ code, redirect_uri }) => {\r\n      const response = await fetch(GITHUB_TOKEN, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Accept': 'application/json',\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          client_id: env.GITHUB_CLIENT_ID,\r\n          client_secret: env.GITHUB_CLIENT_SECRET,\r\n          code,\r\n          redirect_uri,\r\n          grant_type: 'authorization_code'\r\n        })\r\n      });\r\n      \r\n      const json = await response.json();\r\n      if (json.error) {\r\n        throw new Error(json.error_description || json.error);\r\n      }\r\n      return json.access_token;\r\n    }\r\n  };\r\n}\r\n\r\n// Handle auth request\r\nasync function handleAuth(url, env) {\r\n  const provider = url.searchParams.get('provider');\r\n  if (provider !== 'github') {\r\n    return new Response('Invalid provider', { status: 400 });\r\n  }\r\n\r\n  const oauth2 = createOAuth(env);\r\n  const authorizationUri = oauth2.authorizeURL({\r\n    redirect_uri: `https://${url.hostname}/callback`,\r\n    scope: 'public_repo,user', // Use 'repo,user' for private repos, 'public_repo,user' for public\r\n    state: generateState()\r\n  });\r\n\r\n  return new Response(null, { \r\n    headers: { 'Location': authorizationUri }, \r\n    status: 301 \r\n  });\r\n}\r\n\r\n// Create callback response with the specific script that Decap CMS expects\r\nfunction callbackScriptResponse(status, token) {\r\n  return new Response(`\r\n<html>\r\n<head>\r\n  <script>\r\n    const receiveMessage = (message) => {\r\n      window.opener.postMessage(\r\n        'authorization:github:${status}:${JSON.stringify({ token })}',\r\n        '*'\r\n      );\r\n      window.removeEventListener(\"message\", receiveMessage, false);\r\n    }\r\n    window.addEventListener(\"message\", receiveMessage, false);\r\n    window.opener.postMessage(\"authorizing:github\", \"*\");\r\n  </script>\r\n</head>\r\n<body>\r\n  <p>Authorizing Decap...</p>\r\n</body>\r\n</html>`, \r\n    { \r\n      headers: { 'Content-Type': 'text/html' } \r\n    }\r\n  );\r\n}\r\n\r\n// Handle callback\r\nasync function handleCallback(url, env) {\r\n  const provider = url.searchParams.get('provider');\r\n  if (provider !== 'github') {\r\n    return new Response('Invalid provider', { status: 400 });\r\n  }\r\n\r\n  const code = url.searchParams.get('code');\r\n  if (!code) {\r\n    return new Response('Missing code', { status: 400 });\r\n  }\r\n\r\n  try {\r\n    const oauth2 = createOAuth(env);\r\n    const accessToken = await oauth2.getToken({\r\n      code,\r\n      redirect_uri: `https://${url.hostname}/callback`\r\n    });\r\n    \r\n    return callbackScriptResponse('success', accessToken);\r\n  } catch (error) {\r\n    console.error('OAuth error:', error);\r\n    return callbackScriptResponse('error', error.message);\r\n  }\r\n}\r\n\r\nfunction makeCorsHeaders() {\r\n  return {\r\n    'Access-Control-Allow-Origin': '*',\r\n    'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',\r\n    'Access-Control-Allow-Headers': 'Content-Type, Authorization',\r\n  };\r\n}\r\n\r\nexport default {\r\n  async fetch(request, env) {\r\n    const url = new URL(request.url);\r\n    const path = url.pathname;\r\n    \r\n    // Handle preflight\r\n    if (request.method === 'OPTIONS') {\r\n      return new Response(null, { \r\n        status: 204, \r\n        headers: makeCorsHeaders() \r\n      });\r\n    }\r\n\r\n    // Handle auth endpoint (both /auth and /auth/login for compatibility)\r\n    if (path === '/auth' || path === '/auth/login') {\r\n      return handleAuth(url, env);\r\n    }\r\n\r\n    // Handle callback\r\n    if (path === '/callback') {\r\n      return handleCallback(url, env);\r\n    }\r\n\r\n    // Default response\r\n    return new Response('Decap CMS OAuth Proxy', { \r\n      headers: makeCorsHeaders() \r\n    });\r\n  }\r\n};"],
  "mappings": "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",
  "names": []
}
