---
/**
 * Shop Explorer Component
 * Interactive map and search for shop chests using Tradex API
 */
const BASE = (import.meta.env.BASE_URL ?? "/");
---

<div class="shop-explorer-container">
    <!-- Search Overlay -->
    <div class="search-panel">
        <div class="search-header">
            <div class="header-main">
                <h2 class="govuk-heading-m">Shop Explorer</h2>
                <button id="show-icenia-shops" class="icenia-quick-btn" title="Show all Icenia City shops">
                    <img src={BASE + "assets/images/icenia_logo.svg"} alt="Icenia" width="20" height="20">
                    View Icenia City Shops
                </button>
            </div>
        </div>
        
        <div class="search-controls">
            <div class="search-main-row">
                <div class="search-input-wrapper">
                    <input class="govuk-input" id="item-search" name="item-search" type="text" placeholder="I want to buy (e.g. diamond)">
                    <button id="toggle-options" class="options-toggle-btn" title="Toggle Search Options">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 21v-7M4 10V3M12 21v-9M12 8V3M20 21v-5M20 12V3M1 14h6M9 8h6M17 16h6"/>
                        </svg>
                    </button>
                    <button id="search-button" class="search-submit-btn" type="button">
                        <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 19L14.65 14.65M17 9C17 13.4183 13.4183 17 9 17C4.58172 17 1 13.4183 1 9C1 4.58172 4.58172 1 9 1C13.4183 1 17 4.58172 17 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="advanced-options-wrapper" class="advanced-options-wrapper scroll-container">
                <div id="advanced-options" class="advanced-grid">
                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="input-search">I want to pay with</label>
                        <input class="govuk-input govuk-input--small" id="input-search" name="input-search" type="text" placeholder="e.g. iron">
                    </div>

                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="sort-mode">Sort</label>
                        <select class="govuk-select" id="sort-mode" name="sort-mode">
                            <option value="closest">Closest</option>
                            <option value="cheapest" selected>Cheapest</option>
                            <option value="latest">Latest</option>
                            <option value="stock">In Stock</option>
                        </select>
                    </div>

                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="updated-after">Last Updated Within</label>
                        <select class="govuk-select" id="updated-after" name="updated-after">
                            <option value="0">Anytime</option>
                            <option value="86400000">24h</option>
                            <option value="604800000" selected>7d</option>
                            <option value="2592000000">30d</option>
                        </select>
                    </div>

                    <div class="enchantment-filter-container" style="grid-column: span 2;">
                        <label class="govuk-label govuk-label--s">Enchantment Filters</label>
                        <div id="enchantment-filters-list" class="enchant-filters-list">
                            <!-- Rows added via JS -->
                        </div>
                        <button type="button" id="add-enchant-filter" class="add-enchant-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Enchantment
                        </button>
                    </div>

                    <div class="govuk-checkboxes govuk-checkboxes--small side-by-side">
                        <div class="govuk-checkboxes__item">
                            <input class="govuk-checkboxes__input" id="allow-unstocked" name="allow-unstocked" type="checkbox">
                            <label class="govuk-label govuk-checkboxes__label" for="allow-unstocked">Unstocked</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                            <input class="govuk-checkboxes__input" id="icenia-only" name="icenia-only" type="checkbox">
                            <label class="govuk-label govuk-checkboxes__label" for="icenia-only">Icenia Only</label>
                        </div>
                    </div>
                </div>
                <div class="scroll-indicator" id="advanced-scroll-indicator">
                    <div class="scroll-track">
                        <div class="scroll-thumb"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p class="govuk-body-s">Searching Tradex...</p>
        </div>

        <!-- Results Container -->
        <div class="results-scroll-wrapper scroll-container">
            <div id="results-container" class="results-container">
                <div class="results-placeholder">
                    <p class="govuk-body-s">Enter an item name above to search shops across the world.</p>
                </div>
            </div>
            <div class="scroll-indicator" id="results-scroll-indicator">
                <div class="scroll-track">
                    <div class="scroll-thumb"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Tooltip -->
    <div id="item-tooltip" class="item-tooltip hidden"></div>

    <!-- Map Controls -->
    <div class="map-extra-controls">
        <button id="dark-mode-toggle" class="map-control-btn" title="Toggle Dark Mode">
            <svg class="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg class="moon-icon hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </button>
        <button id="center-icenia" class="map-control-btn" title="Center on Icenia City">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="8" fill="#3AB3DA" stroke="white" />
            </svg>
        </button>
        <button id="set-location" class="map-control-btn" title="Set My Location (Click on map)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                <circle cx="12" cy="10" r="3" />
            </svg>
        </button>
        <div class="zoom-group">
            <button id="zoom-in" class="map-control-btn" title="Zoom In">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
            <button id="zoom-out" class="map-control-btn" title="Zoom Out">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div id="shop-map" class="shop-map"></div>
    
    <!-- Map Info & Attribution -->
    <div class="map-info-container">
        <div id="info-panel" class="info-panel hidden scroll-container">
            <div class="info-content" id="info-content">
                <div class="info-section">
                    <h5>Controls</h5>
                    <p>üñ±Ô∏è Scroll to zoom</p>
                    <p>üñêÔ∏è Drag to pan</p>
                    <p>üìç Click markers for details</p>
                </div>
                <div class="info-cta-box">
                    <a href="https://modrinth.com/mod/tradex" target="_blank" class="modrinth-cta">
                        <div class="cta-title">üöÄ Install Tradex Mod</div>
                        <div class="cta-desc">Help keep the map updated! <br> Shopkeepers & Travellers wanted <br> for data logging.</div>
                    </a>
                </div>
                <div class="info-section">
                    <h5>Credits</h5>
                    <p>Backend: <a href="https://github.com/gjum/tradex" target="_blank">Tradex</a></p>
                    <p>Map: <a href="https://map.civinfo.net" target="_blank">CivInfo</a></p>
                    <p>Thanks Gjum for making Tradex and Civinfo.net! ‚ù§Ô∏è</p>
                </div>
                <div class="info-section">
                    <h5>Donations</h5>
                    <div class="donation-item">
                        <span>Creepily</span>
                        <code class="sortcode">HS-9363</code>
                    </div>
                    <div class="donation-item">
                        <span>Gjum</span>
                        <code class="sortcode">HS-3134</code>
                    </div>
                    <div class="donation-item">
                        <span>Icenia City</span>
                        <code class="sortcode">HS-1901</code>
                    </div>
                </div>
            </div>
            <div class="scroll-indicator" id="info-scroll-indicator">
                <div class="scroll-track">
                    <div class="scroll-thumb"></div>
                </div>
            </div>
        </div>
        <button id="info-toggle" class="map-control-btn info-btn" title="Map Info & Credits">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
        </button>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    .shop-explorer-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #121212;

        /* Minecraft Color Variables - Light Mode Defaults (High Contrast) */
        --mc-0: #000000;
        --mc-1: #0000AA;
        --mc-2: #00AA00;
        --mc-3: #00AAAA;
        --mc-4: #AA0000;
        --mc-5: #AA00AA;
        --mc-6: #D9A300;
        --mc-7: #777777;
        --mc-8: #555555;
        --mc-9: #0000FF;
        --mc-a: #008800;
        --mc-b: #008888;
        --mc-c: #CC0000;
        --mc-d: #AA00AA;
        --mc-e: #999900;
        --mc-f: #222222;
    }

    /* Search Panel */
    .search-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        bottom: 20px;
        width: 380px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        z-index: 1000;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: background 0.3s, border-color 0.3s, color 0.3s;
    }

    /* Dark Mode Styles */
    .shop-explorer-container.dark-mode {
        /* Minecraft Color Variables - Dark Mode Overrides (High Contrast) */
        --mc-0: #FFFFFF;
        --mc-1: #5555FF;
        --mc-2: #55FF55;
        --mc-3: #55FFFF;
        --mc-4: #FF5555;
        --mc-5: #FF55FF;
        --mc-6: #FFAA00;
        --mc-7: #AAAAAA;
        --mc-8: #CCCCCC;
        --mc-9: #5555FF;
        --mc-a: #55FF55;
        --mc-b: #55FFFF;
        --mc-c: #FF5555;
        --mc-d: #FF55FF;
        --mc-e: #FFFF55;
        --mc-f: #FFFFFF;
    }

    .shop-explorer-container.dark-mode .search-panel {
        background: rgba(24, 24, 24, 0.98);
        border-color: rgba(255, 255, 255, 0.08);
        color: #eee;
    }

    .shop-explorer-container.dark-mode .search-controls {
        background: #1a1a1a;
        border-bottom-color: #333;
    }

    .shop-explorer-container.dark-mode .advanced-grid {
        border-top-color: #333;
    }

    .shop-explorer-container.dark-mode .govuk-label {
        color: #aaa;
    }

    .shop-explorer-container.dark-mode .govuk-input,
    .shop-explorer-container.dark-mode .govuk-select {
        background: #262626;
        color: white;
        border-color: #444;
    }

    .shop-explorer-container.dark-mode .results-container {
        background: #121212;
    }

    .shop-explorer-container.dark-mode :global(.shop-result-card) {
        background: #1e1e1e !important;
        border-color: #333 !important;
        color: #eee !important;
    }

    .shop-explorer-container.dark-mode :global(.trade-display) {
        background: #262626 !important;
        border-color: #333 !important;
    }

    .shop-explorer-container.dark-mode :global(.item-label) {
        color: #bbb !important;
    }

    .shop-explorer-container.dark-mode :global(.item-icon-bg) {
        background: #1a1a1a !important;
    }

    .shop-explorer-container.dark-mode :global(.stack-count) {
        background: rgba(0, 0, 0, 0.6) !important;
        color: white !important;
        border-color: #444 !important;
    }

    :global(.count) {
        color: black;
    }
    .shop-explorer-container.dark-mode :global(.count) {
        color: white !important;
    }

    /* Compacted (ci) styling - High priority */
    :global(.stack-count.compacted),
    :global(.count.compacted) {
        color: #7b00ff !important;
        /* background: #000 !important; */
        /* border: 2px solid #FFD700 !important; */
        /* text-shadow: 0 0 4px rgba(0,0,0,0.8), 1px 1px 0px #000 !important; */
        font-weight: 900 !important;
        /* box-shadow: 0 2px 4px rgba(0,0,0,0.5) !important; */
        z-index: 10 !important;
    }

    .shop-explorer-container.dark-mode :global(.stack-count.compacted),
    .shop-explorer-container.dark-mode :global(.count.compacted) {
        color: #bb88ff !important;
    }

    /* Ensure yellow text in active cards */
    /* :global(.shop-result-card.active .stack-count.compacted) {
        color: #FFD700 !important;
    } */

    .shop-explorer-container.dark-mode :global(.result-meta) {
        color: #999 !important;
    }

    .shop-explorer-container.dark-mode :global(.freshness-badge) {
        border: 1px solid rgba(255,255,255,0.1);
    }

    .shop-explorer-container.dark-mode :global(.results-placeholder),
    .shop-explorer-container.dark-mode :global(.results-placeholder p),
    .shop-explorer-container.dark-mode :global(.results-placeholder strong),
    .shop-explorer-container.dark-mode :global(.results-placeholder li) {
        color: #b1b4b6 !important;
    }

    .shop-explorer-container.dark-mode :global(.no-results) {
        background: rgba(255, 255, 255, 0.03) !important;
        border-color: #333 !important;
    }

    .shop-explorer-container.dark-mode :global(.govuk-list) {
        color: #aaa !important;
    }

    .shop-explorer-container.dark-mode .map-control-btn {
        background: #141423;
        color: white;
        border: 1px solid #2d2d44;
    }

    .shop-explorer-container.dark-mode .map-control-btn:hover {
        background: #1c1c30;
    }

    .shop-explorer-container.dark-mode :global(.leaflet-popup-content-wrapper),
    .shop-explorer-container.dark-mode :global(.leaflet-popup-tip) {
        background: #141423 !important;
        color: white !important;
        border: 1px solid #2d2d44;
    }

    .shop-explorer-container.dark-mode :global(.shop-popup h3) {
        color: white;
        border-bottom-color: #333;
    }

    .shop-explorer-container.dark-mode :global(.exchange-row) {
        border-bottom-color: #333;
    }

    .shop-explorer-container.dark-mode :global(.exchange-output),
    .shop-explorer-container.dark-mode :global(.exchange-price) {
        background: #1a1a2e !important;
        color: #4da3ff !important;
        border: 1px solid rgba(77, 163, 255, 0.2) !important;
    }

    .search-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #1C70B8 0%, #003078 100%);
        color: white;
    }

    .header-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-header h2 {
        color: white;
        margin-bottom: 0;
        font-weight: 700;
        font-size: 18px;
    }

    .icenia-quick-btn {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .icenia-quick-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .icenia-quick-btn img {
        background: white;
        border-radius: 50%;
        padding: 2px;
        width: 22px;
        height: 22px;
        object-fit: contain;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
    }

    .search-controls {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e5e5;
        background: #fcfcfc;
        transition: background 0.3s, border-color 0.3s;
    }

    .search-main-row {
        margin-bottom: 12px;
    }

    .advanced-options-wrapper {
        display: flex;
        flex-direction: column;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                    opacity 0.3s ease,
                    padding 0.4s ease,
                    margin 0.4s ease;
        position: relative;
        padding-right: 10px;
        flex-shrink: 0;
    }

    @media (max-width: 768px) {
        .advanced-options-wrapper {
            max-height: 250px;
        }
    }

    .advanced-options-wrapper.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        margin-top: 0;
        pointer-events: none;
    }

    .advanced-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 12px 0;
        border-top: 1px solid #eee;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .advanced-grid::-webkit-scrollbar {
        display: none;
    }

    .advanced-grid.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        margin-top: 0;
        border-top-color: transparent;
        pointer-events: none;
    }

    .advanced-grid .govuk-form-group {
        margin-bottom: 4px;
    }

    .advanced-grid .govuk-label {
        font-size: 12px;
        margin-bottom: 2px;
    }

    .advanced-grid .govuk-input, .advanced-grid .govuk-select {
        font-size: 13px;
        padding: 4px;
        height: auto;
    }

    /* Checkbox Refinements - Fixed Vertical Alignment */
    .side-by-side {
        display: flex !important;
        flex-wrap: wrap;
        gap: 15px;
        grid-column: span 2;
        margin-top: 8px;
        padding-bottom: 4px;
        justify-content: flex-start;
    }

    .side-by-side .govuk-checkboxes__item {
        margin-bottom: 0 !important;
        min-height: 24px !important;
        display: flex !important;
        align-items: center !important;
        padding-left: 32px !important;
        position: relative !important;
    }

    .side-by-side .govuk-checkboxes__input {
        width: 24px !important;
        height: 24px !important;
        top: 0 !important;
        margin: 0 !important;
        left: 0 !important;
        z-index: 2 !important;
    }

    .side-by-side .govuk-checkboxes__label {
        padding: 0 !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        display: inline-block !important;
        line-height: 24px !important;
        margin: 0 !important;
    }

    .side-by-side .govuk-checkboxes__label::before {
        top: 0 !important;
        width: 24px !important;
        height: 24px !important;
        left: 0 !important;
    }

    .side-by-side .govuk-checkboxes__label::after {
        top: 10px !important;
        left: 7px !important;
        width: 9px !important;
        height: 4px !important;
        border-width: 0 0 3px 3px !important;
        transform: rotate(-45deg) !important;
    }

    /* Fix oversized hover indicator on checkboxes */
    .govuk-checkboxes__item:hover .govuk-checkboxes__input:not(:disabled) + .govuk-checkboxes__label::before {
        box-shadow: none !important;
    }

    /* Remove yellow focus borders from all elements */
    .shop-explorer-container *:focus,
    .shop-explorer-container *:focus-visible,
    .shop-explorer-container *:active {
        outline: none !important;
        box-shadow: none !important;
        -webkit-tap-highlight-color: transparent;
    }
    
    :global(.leaflet-container *:focus),
    :global(.leaflet-marker-icon:focus) {
        outline: none !important;
        box-shadow: none !important;
    }

    .govuk-checkboxes__input:focus + .govuk-checkboxes__label::before {
        box-shadow: none !important;
    }

    .search-input-wrapper {
        display: flex;
        gap: 6px;
    }

    .options-toggle-btn {
        background: #f3f2f1;
        color: #505a5f;
        border: 1px solid #d5d8da;
        border-radius: 6px;
        padding: 0 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .shop-explorer-container.dark-mode .options-toggle-btn {
        background: #262626;
        color: #aaa;
        border-color: #444;
    }

    .options-toggle-btn:hover, .options-toggle-btn.active {
        background: #1C70B8;
        color: white;
        border-color: #1C70B8;
    }

    .search-submit-btn {
        background: #1C70B8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .search-submit-btn:hover {
        background: #003078;
        transform: scale(1.05);
    }

    /* Item Tooltip */
    .item-tooltip {
        position: fixed;
        z-index: 10000;
        background: rgba(245, 245, 250, 0.96);
        color: #111;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 15px;
        pointer-events: none;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        border: 2px solid rgba(0, 0, 0, 0.1);
        max-width: 350px;
        line-height: 1.4;
        white-space: pre-wrap;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: opacity 0.15s ease;
        font-family: "Minecraft", monospace/*, "Segoe UI", "Roboto", Helvetica, Arial, sans-serif*/;
        font-weight: 600;
    }

    .shop-explorer-container.dark-mode .item-tooltip {
        background: rgba(20, 20, 30, 0.96);
        color: #eee;
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
    }

    /* Minecraft Formatting Colors - Theme Aware */
    :global(.mc-0) { color: var(--mc-0); }
    :global(.mc-1) { color: var(--mc-1); }
    :global(.mc-2) { color: var(--mc-2); }
    :global(.mc-3) { color: var(--mc-3); }
    :global(.mc-4) { color: var(--mc-4); }
    :global(.mc-5) { color: var(--mc-5); }
    :global(.mc-6) { color: var(--mc-6); }
    :global(.mc-7) { color: var(--mc-7); }
    :global(.mc-8) { color: var(--mc-8); }
    :global(.mc-9) { color: var(--mc-9); }
    :global(.mc-a) { color: var(--mc-a); }
    :global(.mc-b) { color: var(--mc-b); }
    :global(.mc-c) { color: var(--mc-c); }
    :global(.mc-d) { color: var(--mc-d); }
    :global(.mc-e) { color: var(--mc-e); }
    :global(.mc-f) { color: var(--mc-f); }
    
    :global(.mc-l) { font-weight: 900; }
    :global(.mc-m) { text-decoration: line-through; }
    :global(.mc-n) { text-decoration: underline; }
    :global(.mc-o) { font-style: italic; }
    :global(.mc-k) { 
        display: inline-block;
        filter: blur(1px);
        user-select: none;
        animation: mc-obfuscated 0.15s infinite; 
    }

    @keyframes mc-obfuscated {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .item-tooltip.hidden {
        display: none;
        opacity: 0;
    }

    :global(.lore-indicator) {
        position: absolute;
        top: -2px;
        left: -2px;
        width: 10px;
        height: 10px;
        background: #00d4ff;
        border-radius: 50%;
        box-shadow: 0 0 12px rgba(0, 212, 255, 1), inset 0 0 4px white;
        z-index: 10;
        border: 2px solid white;
    }

    /* Enchantment Filter Styles */
    .enchantment-filter-container {
        margin-top: 4px;
        padding-top: 8px;
        border-top: 1px solid #eee;
    }

    .shop-explorer-container.dark-mode .enchantment-filter-container {
        border-top-color: #333;
    }

    .enchant-filters-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 8px;
    }

    :global(.enchant-filter-row) {
        display: flex;
        gap: 6px;
        align-items: center;
        animation: slideIn 0.2s ease-out;
    }

    :global(.enchant-name-select) {
        flex: 1;
        font-size: 12px !important;
        padding: 4px !important;
        height: 30px !important;
    }

    :global(.enchant-level-input) {
        width: 55px !important;
        font-size: 12px !important;
        padding: 4px !important;
        height: 30px !important;
        text-align: center;
    }

    :global(.remove-enchant-btn) {
        background: #f3f2f1;
        color: #d4351c;
        border: 1px solid #d5d8da;
        border-radius: 4px;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.2s;
    }

    .shop-explorer-container.dark-mode :global(.remove-enchant-btn) {
        background: #262626;
        border-color: #444;
    }

    :global(.remove-enchant-btn:hover) {
        background: #d4351c;
        color: white;
        border-color: #d4351c;
    }

    .add-enchant-btn {
        background: transparent;
        color: #1C70B8;
        border: 1px dashed #1C70B8;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        justify-content: center;
        transition: all 0.2s;
    }

    .add-enchant-btn:hover {
        background: rgba(28, 112, 184, 0.05);
        border-style: solid;
    }

    .shop-explorer-container.dark-mode .add-enchant-btn {
        color: #4da3ff;
        border-color: #4da3ff;
    }

    /* Results Container */
    .results-scroll-wrapper {
        flex: 1;
        min-height: 0;
        position: relative;
        display: flex;
        flex-direction: column;
        padding-right: 10px;
        background: #f3f2f1;
    }

    .shop-explorer-container.dark-mode .results-scroll-wrapper {
        background: #121212;
    }

    .results-container {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .results-container::-webkit-scrollbar {
        display: none;
    }

    /* Elegant Scroll Indicator Styles */
    .scroll-container {
        position: relative;
    }

    .scroll-indicator {
        position: absolute;
        width: 4px;
        height: calc(100% - 20px);
        right: 4px;
        top: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
        pointer-events: none;
    }

    .scroll-container:hover .scroll-indicator,
    .scroll-indicator.visible,
    #info-panel .scroll-indicator {
        opacity: 1 !important;
    }

    .scroll-track {
        height: 100%;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 2px;
        position: relative;
        overflow: hidden;
    }

    .shop-explorer-container.dark-mode .scroll-track {
        background: rgba(255, 255, 255, 0.05);
    }

    .scroll-thumb {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 30%;
        background: rgba(28, 112, 184, 0.4);
        border-radius: 2px;
        transition: top 0.1s ease-out;
    }

    .shop-explorer-container.dark-mode .scroll-thumb {
        background: rgba(77, 163, 255, 0.4);
    }

    .scroll-thumb::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 2px;
        animation: scrollGlow 2s ease-in-out infinite;
    }

    @keyframes scrollGlow {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.8; }
    }

    .scroll-indicator.at-bottom .scroll-thumb::after {
        animation: none;
        opacity: 0.1;
    }

    :global(.results-placeholder) {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #505a5f;
        text-align: center;
        padding: 40px;
        transition: all 0.3s;
    }

    :global(.no-results) {
        background: rgba(0, 0, 0, 0.02);
        border-radius: 16px;
        margin: 10px;
        border: 2px dashed rgba(0, 0, 0, 0.05);
        font-style: normal !important;
    }

    :global(.warning-icon) {
        font-size: 40px;
        margin-bottom: 12px;
        filter: grayscale(0.5);
    }

    :global(.no-results p) {
        margin-bottom: 16px;
    }

    :global(.no-results ul) {
        text-align: left;
        display: inline-block;
        margin: 0 auto;
    }

    :global(.shop-result-card) {
        background: white !important;
        border: 1px solid #d5d8da !important;
        border-radius: 12px !important;
        padding: 12px !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
        animation: slideIn 0.3s ease-out forwards !important;
        position: relative !important;
        overflow: visible !important;
        min-height: 110px !important;
        flex-shrink: 0 !important;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    :global(.shop-result-card:hover) {
        border-color: #1C70B8 !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
        transform: translateY(-2px) !important;
    }

    :global(.shop-result-card.active) {
        border: 2px solid #1C70B8 !important;
        background: #f0f7ff !important;
        box-shadow: 0 4px 12px rgba(28, 112, 184, 0.15) !important;
    }

    :global(.trade-display) {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 8px !important;
        background: #f8f9fa !important;
        padding: 10px !important;
        border-radius: 10px !important;
        border: 1px solid #eee !important;
        min-height: 70px !important;
    }

    :global(.item-stack) {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 4px !important;
        flex: 1 !important;
        min-width: 0 !important;
    }

    :global(.item-icon-bg) {
        width: 52px !important;
        height: 52px !important;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        position: relative;
        cursor: help;
        overflow: visible;
    }

    :global(.item-icon-bg.small) {
        width: 32px !important;
        height: 32px !important;
        border-radius: 6px;
    }

    :global(.item-icon) {
        width: 36px !important;
        height: 36px !important;
        image-rendering: pixelated;
    }

    :global(.stack-count) {
        font-size: 12px;
        font-weight: 900;
        color: black;
        background: #ffffffc1; /* Icenian Blue */
        padding: 2px 6px;
        border-radius: 6px;
        position: absolute;
        bottom: -4px;
        right: -4px;
        border: 2px solid gray;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 2;
    }

    .shop-explorer-container.dark-mode :global(.stack-count) {
        border-color: #1e1e1e;
    }

    :global(.trade-arrow) {
        font-size: 18px;
        color: #999;
        font-weight: bold;
    }

    :global(.item-label) {
        font-size: 11px;
        font-weight: 600;
        color: #555;
        text-align: center;
        width: 100%;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.2;
        height: 2.4em;
        word-break: break-word;
    }


    :global(.result-meta) {
        font-size: 11px;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 4px;
    }

    .stock-badge {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
    }

    .stock-high { background: #cce2d8; color: #005a30; }
    .stock-low { background: #fff7bf; color: #594d00; }
    .stock-none { background: #f6d7d2; color: #942514; }

    :global(.freshness-badge) {
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
    }
    :global(.fresh-green) { background: #00703c; color: white; }
    :global(.fresh-yellow) { background: #ffdd00; color: #0b0c0c; }
    :global(.fresh-red) { background: #d4351c; color: white; }

    /* Map Controls */
    .map-extra-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .map-control-btn {
        width: 44px;
        height: 44px;
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .map-control-btn:hover {
        background: #f3f2f1;
        transform: scale(1.05);
    }

    .map-control-btn.active {
        background: #1C70B8;
        color: white;
    }

    .zoom-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
        background: rgba(0,0,0,0.1);
        padding: 2px;
        border-radius: 10px;
    }

    .shop-explorer-container.dark-mode .zoom-group {
        background: rgba(255,255,255,0.05);
    }

    .zoom-group .map-control-btn {
        box-shadow: none;
    }

    .zoom-group .map-control-btn:first-child {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }

    .zoom-group .map-control-btn:last-child {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }

    /* Map Info Container */
    .map-info-container {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
    }

    .info-panel {
        width: 480px;
        max-height: 400px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: bottom right;
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
        display: flex;
        flex-direction: column;
    }

    .info-content {
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    /* Ensure CTA box is on the right of the first section on PC */
    .info-content > *:nth-child(1) { grid-area: auto; }
    .info-content > *:nth-child(2) { grid-area: auto; }

    .info-content .info-cta-box {
        margin-top: 0;
        margin-bottom: 0;
    }

    .info-content::-webkit-scrollbar {
        display: none;
    }

    .shop-explorer-container.dark-mode .info-panel {
        background: rgba(24, 24, 35, 0.95);
        border-color: rgba(255, 255, 255, 0.1);
        color: #eee;
    }

    .info-panel.hidden {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
        pointer-events: none;
    }


    .info-section h5 {
        margin: 0 0 8px 0;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #666;
        font-weight: 700;
    }

    .shop-explorer-container.dark-mode .info-section h5 {
        color: #999;
    }

    .info-section p {
        margin: 4px 0;
        font-size: 13px;
        line-height: 1.4;
    }

    .info-section a {
        color: #1C70B8;
        text-decoration: none;
        font-weight: 600;
    }

    .info-section a:hover {
        text-decoration: underline;
    }

    .info-section code {
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        color: #d4351c;
    }

    .shop-explorer-container.dark-mode .info-section code {
        background: rgba(255, 255, 255, 0.1);
        color: #ff6b6b;
    }

    .info-cta-box {
        margin-top: 4px;
    }

    .modrinth-cta {
        display: block;
        background: #1bd96a;
        color: #111 !important;
        text-align: center;
        padding: 12px 8px;
        border-radius: 12px;
        text-decoration: none !important;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 0 #14a350;
        margin-top: 8px;
    }

    .modrinth-cta:hover {
        background: #22e577;
        transform: translateY(-2px);
        box-shadow: 0 6px 0 #14a350;
    }

    .modrinth-cta:active {
        transform: translateY(1px);
        box-shadow: 0 2px 0 #14a350;
    }

    .cta-title {
        font-weight: 800;
        font-size: 14px;
        margin-bottom: 4px;
    }

    .cta-desc {
        font-size: 11px;
        font-weight: 600;
        line-height: 1.3;
        opacity: 0.9;
    }

    .info-btn {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        background: #1C70B8 !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(28, 112, 184, 0.4) !important;
    }

    .info-btn:hover {
        transform: scale(1.1) !important;
    }

    @media (max-width: 768px) {
        .map-info-container {
            bottom: calc(50% + 10px);
            left: 10px;
            right: auto;
            align-items: flex-start;
            z-index: 1001;
        }
        .info-panel {
            width: 220px;
            transform-origin: bottom left;
            max-height: 300px;
            overflow-y: auto;
        }
        .info-content {
            grid-template-columns: 1fr;
        }
        .advanced-grid.hidden-mobile {
            display: none;
        }
        .search-panel {
            height: 50% !important;
            bottom: 0 !important;
            left: 0 !important;
            width: 100% !important;
            border-radius: 16px 16px 0 0 !important;
            top: auto !important;
        }
    }

    .donation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .donation-item span {
        font-size: 13px;
        color: #666;
        font-weight: 500;
    }

    .shop-explorer-container.dark-mode .donation-item span {
        color: #aaa;
    }

    .sortcode {
        font-weight: 800;
        font-size: 13px;
        letter-spacing: 0.05em;
        background: #fff;
        padding: 3px 8px;
        border-radius: 6px;
        color: #d4351c;
        border: 1px solid rgba(212, 53, 28, 0.3);
        font-family: monospace;
        box-shadow: 0 2px 4px rgba(212, 53, 28, 0.1);
    }

    .shop-explorer-container.dark-mode .sortcode {
        background: #1a1a1a;
        color: #ff6b6b;
        border-color: rgba(255, 107, 107, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Map */
    .shop-map {
        width: 100%;
        height: 100%;
        background: #1a1a2e;
    }

    /* Fix blurriness on extreme zoom - keep pixels sharp */
    :global(.leaflet-tile) {
        image-rendering: pixelated !important;
        image-rendering: crisp-edges !important;
        -ms-interpolation-mode: nearest-neighbor;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1100;
        transition: background 0.3s, color 0.3s;
    }

    .shop-explorer-container.dark-mode .loading-overlay {
        background: rgba(18, 18, 18, 0.9);
        color: white;
    }

    .shop-explorer-container.dark-mode .loading-overlay p {
        color: white !important;
    }

    .hidden {
        display: none;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1C70B8;
        border-radius: 50%;
        animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* User Location Radar */
    :global(.user-location-radar) {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        pointer-events: none;
        width: 0 !important;
        height: 0 !important;
    }
    :global(.radar-dot) {
        position: absolute;
        width: 16px;
        height: 16px;
        background: #ff3e00;
        border: 2px solid white;
        border-radius: 50%;
        z-index: 2;
        box-shadow: 0 0 15px rgba(255, 62, 0, 0.8);
    }
    :global(.radar-ring) {
        position: absolute;
        width: 16px;
        height: 16px;
        background: rgba(255, 62, 0, 0.6);
        border-radius: 50%;
        animation: radar-pulse 1.5s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
        z-index: 1;
    }
    @keyframes radar-pulse {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(5); opacity: 0; }
    }

    /* Shop Pointer Markers */
    :global(.shop-pointer-marker) {
        will-change: transform;
        z-index: 500;
    }
    :global(.pointer-inner) {
        position: absolute;
        left: 16px;
        top: 12px;
        width: 20px;
        height: 20px;
        background: #1C70B8;
        border: 2px solid white;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        transform-origin: bottom left; /* Keep the tip fixed during scaling */
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        will-change: transform;
    }
    :global(.pointer-inner::after) {
        content: '';
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
    }
    :global(.shop-pointer-marker:hover .pointer-inner) {
        background: #FFD700;
        transform: rotate(-45deg) scale(1.3);
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
    }

    /* Ping Animation for selected results */
    :global(.ping-animation) {
        z-index: 1000 !important;
    }
    :global(.ping-animation .pointer-inner) {
        background: #FFD700 !important;
        transform: rotate(-45deg) scale(1.2);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }
    :global(.ping-animation .pointer-inner::before) {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 50% 50% 50% 0;
        border: 2px solid #FFD700;
        animation: marker-ping 1.5s infinite;
        pointer-events: none;
    }
    @keyframes marker-ping {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(3); opacity: 0; }
    }

    /* Popup Styling - Fixed Overflow and Width */
    :global(.shop-popup) {
        min-width: 350px;
        width: max-content;
        max-width: 550px;
        font-family: "nta", Arial, sans-serif;
        overflow: visible !important;
    }

    :global(.leaflet-popup-content-wrapper) {
        width: max-content !important;
        min-width: 380px;
        max-width: 600px;
        overflow: visible !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
        border-radius: 12px !important;
    }

    :global(.leaflet-popup-content) {
        width: auto !important;
        margin: 12px 16px !important;
        max-width: none !important;
        overflow: visible !important;
    }

    :global(.leaflet-popup) {
        overflow: visible !important;
    }

    :global(.shop-popup h3) {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 700;
        border-bottom: 2px solid #f3f2f1;
        padding-bottom: 8px;
        color: #0b0c0c;
    }

    :global(.exchanges-list) {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: visible;
        padding: 4px;
        margin: -4px;
    }

    :global(.exchange-row) {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 4px;
        font-size: 13px;
        border-bottom: 1px solid #f3f2f1;
        gap: 8px;
    }

    :global(.exchange-row:last-child) {
        border-bottom: none;
    }

    :global(.exchange-item-bundle) {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
        overflow: visible;
    }

    :global(.exchange-item-bundle.output) {
        justify-content: flex-end;
        text-align: right;
    }

    :global(.popup-item-icon) {
        width: 22px;
        height: 22px;
        image-rendering: pixelated;
        flex-shrink: 0;
    }

    :global(.exchange-price), :global(.exchange-output) {
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        padding: 2px 8px !important;
        border-radius: 8px !important;
        line-height: 1 !important;
        min-width: 0 !important;
        max-width: 100% !important;
    }

    :global(.exchange-price), :global(.exchange-output) {
        font-weight: 700;
        color: #1C70B8;
        background: #f0f7ff;
        border: 1px solid rgba(28, 112, 184, 0.1);
    }

    :global(.exchange-price .count), :global(.exchange-output .count) {
        white-space: nowrap;
        font-weight: 800;
        opacity: 0.9;
        position: relative;
        top: -1px; /* Fix slight downward shift */
    }

    :global(.exchange-price .name), :global(.exchange-output .name) {
        word-break: normal;
        overflow: visible;
        white-space: nowrap;
        display: inline-block;
        max-width: none;
    }


    :global(.exchange-arrow) {
        color: #999;
        font-weight: bold;
        margin: 0 4px;
    }

    @media (max-width: 768px) {
        .search-panel {
            width: calc(100% - 20px);
            height: 40%;
            top: auto;
            left: 10px;
            bottom: 10px;
        }
        
        .map-extra-controls {
            top: 10px;
            right: 10px;
        }

        .side-by-side {
            gap: 10px;
        }
        
        :global(.shop-popup) {
            min-width: 260px;
        }
        :global(.exchange-price .name), :global(.exchange-output .name) {
            white-space: normal;
            max-width: 100px;
        }
    }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script is:inline define:vars={{ BASE }}>
    // --- Configuration ---
    const MC_VERSION = '1.21.8';
</script>

<script>
    import { ITEM_MAPPINGS } from '../../data/item-mappings';
    
    // Expose to window for the inline script
    (window as any).ITEM_MAPPINGS = {
        ...ITEM_MAPPINGS,
        water: 'water_bucket',
        // Add more entries here as needed, e.g.,
        // lava: 'lava_bucket',
    };
    
</script>

<script is:inline define:vars={{ BASE }}>
    /**
     * Item Mapping System
     * Use this to map Tradex material IDs to specific filenames on mc.nerothe.com
     */

    /**
     * Legacy Fallback Overrides
     * Used for PrismarineJS assets when Nerothe fails
     */
    const ICON_OVERRIDES = {
        'barrel': 'blocks/barrel_side.png',
        'reinforced_deepslate': 'blocks/reinforced_deepslate_top.png',
        'beehive': 'blocks/beehive_front.png',
        'bee_nest': 'blocks/bee_nest_front.png',
        'blast_furnace': 'blocks/blast_furnace_front.png',
        'furnace': 'blocks/furnace_front.png',
        'smoker': 'blocks/smoker_front.png',
        'dispenser': 'blocks/dispenser_front.png',
        'dropper': 'blocks/dropper_front.png',
        'observer': 'blocks/observer_front.png',
        'crafter': 'blocks/crafter_top.png'
    };

    /**
     * Get Primary Icon URL (Nerothe)
     */
    window.getItemIconUrl = function(material) {
        if (!material) return '';
        let mat = material.toLowerCase().replace(/ /g, '_').replace(/minecraft:/, '');
        
        // Use mappings from window.ITEM_MAPPINGS if available (runtime lookup)
        if (window.ITEM_MAPPINGS && window.ITEM_MAPPINGS[mat]) {
            mat = window.ITEM_MAPPINGS[mat];
        }

        return `https://mc.nerothe.com/img/1.21.8/minecraft_${mat}.png`;
    };

    /**
     * Get Fallback Icon URL (PrismarineJS)
     */
    window.getFallbackIconUrl = function(material) {
        if (!material) return '';
        let mat = material.toLowerCase().replace(/ /g, '_').replace(/minecraft:/, '');
        
        // Use mappings from window.ITEM_MAPPINGS if available (runtime lookup)
        if (window.ITEM_MAPPINGS && window.ITEM_MAPPINGS[mat]) {
            mat = window.ITEM_MAPPINGS[mat];
        }

        if (ICON_OVERRIDES[mat]) {
            return `https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/${MC_VERSION}/${ICON_OVERRIDES[mat]}`;
        }
        return `https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/${MC_VERSION}/items/${mat}.png`;
    };

    document.addEventListener('DOMContentLoaded', () => {
        // --- Map Initialization ---
        const map = L.map('shop-map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 6,
            zoomSnap: 0.1,
            attributionControl: false,
            zoomControl: false,
            preferCanvas: true,
            wheelPxPerZoomLevel: 120, // Smoother scroll zoom
            bounceAtZoomLimits: false
        });

        const ICENIA_CITY_COORDS = [4380, -3850]; 

        function flyToWithOffset(latlng, zoom, options = {}) {
            const isMobile = window.innerWidth <= 768;
            const point = map.project(latlng, zoom);
            let offsetPoint;
            if (isMobile) {
                offsetPoint = point.add([0, window.innerHeight * 0.14]);
            } else {
                // Shift map right by 190px to center visually (accounting for search panel)
                offsetPoint = point.subtract([190, 0]);
            }
            const offsetLatLng = map.unproject(offsetPoint, zoom);
            map.flyTo(offsetLatLng, zoom, { 
                duration: 0.6,
                easeLinearity: 0.25,
                noMoveStart: true,
                ...options 
            });
        }

        // Override zoom methods to maintain visual center
        const originalZoomIn = map.zoomIn.bind(map);
        const originalZoomOut = map.zoomOut.bind(map);

        map.zoomIn = function(delta, options) {
            const center = map.getCenter();
            const zoom = map.getZoom() + (delta || 1);
            flyToWithOffset(center, zoom, options);
            return this;
        };

        map.zoomOut = function(delta, options) {
            const center = map.getCenter();
            const zoom = map.getZoom() - (delta || 1);
            flyToWithOffset(center, zoom, options);
            return this;
        };

        const initialPoint = map.project(ICENIA_CITY_COORDS, 0);
        const isMobileInitial = window.innerWidth <= 768;
        const initialOffsetPoint = isMobileInitial 
            ? initialPoint.add([0, window.innerHeight * 0.14]) 
            : initialPoint.subtract([190, 0]);
        map.setView(map.unproject(initialOffsetPoint, 0), 0);

        const localTiles = BASE + 'tiles/terrain/z{z}/{x},{y}.png';
        const primaryTiles = 'https://civmc-map.duckdns.org/tiles/terrain/z{z}/{x},{y}.png';
        const fallbackTiles = 'https://civmc-map.github.io/tiles/terrain/z{z}/{x},{y}.png';

        // Multi-tier tile loading strategy
        const tiles = L.tileLayer(localTiles, {
            minZoom: -5,
            maxZoom: 6,
            maxNativeZoom: 0,
            minNativeZoom: -5,
            tileSize: 256,
            noWrap: true,
            updateWhenIdle: true,
            updateWhenZooming: false,
            keepBuffer: 2
        }).addTo(map);

        tiles.on('tileerror', function(error) {
            if (this._url === localTiles) {
                console.log('Local tiles not found, trying primary server...');
                this.setUrl(primaryTiles);
            } else if (this._url === primaryTiles) {
                console.warn('Primary tile server failed, switching to fallback');
                this.setUrl(fallbackTiles);
            }
        });

        // --- Configuration ---
        // Change this value to adjust how close the map zooms when clicking a result (higher = closer)
        const DEFAULT_CLICK_ZOOM = 3;

        // --- State ---
        let markers = [];
        let userLocation = null;
        let userMarker = null;
        let activeMarker = null;
        let activeCard = null;
        let isSettingLocation = false;
        let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const markerGroup = L.layerGroup().addTo(map);
        
        let lastExchanges = [];
        let lastQueryLabel = "";

        // --- UI Elements ---
        const searchInput = document.getElementById('item-search');
        const searchButton = document.getElementById('search-button');
        const sortModeSelect = document.getElementById('sort-mode');
        const allowUnstockedCheckbox = document.getElementById('allow-unstocked');
        const iceniaOnlyCheckbox = document.getElementById('icenia-only');
        const resultsContainer = document.getElementById('results-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const centerIceniaBtn = document.getElementById('center-icenia');
        const setLocationBtn = document.getElementById('set-location');
        const darkModeToggle = document.getElementById('dark-mode-toggle');

        const ICENIA_CITY_BOUNDS = {
            minX: -4300,
            maxX: -3500,
            minZ: -4900,
            maxZ: -3900
        };

        function mcToLatLng(x, z) {
            // Center on the block by adding 0.5
            return [-(z + 0.5), x + 0.5];
        }

        function formatItemName(item) {
            const baseName = item.material.toLowerCase().replace(/minecraft:/, '').replace(/_/g, ' ');
            if (item.customName) {
                // Strip Minecraft color codes for the display name
                const cleanCustom = item.customName.replace(/¬ß[0-9a-fk-or]/g, '');
                return `${cleanCustom}<br>(${baseName})`;
            }
            return baseName;
        }

        function formatLoreText(item) {
            if (!item) return '';
            let parts = [];
            
            // Helper to format enchantment maps
            const formatEnchantMap = (map, color = '¬ß7') => {
                if (!map || Object.keys(map).length === 0) return [];
                return Object.entries(map).map(([name, level]) => {
                    const enchantName = name.replace('minecraft:', '').replace(/_/g, ' ');
                    const prettyName = enchantName.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    return `${color}${prettyName} ${level}`;
                });
            };

            // Prioritize Custom Name in lore if it exists
            if (item.customName) {
                parts.push(`¬ßb¬ßl${item.customName}`);
            }
            
            // Enchantments (on the item)
            if (item.enchants && Object.keys(item.enchants).length > 0) {
                parts.push(...formatEnchantMap(item.enchants, '¬ß7'));
            }

            // Stored Enchantments (e.g. on Enchanted Books)
            if (item.storedEnchants && Object.keys(item.storedEnchants).length > 0) {
                parts.push('¬ße¬ßnStored Enchantments:');
                parts.push(...formatEnchantMap(item.storedEnchants, '¬ße'));
            }

            // Required Enchantments (Tradex specific)
            if (item.requiredEnchants && Object.keys(item.requiredEnchants).length > 0) {
                parts.push('¬ß9¬ßnRequired Enchantments:');
                parts.push(...formatEnchantMap(item.requiredEnchants, '¬ß9'));
            }

            // Excluded Enchantments (Tradex specific)
            if (item.excludedEnchants && item.excludedEnchants.length > 0) {
                parts.push('¬ßc¬ßnExcluded Enchantments:');
                item.excludedEnchants.forEach(e => {
                    const name = e.replace('minecraft:', '').replace(/_/g, ' ');
                    const prettyName = name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    parts.push(`¬ßc- ${prettyName}`);
                });
            }

            // Unlisted Enchants Allowed (Tradex specific) - Only show if there are required enchants
            const hasRequiredEnchants = item.requiredEnchants && Object.keys(item.requiredEnchants).length > 0;
            if (hasRequiredEnchants) {
                if (item.unlistedEnchantsAllowed === false) {
                    parts.push('¬ß8Unlisted Enchants: ¬ßa¬ßcForbidden');
                } else if (item.unlistedEnchantsAllowed === true) {
                    parts.push('¬ß8Unlisted Enchants: ¬ßaAllowed');
                }
            }

            // Durable items check
            const isDurable = /pickaxe|shovel|axe|hoe|shears|sword|bow|crossbow|trident|mace|helmet|chestplate|leggings|boots|elytra|shield|fishing_rod|flint_and_steel|carrot_on_a_stick|warped_fungus_on_a_stick|brush/.test(item.material.toLowerCase());

            // Condition (Tradex specific)
            if (item.condition !== undefined) {
                parts.push(`¬ß8Condition: ¬ßf¬ßo${item.condition}`);
            } else if (isDurable) {
                parts.push(`¬ß8Condition: ¬ßcNot Defined`);
            }

            // Repair Level (Tradex specific) - Only show for durable items
            const repairVal = item.repairLevel ?? item.repair;
            if (isDurable && repairVal !== undefined) {
                parts.push(`¬ß6Repair Level: ¬ß6¬ßo${repairVal}`);
            }

            // Lore lines
            if (item.lore) {
                const loreLines = Array.isArray(item.lore) ? item.lore : [String(item.lore)];
                // Avoid duplicating custom name if it's already in lore
                loreLines.forEach(line => {
                    if (item.customName && line.includes(item.customName)) return;
                    parts.push(`¬ßr${line}`);
                });
            }

            // Repair Cost
            if (item.repairCost > 0) {
                parts.push(`¬ß8Repair Cost: ¬ß7${item.repairCost}`);
            }

            return parts.join('\n').trim();
        }

        function renderMinecraftText(text) {
            if (!text) return '';
            
            const codes = {
                '0': 'mc-0', '1': 'mc-1', '2': 'mc-2', '3': 'mc-3',
                '4': 'mc-4', '5': 'mc-5', '6': 'mc-6', '7': 'mc-7',
                '8': 'mc-8', '9': 'mc-9', 'a': 'mc-a', 'b': 'mc-b',
                'c': 'mc-c', 'd': 'mc-d', 'e': 'mc-e', 'f': 'mc-f',
                'l': 'mc-l', 'm': 'mc-m', 'n': 'mc-n', 'o': 'mc-o',
                'k': 'mc-k', 'r': 'mc-r'
            };

            let html = '';
            let currentClasses = new Set();
            let i = 0;

            while (i < text.length) {
                if (text[i] === '¬ß' && i + 1 < text.length) {
                    const code = text[i + 1].toLowerCase();
                    if (codes[code]) {
                        if (code === 'r') {
                            currentClasses.clear();
                        } else if (['l', 'm', 'n', 'o', 'k'].includes(code)) {
                            currentClasses.add(codes[code]);
                        } else {
                            // In Minecraft, color codes reset all formatting codes
                            currentClasses.forEach(cls => {
                                if (['mc-l', 'mc-m', 'mc-n', 'mc-o', 'mc-k'].includes(cls)) {
                                    currentClasses.delete(cls);
                                }
                            });
                            // Also remove any previous color
                            currentClasses.forEach(cls => {
                                if (cls.startsWith('mc-') && !['l', 'm', 'n', 'o', 'k', 'r'].includes(cls.slice(3))) {
                                    currentClasses.delete(cls);
                                }
                            });
                            currentClasses.add(codes[code]);
                        }
                        i += 2;
                        continue;
                    }
                }

                if (text[i] === '\n') {
                    html += '<br>';
                } else {
                    const char = text[i];
                    if (currentClasses.size > 0) {
                        // For obfuscated text, we replace the character with a random one
                        if (currentClasses.has('mc-k')) {
                            html += `<span class="${Array.from(currentClasses).join(' ')}">?</span>`;
                        } else {
                            html += `<span class="${Array.from(currentClasses).join(' ')}">${char}</span>`;
                        }
                    } else {
                        html += char;
                    }
                }
                i++;
            }
            return html;
        }

        function formatCount(count, item) {
            let loreText = '';
            if (item && item.lore) {
                loreText = Array.isArray(item.lore) ? item.lore.join(' ') : String(item.lore);
            }
            
            const loreCompacted = (loreText.toLowerCase().includes('compacted')) ||
                                 (item && item.material && item.material.toLowerCase().includes('compacted'));
            
            if (loreCompacted) {
                return { text: `${count}ci`, isCompacted: true };
            }
            
            if (count > 0 && count % 64 === 0) {
                return { text: `${count / 64}ci`, isCompacted: true };
            }
            
            return { text: `${count}x`, isCompacted: false };
        }

        const ENCHANTMENTS = [
            "Mending", "Unbreaking", "Efficiency", "Silk Touch", "Fortune",
            "Protection", "Fire Protection", "Blast Protection", "Projectile Protection",
            "Sharpness", "Smite", "Bane of Arthropods", "Knockback", "Fire Aspect", "Looting",
            "Power", "Punch", "Flame", "Infinity", "Luck of the Sea", "Lure",
            "Depth Strider", "Frost Walker", "Respiration", "Aqua Affinity", "Thorns",
            "Sweeping Edge", "Efficiency", "Silk Touch", "Fortune",
            "Quick Charge", "Multishot", "Piercing", "Loyalty", "Impaling", "Riptide", "Channeling"
        ].sort();

        function createEnchantFilterRow() {
            const row = document.createElement('div');
            row.className = 'enchant-filter-row';
            
            let options = '<option value="">Any Enchantment</option>';
            ENCHANTMENTS.forEach(e => {
                options += `<option value="${e.toLowerCase().replace(/ /g, '_')}">${e}</option>`;
            });

            row.innerHTML = `
                <select class="govuk-select enchant-name-select">
                    ${options}
                </select>
                <input class="govuk-input enchant-level-input" type="number" placeholder="Lvl" min="1" max="10">
                <button type="button" class="remove-enchant-btn" title="Remove filter">√ó</button>
            `;

            row.querySelector('.enchant-name-select').addEventListener('change', () => applyFiltersAndDisplay());
            row.querySelector('.enchant-level-input').addEventListener('input', () => applyFiltersAndDisplay());
            row.querySelector('.remove-enchant-btn').addEventListener('click', () => {
                row.remove();
                applyFiltersAndDisplay();
            });

            return row;
        }

        document.getElementById('add-enchant-filter').addEventListener('click', () => {
            document.getElementById('enchantment-filters-list').appendChild(createEnchantFilterRow());
        });

        async function performSearch(isIceniaOnly = false) {
            const outputQuery = searchInput.value.trim();
            const inputQuery = document.getElementById('input-search').value.trim();
            const updatedAfterSelect = document.getElementById('updated-after');
            
            // If isIceniaOnly is true (from button), we force the checkbox and fetch
            if (isIceniaOnly) {
                iceniaOnlyCheckbox.checked = true;
            }
            
            const limit = isIceniaOnly ? 1000 : 100;
            
            if (!outputQuery && !inputQuery && !isIceniaOnly) return;

            loadingOverlay.classList.remove('hidden');
            
            try {
                const searchParams = {
                    limit: limit,
                    allowUnstocked: isIceniaOnly ? true : allowUnstockedCheckbox.checked,
                    sortMode: isIceniaOnly ? 'closest' : sortModeSelect.value
                };

                // Search Bypass Logic: If searching for custom items known to be barrels or player heads, search for the base material
                let apiOutputQuery = outputQuery;
                const lowerOutputQuery = outputQuery.toLowerCase();
                if (lowerOutputQuery.includes('repair kit') || lowerOutputQuery.includes('dropbox') || lowerOutputQuery.includes('compactor') || lowerOutputQuery.includes('smelter')) {
                    apiOutputQuery = 'barrel';
                } else if (lowerOutputQuery.includes('head')) {
                    apiOutputQuery = 'player_head';
                } else if (lowerOutputQuery.includes('essence')) {
                    apiOutputQuery = 'eye_of_ender';
                }

                let apiInputQuery = inputQuery;
                const lowerInputQuery = inputQuery.toLowerCase();
                if (lowerInputQuery.includes('repair kit') || lowerInputQuery.includes('dropbox') || lowerInputQuery.includes('compactor') || lowerInputQuery.includes('smelter')) {
                    apiInputQuery = 'barrel';
                } else if (lowerInputQuery.includes('head')) {
                    apiInputQuery = 'player_head';
                } else if (lowerInputQuery.includes('essence')) {
                    apiInputQuery = 'eye_of_ender';
                }

                if (apiOutputQuery) searchParams.output = apiOutputQuery;
                if (apiInputQuery) searchParams.input = apiInputQuery;
                
                const updatedAfterMs = parseInt(updatedAfterSelect.value);
                if (updatedAfterMs > 0) {
                    searchParams.updatedAfter = Date.now() - updatedAfterMs;
                }

                if (sortModeSelect.value === 'closest' || isIceniaOnly) {
                    const pos = userLocation || { x: -3900, z: -4400 };
                    searchParams.pos = {
                        x: Math.round(pos.x),
                        y: 64,
                        z: Math.round(pos.z),
                        world: "overworld"
                    };
                }

                const TARGET_URL = 'https://api.tradex.civinfo.net/exchanges/search';
                
                // List of proxies to try in order. 
                // We include the self-hosted worker as the first backup for speed and reliability.
                const PROXIES = [
                    { name: 'Direct API', url: TARGET_URL },
                    { name: 'AllOrigins (Raw)', url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent(TARGET_URL) },
                    { name: 'YaCDN', url: 'https://yacdn.org/proxy/' + TARGET_URL },
                    { name: 'HTMLDriven', url: 'https://cors-anywhere.htmldriven.com/?url=' + TARGET_URL },
                    { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(TARGET_URL) },
                    { name: 'CORSProxy.io', url: 'https://corsproxy.io/?' + encodeURIComponent(TARGET_URL) },
                    { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' + TARGET_URL },
                    { name: 'AllOrigins (JSON)', url: 'https://api.allorigins.win/get?url=' + encodeURIComponent(TARGET_URL) },
                    { name: 'CORS Bridged', url: 'https://cors.bridged.cc/' + TARGET_URL }
                ];
                
                async function tryFetch(proxy, attemptIndex) {
                    console.log(`Attempting search via ${proxy.name}...`);
                    const isAllOriginsJson = proxy.url.includes('allorigins.win/get');
                    
                    const controller = new AbortController();
                    // Use shorter timeout for first few attempts to speed up fallback, 
                    // but keep 8s for later ones as Tradex can be slow.
                    const timeoutMs = attemptIndex < 2 ? 5000 : 8000;
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                    try {
                        const res = await fetch(proxy.url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(searchParams),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!res.ok) throw new Error(`${proxy.name} returned status ${res.status}`);
                        
                        const text = await res.text();
                        
                        try {
                            let json = JSON.parse(text);
                            // AllOrigins /get wraps the response in a JSON object with a 'contents' field
                            if (isAllOriginsJson && json.contents) {
                                json = JSON.parse(json.contents);
                            }
                            
                            if (json && (json.exchanges || Array.isArray(json))) {
                                return json;
                            }
                            throw new Error('Invalid JSON structure');
                        } catch (e) {
                            throw new Error(`${proxy.name} response was not valid JSON`);
                        }
                    } catch (e) {
                        clearTimeout(timeoutId);
                        throw e;
                    }
                }

                let data = null;
                let lastError = null;

                for (let i = 0; i < PROXIES.length; i++) {
                    const proxy = PROXIES[i];
                    try {
                        data = await tryFetch(proxy, i);
                        if (data) break;
                    } catch (e) {
                        console.warn(`${proxy.name} failed:`, e.message);
                        lastError = e;
                        continue; // Try next proxy
                    }
                }

                if (!data) {
                    console.error('All search methods failed');
                    throw new Error(lastError ? `Search failed: ${lastError.message}` : 'Search failed. All proxies are currently unavailable.');
                }
                let exchanges = data.exchanges || [];

                // Client-side filtering for better accuracy (Fixes "golden carrot" issue and supports custom names/lore)
                // Uses a multi-word match: all words in the query must appear in the item's metadata
                if (outputQuery) {
                    const words = outputQuery.toLowerCase().split(/\s+/).filter(w => w.length > 0);
                    exchanges = exchanges.filter(ex => {
                        const material = (ex.output.material || '').toLowerCase().replace(/_/g, ' ');
                        const customName = (ex.output.customName || '').toLowerCase();
                        const lore = (Array.isArray(ex.output.lore) ? ex.output.lore.join(' ') : String(ex.output.lore || '')).toLowerCase();
                        const combined = `${material} ${customName} ${lore}`;
                        
                        return words.every(word => combined.includes(word));
                    });
                }
                if (inputQuery) {
                    const words = inputQuery.toLowerCase().split(/\s+/).filter(w => w.length > 0);
                    exchanges = exchanges.filter(ex => {
                        const material = (ex.input.material || '').toLowerCase().replace(/_/g, ' ');
                        const customName = (ex.input.customName || '').toLowerCase();
                        const lore = (Array.isArray(ex.input.lore) ? ex.input.lore.join(' ') : String(ex.input.lore || '')).toLowerCase();
                        const combined = `${material} ${customName} ${lore}`;
                        
                        return words.every(word => combined.includes(word));
                    });
                }

                lastExchanges = exchanges;
                lastQueryLabel = isIceniaOnly ? "Icenia City" : (outputQuery || inputQuery);
                
                applyFiltersAndDisplay();
            } catch (error) {
                console.error('Search failed:', error);
                resultsContainer.innerHTML = `<div class="results-placeholder"><p class="govuk-body-s" style="color: #d4351c;">Error fetching data from Tradex. Please try again.<br><small>${error.message}</small></p></div>`;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function selectMarker(marker) {
            // Remove ping and reset z-index from previous marker
            if (activeMarker) {
                const oldEl = activeMarker.getElement();
                if (oldEl) {
                    oldEl.classList.remove('ping-animation');
                    activeMarker.setZIndexOffset(0);
                }
            }
            
            activeMarker = marker;
            const el = marker.getElement();
            if (el) {
                el.classList.remove('ping-animation');
                void el.offsetWidth; // trigger reflow
                el.classList.add('ping-animation');
                marker.setZIndexOffset(1000); // Bring to front
            }
        }

        function applyFiltersAndDisplay() {
            if (lastExchanges.length === 0 && !lastQueryLabel) return;
            const iceniaOnly = iceniaOnlyCheckbox.checked;
            let filtered = [...lastExchanges];
            
            // Enchantment filters
            const enchantRows = document.querySelectorAll('.enchant-filter-row');
            const activeFilters = [];
            enchantRows.forEach(row => {
                const name = row.querySelector('.enchant-name-select').value;
                const level = parseInt(row.querySelector('.enchant-level-input').value) || 0;
                if (name) {
                    activeFilters.push({ name, level });
                }
            });

            if (activeFilters.length > 0) {
                filtered = filtered.filter(ex => {
                    // Check output item for enchants
                    if (!ex.output.enchants) return false;
                    
                    return activeFilters.every(filter => {
                        const itemLevel = ex.output.enchants[filter.name] || ex.output.enchants['minecraft:' + filter.name] || 0;
                        return itemLevel >= filter.level;
                    });
                });
            }

            if (iceniaOnly) {
                filtered = filtered.filter(ex => 
                    ex.pos.x >= ICENIA_CITY_BOUNDS.minX && 
                    ex.pos.x <= ICENIA_CITY_BOUNDS.maxX && 
                    ex.pos.z >= ICENIA_CITY_BOUNDS.minZ && 
                    ex.pos.z <= ICENIA_CITY_BOUNDS.maxZ
                );
            }
            
            // Client-side sorting (Fixes "Sort by doesn't work" issue)
            const sortMode = sortModeSelect.value;
            if (sortMode === 'cheapest') {
                filtered.sort((a, b) => (a.input.count / a.output.count) - (b.input.count / b.output.count));
            } else if (sortMode === 'latest') {
                filtered.sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
            } else if (sortMode === 'stock') {
                filtered.sort((a, b) => b.stock - a.stock);
            } else if (sortMode === 'closest') {
                const pos = userLocation || { x: -3870, z: -4400 };
                const dist = (p) => Math.sqrt(Math.pow(p.x - pos.x, 2) + Math.pow(p.z - pos.z, 2));
                filtered.sort((a, b) => dist(a.pos) - dist(b.pos));
            }

            displayResults(filtered, lastQueryLabel);
        }

        function displayResults(exchanges, queryLabel) {
            markerGroup.clearLayers();
            markers = [];
            activeMarker = null;
            activeCard = null;

            if (!exchanges || exchanges.length === 0) {
                const updatedAfter = document.getElementById('updated-after').value;
                const allowUnstocked = allowUnstockedCheckbox.checked;
                
                let warning = `<div class="results-placeholder no-results">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <p class="govuk-body-s"><strong>No shops found for "${queryLabel}"</strong></p>
                    <ul class="govuk-list govuk-list--bullet govuk-body-s">
                        ${!allowUnstocked ? '<li>Try enabling <strong>"Unstocked"</strong> in options</li>' : ''}
                        ${updatedAfter !== '0' ? '<li>Try setting <strong>"Time"</strong> to "Anytime"</li>' : ''}
                        <li>Check for typos in the item name</li>
                    </ul>
                </div>`;
                resultsContainer.innerHTML = warning;
                return;
            }

            const grouped = {};
            exchanges.forEach(ex => {
                const key = `${ex.pos.x},${ex.pos.y},${ex.pos.z}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(ex);
            });

            Object.entries(grouped).forEach(([key, locExchanges]) => {
                const first = locExchanges[0];
                const latLng = mcToLatLng(first.pos.x, first.pos.z);
                
                const marker = L.marker(latLng, {
                    icon: L.divIcon({
                        className: 'shop-pointer-marker',
                        html: '<div class="pointer-inner"></div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -35]
                    })
                }).addTo(markerGroup);
                
                let popupContent = `<div class="shop-popup">
                    <h3>Shop at ${first.pos.x}, ${first.pos.z}</h3>
                    <div class="exchanges-list">`;
                
                locExchanges.forEach(ex => {
                    const inputFmt = formatCount(ex.input.count, ex.input);
                    const outputFmt = formatCount(ex.output.count, ex.output);
                    
                    const inputLore = formatLoreText(ex.input);
                    const outputLore = formatLoreText(ex.output);

                    popupContent += `
                        <div class="exchange-row">
                            <div class="exchange-item-bundle">
                                <div class="item-icon-bg small" ${inputLore ? `data-lore="${inputLore.replace(/"/g, '&quot;')}"` : ''}>
                                    <img class="popup-item-icon" src="${getItemIconUrl(ex.input.material)}" onerror="if(!this.dataset.triedFallback){this.dataset.triedFallback=true; this.src=getFallbackIconUrl('${ex.input.material}');}else if(!this.dataset.triedBlock){this.dataset.triedBlock=true; this.src=this.src.replace('/items/', '/blocks/');}else{this.style.opacity='0';}">
                                    ${inputLore ? '<div class="lore-indicator"></div>' : ''}
                                </div>
                                <span class="exchange-price">
                                    <span class="count ${inputFmt.isCompacted ? 'compacted' : ''}">${inputFmt.text}</span>
                                    <span class="name">${formatItemName(ex.input)}</span>
                                </span>
                            </div>
                            <span class="exchange-arrow">‚Üí</span>
                            <div class="exchange-item-bundle output">
                                <span class="exchange-output">
                                    <span class="count ${outputFmt.isCompacted ? 'compacted' : ''}">${outputFmt.text}</span>
                                    <span class="name">${formatItemName(ex.output)}</span>
                                </span>
                                <div class="item-icon-bg small" ${outputLore ? `data-lore="${outputLore.replace(/"/g, '&quot;')}"` : ''}>
                                    <img class="popup-item-icon" src="${getItemIconUrl(ex.output.material)}" onerror="if(!this.dataset.triedFallback){this.dataset.triedFallback=true; this.src=getFallbackIconUrl('${ex.output.material}');}else if(!this.dataset.triedBlock){this.dataset.triedBlock=true; this.src=this.src.replace('/items/', '/blocks/');}else{this.style.opacity='0';}">
                                    ${outputLore ? '<div class="lore-indicator"></div>' : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                popupContent += `</div></div>`;
                marker.bindPopup(popupContent);
                marker.on('click', () => {
                    const latLng = mcToLatLng(first.pos.x, first.pos.z);
                    flyToWithOffset(latLng, DEFAULT_CLICK_ZOOM);
                    selectMarker(marker);
                });
                markers.push({ key, marker, exchanges: locExchanges });
            });

            resultsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            exchanges.forEach((ex, index) => {
                const card = document.createElement('div');
                card.className = 'shop-result-card';
                card.style.animationDelay = `${index * 0.04}s`;
                
                const stockClass = ex.stock > 64 ? 'stock-high' : (ex.stock > 0 ? 'stock-low' : 'stock-none');
                const stockText = ex.stock > 0 ? `Stock: ${ex.stock}` : 'Out of Stock';
                const outputName = formatItemName(ex.output);
                const inputName = formatItemName(ex.input);
                const inputFmt = formatCount(ex.input.count, ex.input);
                const outputFmt = formatCount(ex.output.count, ex.output);
                
                const inputLore = formatLoreText(ex.input);
                const outputLore = formatLoreText(ex.output);

                // Freshness logic
                const now = Date.now();
                const updatedAt = ex.updatedAt || now;
                const ageDays = (now - updatedAt) / (1000 * 60 * 60 * 24);
                let freshnessClass = 'fresh-red';
                let freshnessText = 'Old';
                if (ageDays < 7) {
                    freshnessClass = 'fresh-green';
                    freshnessText = 'Recent';
                } else if (ageDays < 30) {
                    freshnessClass = 'fresh-yellow';
                    freshnessText = '30d';
                }

                card.innerHTML = `
                    <div class="trade-display">
                        <div class="item-stack">
                            <div class="item-icon-bg" ${inputLore ? `data-lore="${inputLore.replace(/"/g, '&quot;')}"` : ''}>
                                <img class="item-icon" src="${getItemIconUrl(ex.input.material)}" onerror="if(!this.dataset.triedFallback){this.dataset.triedFallback=true; this.src=getFallbackIconUrl('${ex.input.material}');}else if(!this.dataset.triedBlock){this.dataset.triedBlock=true; this.src=this.src.replace('/items/', '/blocks/');}else{this.style.opacity='0';}" alt="">
                                <span class="stack-count ${inputFmt.isCompacted ? 'compacted' : ''}">${inputFmt.text}</span>
                                ${inputLore ? '<div class="lore-indicator"></div>' : ''}
                            </div>
                            <span class="item-label">${inputName}</span>
                        </div>
                        <div class="trade-arrow">‚Üí</div>
                        <div class="item-stack">
                            <div class="item-icon-bg" ${outputLore ? `data-lore="${outputLore.replace(/"/g, '&quot;')}"` : ''}>
                                <img class="item-icon" src="${getItemIconUrl(ex.output.material)}" onerror="if(!this.dataset.triedFallback){this.dataset.triedFallback=true; this.src=getFallbackIconUrl('${ex.output.material}');}else if(!this.dataset.triedBlock){this.dataset.triedBlock=true; this.src=this.src.replace('/items/', '/blocks/');}else{this.style.opacity='0';}" alt="">
                                <span class="stack-count ${outputFmt.isCompacted ? 'compacted' : ''}">${outputFmt.text}</span>
                                ${outputLore ? '<div class="lore-indicator"></div>' : ''}
                            </div>
                            <span class="item-label">${outputName}</span>
                        </div>
                    </div>
                    <div class="result-meta">
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span class="stock-badge ${stockClass}">${stockText}</span>
                            <span class="freshness-badge ${freshnessClass}" title="Last updated: ${new Date(updatedAt).toLocaleDateString()}">${freshnessText}</span>
                        </div>
                        <span class="coords-label">üìç ${ex.pos.x}, ${ex.pos.z}</span>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    const latLng = mcToLatLng(ex.pos.x, ex.pos.z);
                    
                    if (activeCard === card) {
                        // Second click: Zoom out
                        if (markers.length > 0) {
                            const bounds = L.featureGroup(markers.map(m => m.marker)).getBounds();
                            const isMobile = window.innerWidth <= 768;
                            map.fitBounds(bounds, { 
                                paddingTopLeft: isMobile ? [20, 20] : [420, 50],
                                paddingBottomRight: isMobile ? [20, window.innerHeight * 0.45] : [50, 50],
                                maxZoom: 0 
                            });
                        }
                        if (activeMarker) {
                            const oldEl = activeMarker.getElement();
                            if (oldEl) oldEl.classList.remove('ping-animation');
                            activeMarker.setZIndexOffset(0);
                            activeMarker.closePopup();
                        }
                        card.classList.remove('active');
                        activeCard = null;
                        activeMarker = null;
                        return;
                    }

                    flyToWithOffset(latLng, DEFAULT_CLICK_ZOOM);
                    
                    const markerObj = markers.find(m => m.key === `${ex.pos.x},${ex.pos.y},${ex.pos.z}`);
                    if (markerObj) {
                        markerObj.marker.openPopup();
                        selectMarker(markerObj.marker);
                    }
                    
                    if (activeCard) activeCard.classList.remove('active');
                    card.classList.add('active');
                    activeCard = card;
                });
                fragment.appendChild(card);
            });
            resultsContainer.appendChild(fragment);

            if (markers.length > 0) {
                const bounds = L.featureGroup(markers.map(m => m.marker)).getBounds();
                const isMobile = window.innerWidth <= 768;
                map.fitBounds(bounds, { 
                    paddingTopLeft: isMobile ? [20, 20] : [420, 50],
                    paddingBottomRight: isMobile ? [20, window.innerHeight * 0.45] : [50, 50],
                    maxZoom: 0 
                });
            }
        }

        searchButton.addEventListener('click', () => performSearch(false));
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch(false);
        });

        searchInput.addEventListener('input', () => {
            searchInput.placeholder = "I want to buy (e.g. diamond)";
        });
        
        document.getElementById('show-icenia-shops').addEventListener('click', () => {
            searchInput.value = ''; 
            searchInput.placeholder = "Showing all Icenia City shops...";
            performSearch(true);
        });

        sortModeSelect.addEventListener('change', () => applyFiltersAndDisplay());
        allowUnstockedCheckbox.addEventListener('change', () => applyFiltersAndDisplay());
        iceniaOnlyCheckbox.addEventListener('change', () => applyFiltersAndDisplay());
        
        const toggleOptionsBtn = document.getElementById('toggle-options');
        const advancedOptionsWrapper = document.getElementById('advanced-options-wrapper');
        const advancedOptionsGrid = document.getElementById('advanced-options');

        // Initial state: Open on PC, Closed on Mobile
        if (window.innerWidth <= 768) {
            advancedOptionsWrapper.classList.add('collapsed');
            toggleOptionsBtn.classList.remove('active');
        } else {
            toggleOptionsBtn.classList.add('active');
        }

        toggleOptionsBtn.addEventListener('click', () => {
            advancedOptionsWrapper.classList.toggle('collapsed');
            toggleOptionsBtn.classList.toggle('active');
            // Update scroll indicator when toggled
            setTimeout(updateAdvancedScroll, 450);
        });

        // --- Custom Scroll Indicator Logic ---
        function setupScrollIndicator(scrollEl, indicatorEl) {
            if (!scrollEl || !indicatorEl) return;
            
            const scrollThumb = indicatorEl.querySelector('.scroll-thumb');
            let hideTimeout;
            
            // Use passive listener for better scroll performance
            const scrollOptions = { passive: true };
            
            function updateScrollIndicator() {
                const { scrollTop, scrollHeight, clientHeight } = scrollEl;
                const scrollableHeight = scrollHeight - clientHeight;
                
                // Hide indicator if no scrolling needed
                if (scrollableHeight <= 0) {
                    indicatorEl.style.display = 'none';
                    return;
                }
                indicatorEl.style.display = 'block';
                
                // Calculate thumb position (0 to 70% to leave room for thumb height)
                const scrollPercent = scrollTop / scrollableHeight;
                const thumbTop = scrollPercent * 70;
                scrollThumb.style.top = thumbTop + '%';
                
                // Add/remove at-bottom class to stop glow animation
                if (scrollPercent > 0.98) {
                    indicatorEl.classList.add('at-bottom');
                } else {
                    indicatorEl.classList.remove('at-bottom');
                }
                
                // Show indicator briefly when scrolling
                indicatorEl.classList.add('visible');
                
                // Don't hide if it's the info panel
                if (scrollEl.id !== 'info-content') {
                    clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(() => {
                        indicatorEl.classList.remove('visible');
                    }, 1500);
                } else {
                    // For info panel, keep it visible if scrollable
                    indicatorEl.classList.add('visible');
                    // Force opacity for info panel indicator
                    indicatorEl.style.opacity = '1';
                }
            }
            
            scrollEl.addEventListener('scroll', updateScrollIndicator, scrollOptions);
            
            // Initial check
            updateScrollIndicator();
            
            return updateScrollIndicator;
        }

        const updateResultsScroll = setupScrollIndicator(
            document.getElementById('results-container'),
            document.getElementById('results-scroll-indicator')
        );

        const updateAdvancedScroll = setupScrollIndicator(
            document.getElementById('advanced-options'),
            document.getElementById('advanced-scroll-indicator')
        );

        const updateInfoScroll = setupScrollIndicator(
            document.getElementById('info-content'),
            document.getElementById('info-scroll-indicator')
        );

        // Update indicators when content changes
        const resultsObserver = new MutationObserver(() => {
            setTimeout(updateResultsScroll, 100);
        });
        resultsObserver.observe(document.getElementById('results-container'), { childList: true, subtree: true });

        const advancedObserver = new MutationObserver(() => {
            setTimeout(updateAdvancedScroll, 100);
        });
        advancedObserver.observe(document.getElementById('advanced-options'), { childList: true, subtree: true });

        const infoObserver = new MutationObserver(() => {
            setTimeout(updateInfoScroll, 100);
        });
        infoObserver.observe(document.getElementById('info-content'), { childList: true, subtree: true });

        // Update all scroll indicators on window resize
        window.addEventListener('resize', () => {
            updateResultsScroll();
            updateAdvancedScroll();
            updateInfoScroll();
        });

        centerIceniaBtn.addEventListener('click', () => flyToWithOffset(ICENIA_CITY_COORDS, 0));

        setLocationBtn.addEventListener('click', () => {
            isSettingLocation = !isSettingLocation;
            setLocationBtn.classList.toggle('active', isSettingLocation);
            document.getElementById('shop-map').style.cursor = isSettingLocation ? 'crosshair' : '';
        });

        function updateDarkMode() {
            const container = document.querySelector('.shop-explorer-container');
            const sunIcon = darkModeToggle.querySelector('.sun-icon');
            const moonIcon = darkModeToggle.querySelector('.moon-icon');
            if (isDarkMode) {
                container.classList.add('dark-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                container.classList.remove('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        darkModeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            updateDarkMode();
        });

        updateDarkMode();

        // --- Tooltip Logic ---
        const tooltip = document.getElementById('item-tooltip');
        let tooltipTimeout;

        function showTooltip(e, text) {
            if (!text) return;
            tooltip.innerHTML = renderMinecraftText(text);
            tooltip.classList.remove('hidden');
            updateTooltipPos(e);
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        function updateTooltipPos(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            
            // Keep on screen
            const width = tooltip.offsetWidth;
            const height = tooltip.offsetHeight;
            
            let finalX = x;
            let finalY = y;
            
            if (x + width > window.innerWidth) finalX = e.clientX - width - 15;
            if (y + height > window.innerHeight) finalY = e.clientY - height - 15;
            
            tooltip.style.left = finalX + 'px';
            tooltip.style.top = finalY + 'px';
        }

        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[data-lore]');
            if (target) {
                showTooltip(e, target.dataset.lore);
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!tooltip.classList.contains('hidden')) {
                updateTooltipPos(e);
            }
        });

        document.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-lore]');
            if (target) {
                hideTooltip();
            }
        });

        // Mobile support: toggle on click
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-lore]');
            if (target && window.innerWidth <= 768) {
                if (tooltip.classList.contains('hidden')) {
                    showTooltip(e, target.dataset.lore);
                    // Auto hide after 3s on mobile
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = setTimeout(hideTooltip, 3000);
                } else {
                    hideTooltip();
                }
            } else if (!target) {
                hideTooltip();
            }
        });

        const infoToggle = document.getElementById('info-toggle');
        const infoPanel = document.getElementById('info-panel');

        // PC: Toggled ON by default, Mobile: Toggled OFF
        if (window.innerWidth > 768) {
            infoPanel.classList.remove('hidden');
        }

        infoToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            infoPanel.classList.toggle('hidden');
            if (!infoPanel.classList.contains('hidden')) {
                setTimeout(updateInfoScroll, 100);
            }
        });

        // Close panel when clicking elsewhere on the map
        map.on('click', () => {
            infoPanel.classList.add('hidden');
        });

        document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());

        map.on('click', (e) => {
            if (isSettingLocation) {
                const x = Math.round(e.latlng.lng);
                const z = Math.round(-e.latlng.lat);
                userLocation = { x, z };
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'user-location-radar',
                        html: '<div class="radar-ring"></div><div class="radar-dot"></div>',
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    })
                }).addTo(map);
                isSettingLocation = false;
                setLocationBtn.classList.remove('active');
                document.getElementById('shop-map').style.cursor = '';
                
                // Automatically switch to closest sort mode and search
                sortModeSelect.value = 'closest';
                performSearch(false);
            }
        });
    });
</script>
