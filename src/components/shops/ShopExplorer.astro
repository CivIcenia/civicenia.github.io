---
import { ITEM_MAPPINGS } from '../../data/item-mappings';
/**
 * Shop Explorer Component
 * Interactive map and search for shop chests using Tradex API
 */
const BASE = (import.meta.env.BASE_URL ?? "/");
---

<div class="shop-explorer-container">
    <!-- Search Overlay -->
    <div class="search-panel">
        <div class="search-header">
            <div class="header-main">
                <h2 class="govuk-heading-m">Shop Explorer</h2>
                <button id="show-icenia-shops" class="icenia-quick-btn" title="Show all Icenia City shops">
                    <img src={BASE + "assets/images/icenia_logo.svg"} alt="Icenia" width="20" height="20">
                    View Icenia City Shops
                </button>
            </div>
        </div>
        
        <div class="search-controls">
            <div class="search-main-row">
                <div class="search-input-wrapper">
                    <input class="govuk-input" id="item-search" name="item-search" type="text" placeholder="I want to buy (e.g. diamond)">
                    <button id="toggle-options" class="options-toggle-btn" title="Toggle Search Options">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 21v-7M4 10V3M12 21v-9M12 8V3M20 21v-5M20 12V3M1 14h6M9 8h6M17 16h6"/>
                        </svg>
                    </button>
                    <button id="search-button" class="search-submit-btn" type="button">
                        <svg width="18" height="18" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M19 19L14.65 14.65M17 9C17 13.4183 13.4183 17 9 17C4.58172 17 1 13.4183 1 9C1 4.58172 4.58172 1 9 1C13.4183 1 17 4.58172 17 9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div id="advanced-options-wrapper" class="advanced-options-wrapper scroll-container">
                <div id="advanced-options" class="advanced-grid">
                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="input-search">I want to pay with</label>
                        <input class="govuk-input govuk-input--small" id="input-search" name="input-search" type="text" placeholder="e.g. iron">
                    </div>

                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="sort-mode">Sort</label>
                        <select class="govuk-select" id="sort-mode" name="sort-mode">
                            <option value="closest">Closest</option>
                            <option value="cheapest" selected>Cheapest</option>
                            <option value="latest">Latest</option>
                            <option value="stock">In Stock</option>
                        </select>
                    </div>

                    <div class="govuk-form-group">
                        <label class="govuk-label govuk-label--s" for="updated-after">Last Updated Within</label>
                        <select class="govuk-select" id="updated-after" name="updated-after">
                            <option value="0">Anytime</option>
                            <option value="604800000" selected>7d</option>
                            <option value="2592000000">30d</option>
                        </select>
                    </div>

                    <div class="enchantment-filter-container" style="grid-column: span 2;">
                        <label class="govuk-label govuk-label--s">Enchantment Filters</label>
                        <div id="enchantment-filters-list" class="enchant-filters-list">
                            <!-- Rows added via JS -->
                        </div>
                        <button type="button" id="add-enchant-filter" class="add-enchant-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>
                            </svg>
                            Add Enchantment
                        </button>
                    </div>

                    <div class="govuk-checkboxes govuk-checkboxes--small side-by-side">
                        <div class="govuk-checkboxes__item">
                            <input class="govuk-checkboxes__input" id="allow-unstocked" name="allow-unstocked" type="checkbox">
                            <label class="govuk-label govuk-checkboxes__label" for="allow-unstocked">Unstocked</label>
                        </div>
                        <div class="govuk-checkboxes__item">
                            <input class="govuk-checkboxes__input" id="icenia-only" name="icenia-only" type="checkbox">
                            <label class="govuk-label govuk-checkboxes__label" for="icenia-only">Icenia Only</label>
                        </div>
                    </div>
                </div>
                <div class="scroll-indicator" id="advanced-scroll-indicator">
                    <div class="scroll-track">
                        <div class="scroll-thumb"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="loading-overlay" class="loading-overlay hidden">
            <div class="spinner"></div>
            <p class="govuk-body-s">Searching Tradex...</p>
        </div>

        <!-- Results Container -->
        <div class="results-scroll-wrapper scroll-container">
            <div id="results-container" class="results-container">
                <div class="results-placeholder">
                    <p class="govuk-body-s">Enter an item name above to search shops across the world.</p>
                </div>
            </div>
            <div class="scroll-indicator" id="results-scroll-indicator">
                <div class="scroll-track">
                    <div class="scroll-thumb"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Item Tooltip -->
    <div id="item-tooltip" class="item-tooltip hidden"></div>

    <!-- Map Controls -->
    <div class="map-extra-controls">
        <button id="dark-mode-toggle" class="map-control-btn" title="Toggle Dark Mode">
            <svg class="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
            <svg class="moon-icon hidden" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
            </svg>
        </button>
        <button id="toggle-territories" class="map-control-btn" title="Toggle Territories" aria-pressed="false">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 6h18M3 12h18M3 18h18" />
            </svg>
        </button>
        <button id="center-icenia" class="map-control-btn" title="Center on Icenia City">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="8" fill="#3AB3DA" stroke="white" />
            </svg>
        </button>
        <button id="set-location" class="map-control-btn" title="Set My Location (Click on map)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" />
                <circle cx="12" cy="10" r="3" />
            </svg>
        </button>
        <div class="zoom-group">
            <button id="zoom-in" class="map-control-btn" title="Zoom In">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
            <button id="zoom-out" class="map-control-btn" title="Zoom Out">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="5" y1="12" x2="19" y2="12" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Map Container -->
    <div id="shop-map" class="shop-map"></div>
    
    <!-- Map Info & Attribution -->
    <div class="map-info-container">
        <div id="info-panel" class="info-panel hidden scroll-container">
            <div class="info-content" id="info-content">
                <div class="info-section">
                    <h5>Controls</h5>
                    <p>üñ±Ô∏è Scroll to zoom</p>
                    <p>üñêÔ∏è Drag to pan</p>
                    <p>üìç Click markers for details</p>
                </div>
                <div class="info-cta-box">
                    <a href="https://modrinth.com/mod/tradex" target="_blank" class="modrinth-cta">
                        <div class="cta-title">üöÄ Install Tradex Mod</div>
                        <div class="cta-desc">Help keep the map updated! <br> Shopkeepers & Travellers wanted <br> for data logging.</div>
                    </a>
                </div>
                <div class="info-section">
                    <h5>Credits</h5>
                    <p>Backend: <a href="https://github.com/gjum/tradex" target="_blank">Tradex</a></p>
                    <p>Map: <a href="https://map.civinfo.net" target="_blank">CivInfo</a></p>
                    <p>Thanks Gjum for making Tradex and Civinfo.net! ‚ù§Ô∏è</p>
                </div>
                <div class="info-section">
                    <h5>Donations</h5>
                    <div class="donation-item">
                        <span>Creepily</span>
                        <code class="sortcode">HS-9363</code>
                    </div>
                    <div class="donation-item">
                        <span>Gjum</span>
                        <code class="sortcode">HS-3134</code>
                    </div>
                    <div class="donation-item">
                        <span>Icenia City</span>
                        <code class="sortcode">HS-1901</code>
                    </div>
                </div>
            </div>
            <div class="scroll-indicator" id="info-scroll-indicator">
                <div class="scroll-track">
                    <div class="scroll-thumb"></div>
                </div>
            </div>
        </div>
        <div class="map-controls-row">
            <button id="info-toggle" class="map-control-btn info-btn" title="Map Info & Credits">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
            </button>
            <div class="coords-panel" title="Map cursor and pin coordinates">
                <div class="coords-item">
                    <div class="label">Cursor</div>
                    <div id="cursor-coords" class="value">‚Äî</div>
                </div>
                <div class="coords-item">
                    <div class="label">Pin</div>
                    <div id="pin-coords" class="value">‚Äî</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
    @font-face {
        font-family: "Minecraft Seven";
        src: url("/assets/fonts/Minecraft_Seven_v3.woff2") format("woff2"),
             url("/assets/fonts/minecraft-seven.woff") format("woff");
        font-weight: 600;
        font-style: normal;
        font-display: swap;
    }

    .shop-explorer-container {
        position: relative;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #121212;

        /* Minecraft Color Variables - Light Mode Defaults (High Contrast) */
        --mc-0: #000000;
        --mc-1: #0000AA;
        --mc-2: #00AA00;
        --mc-3: #00AAAA;
        --mc-4: #AA0000;
        --mc-5: #AA00AA;
        --mc-6: #D9A300;
        --mc-7: #777777;
        --mc-8: #555555;
        --mc-9: #0000FF;
        --mc-a: #008800;
        --mc-b: #008888;
        --mc-c: #CC0000;
        --mc-d: #AA00AA;
        --mc-e: #999900;
        --mc-f: #222222;
    }

    /* Search Panel */
    .search-panel {
        position: absolute;
        top: 20px;
        left: 20px;
        bottom: 20px;
        width: 380px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        z-index: 1000;
        border-radius: 16px;
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: background 0.3s, border-color 0.3s, color 0.3s;
    }

    /* Dark Mode Styles */
    .shop-explorer-container.dark-mode {
        /* Minecraft Color Variables - Dark Mode Overrides (High Contrast) */
        --mc-0: #FFFFFF;
        --mc-1: #0000AA;
        --mc-2: #00AA00;
        --mc-3: #00AAAA;
        --mc-4: #AA0000;
        --mc-5: #AA00AA;
        --mc-6: #FFAA00;
        --mc-7: #AAAAAA;
        --mc-8: #555555;
        --mc-9: #5555FF;
        --mc-a: #55FF55;
        --mc-b: #55FFFF;
        --mc-c: #FF5555;
        --mc-d: #FF55FF;
        --mc-e: #FFFF55;
        --mc-f: #FFFFFF;
    }

    .shop-explorer-container.dark-mode .search-panel {
        background: rgba(24, 24, 24, 0.98);
        border-color: rgba(255, 255, 255, 0.08);
        color: #eee;
    }

    .shop-explorer-container.dark-mode .search-controls {
        background: #1a1a1a;
        border-bottom-color: #333;
    }

    .shop-explorer-container.dark-mode .advanced-grid {
        border-top-color: #333;
    }

    .shop-explorer-container.dark-mode .govuk-label {
        color: #aaa;
    }

    .shop-explorer-container.dark-mode .govuk-input,
    .shop-explorer-container.dark-mode .govuk-select {
        background: #262626;
        color: white;
        border-color: #444;
    }

    .shop-explorer-container.dark-mode .results-container {
        background: #121212;
    }

    .shop-explorer-container.dark-mode :global(.shop-result-card) {
        background: #1e1e1e !important;
        border-color: #333 !important;
        color: #eee !important;
    }

    .shop-explorer-container.dark-mode :global(.trade-display) {
        background: #262626 !important;
        border-color: #333 !important;
    }

    .shop-explorer-container.dark-mode :global(.item-label) {
        color: #bbb !important;
    }

    .shop-explorer-container.dark-mode :global(.item-icon-bg) {
        background: #1a1a1a !important;
    }

    .shop-explorer-container.dark-mode :global(.stack-count) {
        background: rgba(0, 0, 0, 0.6) !important;
        color: white !important;
        border-color: #444 !important;
    }

    :global(.count) {
        color: black;
    }
    .shop-explorer-container.dark-mode :global(.count) {
        color: white !important;
    }

    /* Compacted (ci) styling - High priority */
    :global(.stack-count.compacted),
    :global(.count.compacted) {
        color: #7f00ff !important;
        /* background: #000 !important; */
        /* border: 2px solid #FFD700 !important; */
        /* text-shadow: 0 0 4px rgba(0,0,0,0.8), 1px 1px 0px #000 !important; */
        font-weight: 900 !important;
        /* box-shadow: 0 2px 4px rgba(0,0,0,0.5) !important; */
        z-index: 10 !important;
    }

    .shop-explorer-container.dark-mode :global(.stack-count.compacted),
    .shop-explorer-container.dark-mode :global(.count.compacted) {
        color: #bb88ff !important;
    }

    .shop-explorer-container.dark-mode :global(.result-meta) {
        color: #999 !important;
    }

    .shop-explorer-container.dark-mode :global(.freshness-badge) {
        border: 1px solid rgba(255,255,255,0.1);
    }

    .shop-explorer-container.dark-mode :global(.results-placeholder),
    .shop-explorer-container.dark-mode :global(.results-placeholder p),
    .shop-explorer-container.dark-mode :global(.results-placeholder strong),
    .shop-explorer-container.dark-mode :global(.results-placeholder li) {
        color: #b1b4b6 !important;
    }

    .shop-explorer-container.dark-mode :global(.no-results) {
        background: rgba(255, 255, 255, 0.03) !important;
        border-color: #333 !important;
    }

    .shop-explorer-container.dark-mode :global(.govuk-list) {
        color: #aaa !important;
    }

    .shop-explorer-container.dark-mode .map-control-btn {
        background: #141423;
        color: white;
        border: 1px solid #2d2d44;
    }

    .shop-explorer-container.dark-mode .map-control-btn:hover {
        background: #1c1c30;
    }

    .shop-explorer-container.dark-mode :global(.leaflet-popup-content-wrapper),
    .shop-explorer-container.dark-mode :global(.leaflet-popup-tip) {
        background: #262626 !important;
        color: white !important;
        border: 1px solid #2d2d44;
    }

    .shop-explorer-container.dark-mode :global(.shop-popup h3) {
        color: white;
        border-bottom-color: #333;
    }

    .shop-explorer-container.dark-mode :global(.exchange-row) {
        border-bottom-color: #333;
    }

    .shop-explorer-container.dark-mode :global(.exchange-output),
    .shop-explorer-container.dark-mode :global(.exchange-price) {
        background: #1a1a2e !important;
        color: #4da3ff !important;
        border: 1px solid rgba(77, 163, 255, 0.2) !important;
    }

    .search-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #1C70B8 0%, #003078 100%);
        color: white;
    }

    .header-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .search-header h2 {
        color: white;
        margin-bottom: 0;
        font-weight: 700;
        font-size: 18px;
    }

    .icenia-quick-btn {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 6px 14px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .icenia-quick-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .icenia-quick-btn img {
        background: white;
        border-radius: 50%;
        padding: 2px;
        width: 22px;
        height: 22px;
        object-fit: contain;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
    }

    .search-controls {
        padding: 12px 16px;
        border-bottom: 1px solid #e5e5e5;
        background: #fcfcfc;
        transition: background 0.3s, border-color 0.3s;
    }

    .search-main-row {
        margin-bottom: 12px;
    }

    .advanced-options-wrapper {
        display: flex;
        flex-direction: column;
        max-height: 500px;
        overflow: hidden;
        transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
                    opacity 0.3s ease,
                    padding 0.4s ease,
                    margin 0.4s ease;
        position: relative;
        padding-right: 10px;
        flex-shrink: 0;
    }

    @media (max-width: 768px) {
        .advanced-options-wrapper {
            max-height: 250px;
        }
    }

    .advanced-options-wrapper.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        margin-top: 0;
        pointer-events: none;
    }

    .advanced-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        padding: 12px 0;
        border-top: 1px solid #eee;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .advanced-grid::-webkit-scrollbar {
        display: none;
    }

    .advanced-grid.collapsed {
        max-height: 0;
        opacity: 0;
        padding-top: 0;
        margin-top: 0;
        border-top-color: transparent;
        pointer-events: none;
    }

    .advanced-grid .govuk-form-group {
        margin-bottom: 4px;
    }

    .advanced-grid .govuk-label {
        font-size: 12px;
        margin-bottom: 2px;
    }

    .advanced-grid .govuk-input, .advanced-grid .govuk-select {
        font-size: 13px;
        padding: 4px;
        height: auto;
    }

    /* Checkbox Refinements - Fixed Vertical Alignment */
    .side-by-side {
        display: flex !important;
        flex-wrap: wrap;
        gap: 15px;
        grid-column: span 2;
        margin-top: 8px;
        padding-bottom: 4px;
        justify-content: flex-start;
    }

    .side-by-side .govuk-checkboxes__item {
        margin-bottom: 0 !important;
        min-height: 24px !important;
        display: flex !important;
        align-items: center !important;
        padding-left: 32px !important;
        position: relative !important;
    }

    .side-by-side .govuk-checkboxes__input {
        width: 24px !important;
        height: 24px !important;
        top: 0 !important;
        margin: 0 !important;
        left: 0 !important;
        z-index: 2 !important;
    }

    .side-by-side .govuk-checkboxes__label {
        padding: 0 !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        display: inline-block !important;
        line-height: 24px !important;
        margin: 0 !important;
    }

    .side-by-side .govuk-checkboxes__label::before {
        top: 0 !important;
        width: 24px !important;
        height: 24px !important;
        left: 0 !important;
    }

    .side-by-side .govuk-checkboxes__label::after {
        top: 10px !important;
        left: 7px !important;
        width: 9px !important;
        height: 4px !important;
        border-width: 0 0 3px 3px !important;
        transform: rotate(-45deg) !important;
    }

    /* Fix oversized hover indicator on checkboxes */
    .govuk-checkboxes__item:hover .govuk-checkboxes__input:not(:disabled) + .govuk-checkboxes__label::before {
        box-shadow: none !important;
    }

    /* Remove yellow focus borders from all elements */
    .shop-explorer-container *:focus,
    .shop-explorer-container *:focus-visible,
    .shop-explorer-container *:active {
        outline: none !important;
        box-shadow: none !important;
        -webkit-tap-highlight-color: transparent;
    }
    
    :global(.leaflet-container *:focus),
    :global(.leaflet-marker-icon:focus) {
        outline: none !important;
        box-shadow: none !important;
    }

    .govuk-checkboxes__input:focus + .govuk-checkboxes__label::before {
        box-shadow: none !important;
    }

    .search-input-wrapper {
        display: flex;
        gap: 6px;
    }

    .options-toggle-btn {
        background: #f3f2f1;
        color: #505a5f;
        border: 1px solid #d5d8da;
        border-radius: 6px;
        padding: 0 10px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .shop-explorer-container.dark-mode .options-toggle-btn {
        background: #262626;
        color: #aaa;
        border-color: #444;
    }

    .options-toggle-btn:hover, .options-toggle-btn.active {
        background: #1C70B8;
        color: white;
        border-color: #1C70B8;
    }

    .search-submit-btn {
        background: #1C70B8;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 0 16px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .search-submit-btn:hover {
        background: #003078;
        transform: scale(1.05);
    }

    /* Item Tooltip - Always use Minecraft-style dark tooltip */
    .item-tooltip {
        /* Force Minecraft formatting color variables to the dark-mode high-contrast palette */
        --mc-0: #FFFFFF;
        --mc-1: #5555FF;
        --mc-2: #55FF55;
        --mc-3: #55FFFF;
        --mc-4: #FF5555;
        --mc-5: #FF55FF;
        --mc-6: #FFAA00;
        --mc-7: #AAAAAA;
        --mc-8: #CCCCCC;
        --mc-9: #5555FF;
        --mc-a: #55FF55;
        --mc-b: #55FFFF;
        --mc-c: #FF5555;
        --mc-d: #FF55FF;
        --mc-e: #FFFF55;
        --mc-f: #FFFFFF;

        position: fixed;
        z-index: 10000;
        background: rgba(20, 20, 30, 0.96);
        color: #eee;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 15px;
        pointer-events: none;
        box-shadow: 0 12px 48px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.08);
        max-width: 350px;
        line-height: 1.4;
        white-space: pre-wrap;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        transition: opacity 0.15s ease;
        font-family: "Minecraft Seven", "Minecraft", monospace, "Segoe UI", "Roboto", Helvetica, Arial, sans-serif;
        font-weight: 600;
    }


    /* Minecraft Formatting Colors - Theme Aware */
    :global(.mc-0) { color: var(--mc-0); }
    :global(.mc-1) { color: var(--mc-1); }
    :global(.mc-2) { color: var(--mc-2); }
    :global(.mc-3) { color: var(--mc-3); }
    :global(.mc-4) { color: var(--mc-4); }
    :global(.mc-5) { color: var(--mc-5); }
    :global(.mc-6) { color: var(--mc-6); }
    :global(.mc-7) { color: var(--mc-7); }
    :global(.mc-8) { color: var(--mc-8); }
    :global(.mc-9) { color: var(--mc-9); }
    :global(.mc-a) { color: var(--mc-a); }
    :global(.mc-b) { color: var(--mc-b); }
    :global(.mc-c) { color: var(--mc-c); }
    :global(.mc-d) { color: var(--mc-d); }
    :global(.mc-e) { color: var(--mc-e); }
    :global(.mc-f) { color: var(--mc-f); }
    
    :global(.mc-l) { font-weight: 900; }
    :global(.mc-m) { text-decoration: line-through; }
    :global(.mc-n) { text-decoration: underline; }
    :global(.mc-o) { font-style: italic; }
    :global(.mc-k) { 
        display: inline-block;
        filter: blur(1px);
        user-select: none;
        animation: mc-obfuscated 0.15s infinite; 
    }

    @keyframes mc-obfuscated {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }

    .item-tooltip.hidden {
        display: none;
        opacity: 0;
    }

    /* Enchantment Filter Styles */
    .enchantment-filter-container {
        margin-top: 4px;
        padding-top: 8px;
        border-top: 1px solid #eee;
    }

    .shop-explorer-container.dark-mode .enchantment-filter-container {
        border-top-color: #333;
    }

    .enchant-filters-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 8px;
    }

    :global(.enchant-filter-row) {
        display: flex;
        gap: 6px;
        align-items: center;
        animation: slideIn 0.2s ease-out;
    }

    :global(.enchant-name-select) {
        flex: 1;
        font-size: 12px !important;
        padding: 4px !important;
        height: 30px !important;
    }

    :global(.enchant-level-input) {
        width: 55px !important;
        font-size: 12px !important;
        padding: 4px !important;
        height: 30px !important;
        text-align: center;
    }

    :global(.remove-enchant-btn) {
        background: #f3f2f1;
        color: #d4351c;
        border: 1px solid #d5d8da;
        border-radius: 4px;
        width: 30px;
        height: 30px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.2s;
    }

    .shop-explorer-container.dark-mode :global(.remove-enchant-btn) {
        background: #262626;
        border-color: #444;
    }

    :global(.remove-enchant-btn:hover) {
        background: #d4351c;
        color: white;
        border-color: #d4351c;
    }

    .add-enchant-btn {
        background: transparent;
        color: #1C70B8;
        border: 1px dashed #1C70B8;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        justify-content: center;
        transition: all 0.2s;
    }

    .add-enchant-btn:hover {
        background: rgba(28, 112, 184, 0.05);
        border-style: solid;
    }

    .shop-explorer-container.dark-mode .add-enchant-btn {
        color: #4da3ff;
        border-color: #4da3ff;
    }

    /* Results Container */
    .results-scroll-wrapper {
        flex: 1;
        min-height: 0;
        position: relative;
        display: flex;
        flex-direction: column;
        padding-right: 10px;
        background: #f3f2f1;
    }

    .shop-explorer-container.dark-mode .results-scroll-wrapper {
        background: #121212;
    }

    .results-container {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    .results-container::-webkit-scrollbar {
        display: none;
    }

    /* Elegant Scroll Indicator Styles */
    .scroll-container {
        position: relative;
    }

    .scroll-indicator {
        position: absolute;
        width: 4px;
        height: calc(100% - 20px);
        right: 4px;
        top: 10px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 10;
        pointer-events: none;
    }

    .scroll-container:hover .scroll-indicator,
    .scroll-indicator.visible,
    #info-panel .scroll-indicator {
        opacity: 1 !important;
    }

    .scroll-track {
        height: 100%;
        background: rgba(0, 0, 0, 0.05);
        border-radius: 2px;
        position: relative;
        overflow: hidden;
    }

    .shop-explorer-container.dark-mode .scroll-track {
        background: rgba(255, 255, 255, 0.05);
    }

    .scroll-thumb {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 30%;
        background: rgba(28, 112, 184, 0.4);
        border-radius: 2px;
        transition: top 0.1s ease-out;
    }

    .shop-explorer-container.dark-mode .scroll-thumb {
        background: rgba(77, 163, 255, 0.4);
    }

    .scroll-thumb::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), transparent);
        border-radius: 2px;
        animation: scrollGlow 2s ease-in-out infinite;
    }

    @keyframes scrollGlow {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.8; }
    }

    .scroll-indicator.at-bottom .scroll-thumb::after {
        animation: none;
        opacity: 0.1;
    }

    :global(.results-placeholder) {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: #505a5f;
        text-align: center;
        padding: 40px;
        transition: all 0.3s;
    }

    :global(.no-results) {
        background: rgba(0, 0, 0, 0.02);
        border-radius: 16px;
        margin: 10px;
        border: 2px dashed rgba(0, 0, 0, 0.05);
        font-style: normal !important;
    }

    :global(.warning-icon) {
        font-size: 40px;
        margin-bottom: 12px;
        filter: grayscale(0.5);
    }

    :global(.no-results p) {
        margin-bottom: 16px;
    }

    :global(.no-results ul) {
        text-align: left;
        display: inline-block;
        margin: 0 auto;
    }

    :global(.shop-result-card) {
        background: white !important;
        border: 1px solid #d5d8da !important;
        border-radius: 12px !important;
        padding: 12px !important;
        cursor: pointer !important;
        transition: all 0.3s cubic-bezier(0.23, 1, 0.32, 1) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
        display: flex !important;
        flex-direction: column !important;
        gap: 10px !important;
        animation: slideIn 0.3s ease-out forwards !important;
        position: relative !important;
        overflow: visible !important;
        min-height: 110px !important;
        flex-shrink: 0 !important;
    }

    @keyframes slideIn {
        from { opacity: 0; transform: translateY(15px); }
        to { opacity: 1; transform: translateY(0); }
    }

    :global(.shop-result-card:hover) {
        border-color: #1C70B8 !important;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
        transform: translateY(-2px) !important;
    }

    :global(.shop-result-card.active) {
        border: 2px solid #1C70B8 !important;
        background: #f0f7ff !important;
        box-shadow: 0 4px 12px rgba(28, 112, 184, 0.15) !important;
    }

    :global(.trade-display) {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 8px !important;
        background: #f8f9fa !important;
        padding: 10px !important;
        border-radius: 10px !important;
        border: 1px solid #eee !important;
        min-height: 70px !important;
    }

    :global(.item-stack) {
        display: flex !important;
        flex-direction: column !important;
        align-items: center !important;
        gap: 4px !important;
        flex: 1 !important;
        min-width: 0 !important;
    }

    :global(.item-icon-bg) {
        width: 52px !important;
        height: 52px !important;
        background: #8B8B8B;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        position: relative;
        cursor: help;
        overflow: visible;
    }

    :global(.item-icon-bg.small) {
        width: 32px !important;
        height: 32px !important;
        border-radius: 6px;
    }

    :global(.item-icon) {
        width: 36px !important;
        height: 36px !important;
        image-rendering: pixelated;
    }

    :global(.stack-count) {
        font-family: "Minecraft Seven", "Minecraft", monospace, "Segoe UI", "Roboto", Helvetica, Arial, sans-serif;
        font-size: 12px;
        font-weight: 900;
        color: white;
        /* background: #ffffffc1; */
        background: #8b8b8bab;
        padding: 0px 4px;
        border-radius: 6px;
        position: absolute;
        /* bottom: -2px; */
        /* right: -2px; */
        bottom: 0px;
        right: 0px;
        /* border: 2px solid gray; */
        /* box-shadow: 0 2px 4px rgba(0,0,0,0); */
        z-index: 2;
    }

    .shop-explorer-container.dark-mode :global(.stack-count) {
        border-color: #1e1e1e;
    }

    :global(.trade-arrow) {
        font-size: 18px;
        color: #999;
        font-weight: bold;
    }

    :global(.item-label) {
        font-size: 11px;
        font-weight: 600;
        color: #555;
        text-align: center;
        width: 100%;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        line-height: 1.2;
        height: 2.4em;
        word-break: break-word;
    }


    :global(.result-meta) {
        font-size: 11px;
        color: #666;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 4px;
    }

    :global(.stock-badge) {
        padding: 3px 8px 0px 8px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
    }

    :global(.stock-high) { background: #cce2d8; color: #005a30; }
    :global(.stock-low) { background: #fff7bf; color: #594d00; }
    :global(.stock-none) { background: #f6d7d2; color: #942514; }

    :global(.freshness-badge) {
        padding: 3px 8px 0px 8px;
        border-radius: 10px;
        font-weight: 600;
        font-size: 10px;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
    }
    :global(.fresh-green) { background: #00703c; color: white; }
    :global(.fresh-yellow) { background: #ffdd00; color: #0b0c0c; }
    :global(.fresh-red) { background: #d4351c; color: white; }

    /* Map Controls */
    .map-extra-controls {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .map-control-btn {
        width: 44px;
        height: 44px;
        background: white;
        border: none;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .map-control-btn:hover {
        background: #f3f2f1;
        transform: scale(1.05);
    }

    /* Territories toggle specific styles */
    #toggle-territories {
        background: white;
        color: #444;
    }

    #toggle-territories.active {
        background: #62c679; /* green when enabled */
        color: white;
        transform: scale(1.05);
    }

    #toggle-territories svg { stroke: currentColor; }
    #toggle-territories.active svg { stroke: white; }

    /* Dark mode overrides for territories toggle */
    .shop-explorer-container.dark-mode #toggle-territories {
        background: #141423;
        color: #ddd;
    }

    .shop-explorer-container.dark-mode #toggle-territories.active {
        background: #1fbd44;
        border: 1px solid #2da74a;
        color: white;
        transform: scale(1.05);
    }

    .shop-explorer-container.dark-mode #toggle-territories svg { stroke: currentColor; }
    .shop-explorer-container.dark-mode #toggle-territories.active svg { stroke: white; }

    .map-control-btn.active {
        background: #1C70B8;
        color: white;
    }

    /* Territories pane fade transition */
    :global(.territories-pane) {
        transition: opacity 0.35s cubic-bezier(0.2, 0, 0, 1);
        opacity: 0;
    }

    .zoom-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
        background: rgba(0,0,0,0.1);
        padding: 2px;
        border-radius: 10px;
    }

    .shop-explorer-container.dark-mode .zoom-group {
        background: rgba(255,255,255,0.05);
    }

    .zoom-group .map-control-btn {
        box-shadow: none;
    }

    .zoom-group .map-control-btn:first-child {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
    }

    .zoom-group .map-control-btn:last-child {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
    }

    /* Map Info Container */
    .map-info-container {
        position: absolute;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 10px;
    }

    .info-panel {
        width: 480px;
        max-height: 400px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform-origin: bottom right;
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
        display: flex;
        flex-direction: column;
    }

    .info-content {
        padding: 16px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        overflow-y: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }

    /* Ensure CTA box is on the right of the first section on PC */
    .info-content > *:nth-child(1) { grid-area: auto; }
    .info-content > *:nth-child(2) { grid-area: auto; }

    .info-content .info-cta-box {
        margin-top: 0;
        margin-bottom: 0;
    }

    .info-content::-webkit-scrollbar {
        display: none;
    }

    .shop-explorer-container.dark-mode .info-panel {
        background: rgba(24, 24, 35, 0.95);
        border-color: rgba(255, 255, 255, 0.1);
        color: #eee;
    }

    .info-panel.hidden {
        opacity: 0;
        transform: scale(0.9) translateY(10px);
        pointer-events: none;
    }


    .info-section h5 {
        margin: 0 0 8px 0;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #666;
        font-weight: 700;
    }

    .shop-explorer-container.dark-mode .info-section h5 {
        color: #999;
    }

    .info-section p {
        margin: 4px 0;
        font-size: 13px;
        line-height: 1.4;
    }

    .info-section a {
        color: #1C70B8;
        text-decoration: none;
        font-weight: 600;
    }

    .info-section a:hover {
        text-decoration: underline;
    }

    .info-section code {
        background: rgba(0, 0, 0, 0.05);
        padding: 2px 4px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        color: #d4351c;
    }

    .shop-explorer-container.dark-mode .info-section code {
        background: rgba(255, 255, 255, 0.1);
        color: #ff6b6b;
    }

    .info-cta-box {
        margin-top: 4px;
    }

    .modrinth-cta {
        display: block;
        background: #1bd96a;
        color: #111 !important;
        text-align: center;
        padding: 12px 8px;
        border-radius: 12px;
        text-decoration: none !important;
        transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 4px 0 #14a350;
        margin-top: 8px;
    }

    .modrinth-cta:hover {
        background: #22e577;
        transform: translateY(-2px);
        box-shadow: 0 6px 0 #14a350;
    }

    .modrinth-cta:active {
        transform: translateY(1px);
        box-shadow: 0 2px 0 #14a350;
    }

    .cta-title {
        font-weight: 800;
        font-size: 14px;
        margin-bottom: 4px;
    }

    .cta-desc {
        font-size: 11px;
        font-weight: 600;
        line-height: 1.3;
        opacity: 0.9;
    }

    .info-btn {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50% !important;
        background: #1C70B8 !important;
        color: white !important;
        box-shadow: 0 4px 12px rgba(28, 112, 184, 0.4) !important;
    }

    .info-btn:hover {
        transform: scale(1.1) !important;
    }

    /* Coordinate readout panel */
    .coords-panel {
        background: rgba(0,0,0,0.6);
        color: #fff;
        font-family: monospace;
        font-size: 13px;
        padding: 8px 10px;
        border-radius: 8px;
        display: flex;
        gap: 12px;
        align-items: center;
        box-shadow: 0 6px 18px rgba(0,0,0,0.4);
    }
    .coords-item {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .coords-item .label {
        font-weight: 700;
        font-size: 10px;
        opacity: 0.85;
        text-transform: uppercase;
    }
    .coords-item .value {
        font-weight: 800;
        font-size: 13px;
        letter-spacing: 0.02em;
    }

    .map-controls-row {
        display: flex;
        gap: 8px;
        align-items: center;
    }
    /* Desktop: show coords to the left of the info toggle */
    .map-controls-row .coords-panel { order: -1; }

    @media (max-width: 768px) {
        /* Mobile: show coords to the right of the info toggle */
        .map-controls-row .coords-panel { order: 1; }
    }

    @media (max-width: 768px) {
        .map-info-container {
            bottom: calc(50% + 10px);
            left: 10px;
            right: auto;
            align-items: flex-start;
            z-index: 1001;
        }
        .info-panel {
            width: 220px;
            transform-origin: bottom left;
            max-height: 300px;
            overflow-y: auto;
        }
        .info-content {
            grid-template-columns: 1fr;
        }
        .advanced-grid.hidden-mobile {
            display: none;
        }
        .search-panel {
            height: 50% !important;
            bottom: 0 !important;
            left: 0 !important;
            width: 100% !important;
            border-radius: 16px 16px 0 0 !important;
            top: auto !important;
        }
    }

    .donation-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .donation-item span {
        font-size: 13px;
        color: #666;
        font-weight: 500;
    }

    .shop-explorer-container.dark-mode .donation-item span {
        color: #aaa;
    }

    .sortcode {
        font-weight: 800;
        font-size: 13px;
        letter-spacing: 0.05em;
        background: #fff;
        padding: 3px 8px;
        border-radius: 6px;
        color: #d4351c;
        border: 1px solid rgba(212, 53, 28, 0.3);
        font-family: monospace;
        box-shadow: 0 2px 4px rgba(212, 53, 28, 0.1);
    }

    .shop-explorer-container.dark-mode .sortcode {
        background: #1a1a1a;
        color: #ff6b6b;
        border-color: rgba(255, 107, 107, 0.4);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    /* Map */
    .shop-map {
        width: 100%;
        height: 100%;
        background: #1a1a2e;
    }

    /* Fix blurriness on extreme zoom - keep pixels sharp */
    :global(.leaflet-tile) {
        image-rendering: pixelated !important;
        image-rendering: crisp-edges !important;
        -ms-interpolation-mode: nearest-neighbor;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 1100;
        transition: background 0.3s, color 0.3s;
    }

    .shop-explorer-container.dark-mode .loading-overlay {
        background: rgba(18, 18, 18, 0.9);
        color: white;
    }

    .shop-explorer-container.dark-mode .loading-overlay p {
        color: white !important;
    }

    .hidden {
        display: none;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #1C70B8;
        border-radius: 50%;
        animation: spin 1s cubic-bezier(0.4, 0, 0.2, 1) infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* User Location Radar */
    :global(.user-location-radar) {
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        pointer-events: none;
        width: 0 !important;
        height: 0 !important;
    }
    :global(.radar-dot) {
        position: absolute;
        width: 16px;
        height: 16px;
        background: #ff3e00;
        border: 2px solid white;
        border-radius: 50%;
        z-index: 2;
        box-shadow: 0 0 15px rgba(255, 62, 0, 0.8);
    }
    :global(.radar-ring) {
        position: absolute;
        width: 16px;
        height: 16px;
        background: rgba(255, 62, 0, 0.6);
        border-radius: 50%;
        animation: radar-pulse 1.5s infinite cubic-bezier(0.215, 0.61, 0.355, 1);
        z-index: 1;
    }
    @keyframes radar-pulse {
        0% { transform: scale(1); opacity: 0.8; }
        100% { transform: scale(5); opacity: 0; }
    }

    /* Shop Pointer Markers */
    :global(.shop-pointer-marker) {
        will-change: transform;
        z-index: 500;
    }
    :global(.pointer-inner) {
        position: absolute;
        left: 16px;
        top: 12px;
        width: 20px;
        height: 20px;
        background: #1C70B8;
        border: 2px solid white;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        transform-origin: bottom left; /* Keep the tip fixed during scaling */
        box-shadow: 0 2px 6px rgba(0,0,0,0.4);
        transition: background 0.2s, transform 0.2s, box-shadow 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        will-change: transform;
    }
    :global(.pointer-inner::after) {
        content: '';
        width: 6px;
        height: 6px;
        background: white;
        border-radius: 50%;
    }
    :global(.shop-pointer-marker:hover .pointer-inner) {
        background: #FFD700;
        transform: rotate(-45deg) scale(1.3);
        box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
    }

    /* Ping Animation for selected results */
    :global(.ping-animation) {
        z-index: 1000 !important;
    }
    :global(.ping-animation .pointer-inner) {
        background: #FFD700 !important;
        transform: rotate(-45deg) scale(1.2);
        box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }
    :global(.ping-animation .pointer-inner::before) {
        content: '';
        position: absolute;
        inset: -2px;
        border-radius: 50% 50% 50% 0;
        border: 2px solid #FFD700;
        animation: marker-ping 1.5s infinite;
        pointer-events: none;
    }
    @keyframes marker-ping {
        0% { transform: scale(1); opacity: 1; }
        100% { transform: scale(3); opacity: 0; }
    }

    /* Popup Styling - Fixed Overflow and Width */
    :global(.shop-popup) {
        min-width: 150px;
        width: max-content;
        max-width: 750px;
        font-family: "nta", Arial, sans-serif;
        overflow: visible !important;
    }

    :global(.leaflet-popup-content-wrapper) {
        width: max-content !important;
        min-width: 200px;
        max-width: 800px;
        overflow: visible !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
        border-radius: 12px !important;
    }

    :global(.leaflet-popup-content) {
        width: auto !important;
        margin: 12px 16px !important;
        max-width: none !important;
        overflow: visible !important;
    }

    :global(.leaflet-popup) {
        overflow: visible !important;
    }

    :global(.shop-popup h3) {
        margin: 0 0 12px 0;
        font-size: 16px;
        font-weight: 700;
        border-bottom: 2px solid #f3f2f1;
        padding-bottom: 8px;
        color: #0b0c0c;
    }

    :global(.exchanges-list) {
        max-height: 200px;
        overflow-y: auto;
        overflow-x: visible;
        padding: 4px;
        margin: -4px;
    }

    :global(.exchange-row) {
        display: flex;
        justify-content: flex-start;
        align-items: center;
        padding: 8px 4px;
        font-size: 13px;
        border-bottom: 1px solid #f3f2f1;
        gap: 8px;
    }

    :global(.exchange-row:last-child) {
        border-bottom: none;
    }

    :global(.exchange-item-bundle) {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 0;
        overflow: visible;
    }

    :global(.exchange-item-bundle.output) {
        justify-content: flex-end;
        text-align: right;
    }

    :global(.popup-item-icon) {
        width: 22px;
        height: 22px;
        image-rendering: pixelated;
        flex-shrink: 0;
    }

    :global(.exchange-price), :global(.exchange-output) {
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        padding: 8px 8px !important;
        border-radius: 8px !important;
        line-height: 1 !important;
        min-width: 0 !important;
        overflow: hidden !important;
        white-space: nowrap !important;
        flex-shrink: 0;
    }

    :global(.exchange-price), :global(.exchange-output) {
        font-weight: 700;
        color: #1C70B8;
        background: #f0f7ff;
        border: 1px solid rgba(28, 112, 184, 0.1);
    }

    :global(.exchange-price .count), :global(.exchange-output .count) {
        white-space: nowrap;
        font-weight: 800;
        opacity: 0.9;
        position: relative;
        top: 0px; /* Fix slight downward shift */
    }

    :global(.exchange-price .name), :global(.exchange-output .name) {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
        max-width: 300px;
        min-width: 0;
    }


    :global(.exchange-arrow) {
        color: #999;
        font-weight: bold;
        margin: 0 4px;
    }

    @media (max-width: 768px) {
        .search-panel {
            width: calc(100% - 20px);
            height: 40%;
            top: auto;
            left: 10px;
            bottom: 10px;
        }
        
        .map-extra-controls {
            top: 10px;
            right: 10px;
        }

        .side-by-side {
            gap: 10px;
        }
        
        :global(.shop-popup) {
            min-width: 260px;
        }
        :global(.exchange-price .name), :global(.exchange-output .name) {
            max-width: 100px;
        }
    }
</style>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>


<script is:inline define:vars={{ BASE, ITEM_MAPPINGS }}>

    // --- Configuration ---
    const MC_VERSION = '1.21.8';

    /**
     * Item Mapping System
     * Use this to map Tradex material IDs to specific filenames on mc.nerothe.com
     */
    // Make ITEM_MAPPINGS available globally for icon URL functions
    window.ITEM_MAPPINGS = ITEM_MAPPINGS;

    /**
     * Legacy Fallback Overrides
     * Used for PrismarineJS assets when Nerothe fails
     */
    const ICON_OVERRIDES = {
        'barrel': 'blocks/barrel_side.png',
        'reinforced_deepslate': 'blocks/reinforced_deepslate_top.png',
        'beehive': 'blocks/beehive_front.png',
        'bee_nest': 'blocks/bee_nest_front.png',
        'blast_furnace': 'blocks/blast_furnace_front.png',
        'furnace': 'blocks/furnace_front.png',
        'smoker': 'blocks/smoker_front.png',
        'dispenser': 'blocks/dispenser_front.png',
        'dropper': 'blocks/dropper_front.png',
        'observer': 'blocks/observer_front.png',
        'crafter': 'blocks/crafter_top.png'
    };

    /**
     * Get Primary Icon URL (Nerothe)
     */
    window.getItemIconUrl = function(material) {
        if (!material) return '';
        let mat = material.toLowerCase().replace(/ /g, '_').replace(/minecraft:/, '');
        // Ensure material is safe for use in URLs (encode any unexpected characters)
        const safeMat = encodeURIComponent(mat);
        
        // Use mappings from window.ITEM_MAPPINGS if available (runtime lookup)
        if (window.ITEM_MAPPINGS && window.ITEM_MAPPINGS[mat]) {
            mat = window.ITEM_MAPPINGS[mat];
        }

        return `https://mc.nerothe.com/img/${MC_VERSION}/minecraft_${safeMat}.png`;
    };

    /**
     * Get Fallback Icon URL (PrismarineJS)
     */
    window.getFallbackIconUrl = function(material) {
        if (!material) return '';
        let mat = material.toLowerCase().replace(/ /g, '_').replace(/minecraft:/, '');
        const safeMat = encodeURIComponent(mat);
        
        // Use mappings from window.ITEM_MAPPINGS if available (runtime lookup)
        if (window.ITEM_MAPPINGS && window.ITEM_MAPPINGS[mat]) {
            mat = window.ITEM_MAPPINGS[mat];
        }

        if (ICON_OVERRIDES[mat]) {
            return `https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/${MC_VERSION}/${ICON_OVERRIDES[mat]}`;
        }
        return `https://raw.githubusercontent.com/PrismarineJS/minecraft-assets/master/data/${MC_VERSION}/items/${safeMat}.png`;
    };

    // Generic onerror handler for item images to avoid embedding dynamic values into inline JS
    window.handleItemImageError = function() {
        try {
            if (!this.dataset) return;
            const mat = this.dataset.material || '';
            if (!this.dataset.triedFallback) {
                this.dataset.triedFallback = 'true';
                this.src = window.getFallbackIconUrl(mat);
                return;
            }
            if (!this.dataset.triedBlock) {
                this.dataset.triedBlock = 'true';
                this.src = this.src.replace('/items/', '/blocks/');
                return;
            }
            this.style.opacity = '0';
        } catch (e) {
            // silent
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        // --- Map Initialization ---
        const map = L.map('shop-map', {
            crs: L.CRS.Simple,
            minZoom: -5,
            maxZoom: 6,
            zoomSnap: 1, // Fix mismatch by using integer zoom levels
            attributionControl: false,
            zoomControl: false,
            bounceAtZoomLimits: false
        });

        const ICENIA_CITY_COORDS = [4380, -3850]; 

        function getVisualCenter() {
            // Get the current visual center by reversing the offset
            const isMobile = window.innerWidth <= 768;
            const currentCenter = map.getCenter();
            const currentZoom = map.getZoom();
            const point = map.project(currentCenter, currentZoom);
            let visualPoint;
            if (isMobile) {
                // Reverse the mobile offset
                visualPoint = point.subtract([0, window.innerHeight * 0.14]);
            } else {
                // Reverse the desktop offset
                visualPoint = point.add([190, 0]);
            }
            return map.unproject(visualPoint, currentZoom);
        }

        function flyToWithOffset(latlng, zoom, options = {}) {
            const isMobile = window.innerWidth <= 768;
            const point = map.project(latlng, zoom);
            let offsetPoint;
            if (isMobile) {
                offsetPoint = point.add([0, window.innerHeight * 0.14]);
            } else {
                // Shift map right by 190px to center visually (accounting for search panel)
                offsetPoint = point.subtract([190, 0]);
            }
            const offsetLatLng = map.unproject(offsetPoint, zoom);
            map.flyTo(offsetLatLng, zoom, { 
                duration: 0.6,
                easeLinearity: 0.25,
                ...options 
            });
        }

        map.zoomIn = function(delta, options) {
            const visualCenter = getVisualCenter();
            const zoom = map.getZoom() + (delta || 1);
            flyToWithOffset(visualCenter, zoom, options);
            return this;
        };

        map.zoomOut = function(delta, options) {
            const visualCenter = getVisualCenter();
            const zoom = map.getZoom() - (delta || 1);
            flyToWithOffset(visualCenter, zoom, options);
            return this;
        };

        const initialPoint = map.project(ICENIA_CITY_COORDS, 0);
        const isMobileInitial = window.innerWidth <= 768;
        const initialOffsetPoint = isMobileInitial 
            ? initialPoint.add([0, window.innerHeight * 0.14]) 
            : initialPoint.subtract([190, 0]);
        map.setView(map.unproject(initialOffsetPoint, 0), 0);

        const localTiles = BASE + 'tiles/terrain/z{z}/{x},{y}.png';
        const primaryTiles = 'https://civmc-map.duckdns.org/tiles/terrain/z{z}/{x},{y}.png';

        // Standard tile loading. Leaflet handles integer zoom levels for tiles automatically.
        const tiles = L.tileLayer(localTiles, {
            minZoom: -5,
            maxZoom: 6,
            maxNativeZoom: 0,
            minNativeZoom: -5,
            tileSize: 256,
            noWrap: true,
            updateWhenIdle: true,
            updateWhenZooming: true, // Allow updates during zoom for better syncing
            keepBuffer: 3
        }).addTo(map);

        // Fallback to primary server if local tiles fail
        tiles.on('tileerror', function(error) {
            if (this._url === localTiles) {
                console.log('Local tiles not found, trying primary server...');
                this.setUrl(primaryTiles);
            }
        });

        // --- Configuration ---
        // Change this value to adjust how close the map zooms when clicking a result (higher = closer)
        const DEFAULT_CLICK_ZOOM = 3;

        // --- State ---
        let markers = [];
        let userLocation = null;
        let userMarker = null;
        let activeMarker = null;
        let activeCard = null;
        let isSettingLocation = false;
        let isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const markerGroup = L.layerGroup().addTo(map);
        // Territory overlay state and loader
        let territoryLayer = null;
        let territoryGeoJson = null;
        const TERRITORY_URL = 'https://civmc-map.github.io/territories-thejmqn.json';

        function mcCoordToLatLngPair(coord) {
            // coord expected as [x, z]
            const x = Number(coord[0]);
            const z = Number(coord[1]);
            // For GeoJSON we must return coordinates in [lng, lat] order.
            // Leaflet's GeoJSON expects [lng, lat] (GeoJSON standard),
            // while mcToLatLng() returns [lat, lng] for Leaflet marker usage.
            return [x + 0.5, -(z + 0.5)];
        }

        function transformGeometryCoords(geom) {
            if (!geom) return geom;
            const type = geom.type;
            if (type === 'Point') {
                return { type: 'Point', coordinates: mcCoordToLatLngPair(geom.coordinates) };
            }
            if (type === 'MultiPoint' || type === 'LineString') {
                return { type: type, coordinates: geom.coordinates.map(c => mcCoordToLatLngPair(c)) };
            }
            if (type === 'MultiLineString' || type === 'Polygon') {
                return { type: type, coordinates: geom.coordinates.map(ring => ring.map(c => mcCoordToLatLngPair(c))) };
            }
            if (type === 'MultiPolygon') {
                return { type: type, coordinates: geom.coordinates.map(poly => poly.map(ring => ring.map(c => mcCoordToLatLngPair(c)))) };
            }
            if (type === 'GeometryCollection') {
                return { type: type, geometries: geom.geometries.map(g => transformGeometryCoords(g)) };
            }
            return geom;
        }

        function transformGeoJSONCoordinates(obj) {
            if (!obj) return obj;
            const out = JSON.parse(JSON.stringify(obj));
            if (out.type === 'FeatureCollection' && Array.isArray(out.features)) {
                out.features = out.features.map(f => {
                    if (f.geometry) f.geometry = transformGeometryCoords(f.geometry);
                    return f;
                });
            } else if (out.type === 'Feature' && out.geometry) {
                out.geometry = transformGeometryCoords(out.geometry);
            } else if (out.type && out.coordinates) {
                out.geometry = transformGeometryCoords(out);
            }
            return out;
        }

        async function loadTerritoriesGeoJSON() {
            if (territoryGeoJson) return territoryGeoJson;
            try {
                const res = await fetch(TERRITORY_URL);
                if (!res.ok) throw new Error('Failed to fetch territories');
                const json = await res.json();
                // Detect if coordinates look like game coords (large integers). If so, transform them.
                let sampleCoord = null;
                try {
                    if (json.type === 'FeatureCollection' && json.features && json.features.length) {
                        const geom = json.features[0].geometry;
                        if (geom && geom.coordinates) {
                            // drill into first numeric coordinate
                            const coords = JSON.stringify(geom.coordinates);
                            const nums = coords.match(/-?\d+(?:\.\d+)?/g);
                            if (nums && nums.length >= 2) sampleCoord = [Number(nums[0]), Number(nums[1])];
                        }
                    }
                } catch (e) { /* ignore */ }

                if (sampleCoord && (Math.abs(sampleCoord[0]) > 100 || Math.abs(sampleCoord[1]) > 100)) {
                    territoryGeoJson = transformGeoJSONCoordinates(json);
                } else {
                    territoryGeoJson = json;
                }
                return territoryGeoJson;
            } catch (e) {
                console.warn('Could not load territory GeoJSON:', e);
                throw e;
            }
        }

        function ensureTerritoriesPane() {
            const paneName = 'territoriesPane';
            if (!map.getPane(paneName)) {
                const p = map.createPane(paneName);
                // Place above tiles (tilePane zIndex 200) and below markers (markerPane ~600)
                // Increase slightly to ensure visibility above tile layer.
                p.style.zIndex = 450;
                p.style.pointerEvents = 'none';
                // Add a stable classname we can target for CSS transitions
                p.classList.add('territories-pane');
                // Ensure starting opacity is zero (hidden) so we can fade in
                p.style.opacity = 0;
                // Ensure a transition is present on the pane element itself so
                // opacity changes animate even if component-scoped CSS doesn't apply.
                p.style.transition = 'opacity 0.35s cubic-bezier(0.2, 0, 0, 1)';
            }
            return paneName;
        }

        function applyTerritoriesLayer(geojson) {
            try {
                if (territoryLayer) {
                    map.removeLayer(territoryLayer);
                    territoryLayer = null;
                }

                const pane = ensureTerritoriesPane();

                // Support two territory formats:
                // 1) Our custom descriptor that contains a `map_image` entry
                //    with `url` and `bounds` specified in MC coords [[x1,z1],[x2,z2]].
                // 2) Standard GeoJSON usable by L.geoJSON.
                if (geojson && Array.isArray(geojson.features) && geojson.features.length && geojson.features[0].map_image && geojson.features[0].map_image.url) {
                    try {
                        const mi = geojson.features[0].map_image;
                        const url = mi.url;
                        const b = mi.bounds; // [[x1,z1],[x2,z2]]
                        if (url && Array.isArray(b) && b.length >= 2) {
                            const p1 = b[0];
                            const p2 = b[1];
                            const ll1 = mcToLatLng(p1[0], p1[1]); // [lat, lng]
                            const ll2 = mcToLatLng(p2[0], p2[1]);
                            // Leaflet expects bounds as [[southWestLat, southWestLng], [northEastLat, northEastLng]]
                            const southLat = Math.min(ll1[0], ll2[0]);
                            const northLat = Math.max(ll1[0], ll2[0]);
                            const westLng = Math.min(ll1[1], ll2[1]);
                            const eastLng = Math.max(ll1[1], ll2[1]);
                            const imageBounds = [[southLat, westLng], [northLat, eastLng]];
                            territoryLayer = L.imageOverlay(url, imageBounds, { pane: pane, interactive: false, opacity: 0 }).addTo(map);
                            // Fade in the overlay by increasing the pane opacity (CSS) and image opacity
                            // Small timeout to ensure element is attached
                            setTimeout(() => {
                                try {
                                    // imageOverlay provides setOpacity
                                    if (territoryLayer && typeof territoryLayer.setOpacity === 'function') territoryLayer.setOpacity(1);
                                    const paneEl = map.getPane(pane);
                                    if (paneEl) paneEl.style.opacity = 1;
                                } catch (e) {}
                            }, 20);
                        }
                    } catch (e) {
                        console.warn('Failed to apply map_image overlay', e);
                    }
                } else {
                    // Start with zero opacity styles so we can animate them in
                    territoryLayer = L.geoJSON(geojson, {
                        pane: pane,
                        style: function (feature) {
                            return {
                                color: '#1C70B8',
                                weight: 1,
                                opacity: 0,
                                fillColor: '#1C70B8',
                                fillOpacity: 0
                            };
                        }
                    }).addTo(map);
                    // Fade in vector layer styles
                    setTimeout(() => {
                        try {
                            if (territoryLayer && territoryLayer.setStyle) {
                                territoryLayer.setStyle({ opacity: 0.9, fillOpacity: 0.08 });
                            }
                            const paneEl = map.getPane(pane);
                            if (paneEl) paneEl.style.opacity = 1;
                        } catch (e) {}
                    }, 20);
                }

                // Ensure tiles remain at the back and markers stay above territories
                try { if (tiles && tiles.bringToBack) tiles.bringToBack(); } catch (e) {}
                try { if (markerGroup && markerGroup.bringToFront) markerGroup.bringToFront(); } catch (e) {}
            } catch (e) {
                console.warn('Failed to apply territories layer', e);
            }
        }

        async function toggleTerritories(enabled) {
            const savedKey = 'shop_show_territories';
            try {
                if (enabled) {
                    const geo = await loadTerritoriesGeoJSON();
                    applyTerritoriesLayer(geo);
                    localStorage.setItem(savedKey, '1');
                } else {
                    if (territoryLayer) {
                        // Fade out by changing the pane opacity only; don't set
                        // the layer's own opacity immediately (that hides instantly).
                        try {
                            const paneEl = map.getPane('territoriesPane');
                            if (paneEl) paneEl.style.opacity = 0;
                        } catch (e) {}
                        // Wait for transition to finish before removing the layer
                        setTimeout(() => {
                            try { if (territoryLayer) map.removeLayer(territoryLayer); } catch (e) {}
                            territoryLayer = null;
                        }, 380);
                    }
                    localStorage.removeItem(savedKey);
                }
            } catch (e) {
                // On error, reset active state on the toggle button
                const btn = document.getElementById('toggle-territories');
                if (btn) {
                    btn.classList.remove('active');
                    try { btn.setAttribute('aria-pressed', 'false'); btn.title = 'Show Territories'; } catch (err) {}
                }
            }
        }
        
        let lastExchanges = [];
        let lastQueryLabel = "";

        // --- UI Elements ---
        const searchInput = document.getElementById('item-search');
        const searchButton = document.getElementById('search-button');
        const sortModeSelect = document.getElementById('sort-mode');
        const allowUnstockedCheckbox = document.getElementById('allow-unstocked');
        const iceniaOnlyCheckbox = document.getElementById('icenia-only');
        const resultsContainer = document.getElementById('results-container');
        const loadingOverlay = document.getElementById('loading-overlay');
        const centerIceniaBtn = document.getElementById('center-icenia');
        const setLocationBtn = document.getElementById('set-location');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const cursorCoordsEl = document.getElementById('cursor-coords');
        const pinCoordsEl = document.getElementById('pin-coords');

        const ICENIA_CITY_BOUNDS = {
            minX: -4300,
            maxX: -3500,
            minZ: -4900,
            maxZ: -3900
        };

        function mcToLatLng(x, z) {
            // Center on the block by adding 0.5
            return [-(z + 0.5), x + 0.5];
        }

        function prettyMaterialName(material) {
            if (!material) return '';
            const base = material.toLowerCase().replace(/minecraft:/, '').replace(/_/g, ' ');
            return base.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        // Escape HTML but preserve Minecraft section sign (¬ß) and formatting codes
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;');
        }

        function formatItemName(item) {
            const pretty = prettyMaterialName(item.material || '');
            if (item.customName) {
                // Strip Minecraft color codes for the display name
                const cleanCustom = item.customName.replace(/¬ß[0-9a-fk-or]/g, '');
                const safeCustom = escapeHtml(cleanCustom);
                return `${safeCustom} (${pretty})`;
            }
            return pretty;
        }

        function formatLoreText(item) {
            // Build tooltip text using Minecraft formatting codes (¬ß)
            if (!item) return '';
            const lines = [];

            // Helper: pretty name from material id
            const baseName = prettyMaterialName(item.material || '');

            // Detect compacted (same heuristic as formatCount)
            const loreText = item && item.lore ? (Array.isArray(item.lore) ? item.lore.join(' ') : String(item.lore)) : '';
            const loreCompacted = (loreText.toLowerCase().includes('compacted')) ||
                                  (item && item.material && item.material.toLowerCase().includes('compacted'));

            // 1) Title: custom name (italic) or base name (not italic) ‚Äî both in aqua (¬ßb)
            if (item.customName) {
                // Escape any HTML in custom names while preserving ¬ß codes
                lines.push(`¬ßb¬ßo${escapeHtml(item.customName)}`);
            } else if (baseName) {
                lines.push(`¬ßb${baseName}`);
            }

            // 2) Compacted indicator (dark purple ¬ß5, italic)
            // 6) Lore with the lore's own formatting.
            // If lore contains "Compacted Item" make that line ¬ß5¬ßo,
            // other lore lines keep their formatting if present, otherwise render as gold (¬ß6).
            if (item.lore) {
                const loreLines = Array.isArray(item.lore) ? item.lore : [String(item.lore)];
                loreLines.forEach(l => {
                    if (!l) return;
                        const plain = String(l).trim();
                    if (/compacted item/i.test(plain)) {
                        // Force the compacted indicator styling
                        lines.push(`¬ß5¬ßoCompacted Item`);
                    } else {
                        // If the lore line already includes Minecraft formatting codes, preserve it.
                            if (/¬ß[0-9a-fk-or]/i.test(plain)) {
                                // Preserve provided formatting codes but escape stray HTML
                                lines.push( plain.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;') );
                            } else {
                                // Otherwise render as gold normal text (escape HTML)
                                lines.push(`¬ß6${escapeHtml(plain)}`);
                            }
                    }
                });
            }

            // 3) Repair level: Only show for items that appear to have durability (tools/armor)
            const isDurable = (() => {
                if (!item) return false;
                // Explicit durability fields from API
                if (item.maxDurability || item.durability || item.repairable) return true;
                // Fallback heuristic based on material name
                const mat = (item.material || '').toString().toLowerCase();
                const durableKeywords = [
                    'helmet','chestplate','leggings','boots',
                    'sword','pickaxe','axe','shovel','hoe',
                    'trident','bow','crossbow','shield','elytra',
                    'fishing_rod','shears','flint_and_steel'
                ];
                return durableKeywords.some(k => mat.includes(k));
            })();
            const repairVal = isDurable ? (item.repairLevel ?? item.repair) : undefined;
            if (repairVal !== undefined && repairVal !== null) {
                lines.push(`¬ßb${repairVal} levels to repair`);
            }

            // 4) Enchantments in gray (¬ß7) ‚Äî aggregate enchants from various sources
            const collectEnchants = (sources) => {
                const out = [];
                for (const src of sources) {
                    const map = item[src];
                    if (!map) continue;
                    for (const [k, v] of Object.entries(map)) {
                        let name = k.toString().toLowerCase();
                        if (name.startsWith('minecraft:')) name = name.slice('minecraft:'.length);
                        name = name.replace(/_/g, ' ');
                        name = name.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                        out.push(`${name} ${v}`);
                    }
                }
                return out;
            };
            const enchList = collectEnchants(['enchants', 'storedEnchants', 'requiredEnchants']);
            if (enchList.length > 0) {
                for (const ench of enchList) { // Special case: if the enchant has only 1 possible level, show as EnchantName instead of EnchantName 1
                    const singleLevelEnchants = ['Aqua Affinity', 'Channeling', 'Curse of Binding', 'Curse of Vanishing', 'Flame', 'Infinity', 'Mending', 'Multishot', 'Silk Touch'];
                
                    lines.push(`¬ß7${singleLevelEnchants.includes(ench.replace(' 1', '')) ? ench.replace(' 1', '') : ench}`);
                }
                // lines.push(`¬ß7${enchList.join(', ')}`);
            }

            // 5) Condition in white (¬ßf)
            if (item.condition !== undefined && item.condition !== null) {
                lines.push(`¬ßfCondition: ${item.condition}`);
            }

            // 7) Blank line separator
            lines.push('');

            // 8) Other information: unlisted/forbidden/excluded enchants ‚Äî only for enchantable items
            const isEnchantable = (() => {
                if (!item) return false;
                // Primary rule: enchantable if item appears durable (tools/armor/weapons)
                if (isDurable) return true;
                // Fallback: treat as enchantable only if the enchant maps/arrays are present and non-empty
                const hasEnchants = (obj) => {
                    if (!obj) return false;
                    if (Array.isArray(obj)) return obj.length > 0;
                    if (typeof obj === 'object') return Object.keys(obj).length > 0;
                    return false;
                };
                if (hasEnchants(item.enchants) || hasEnchants(item.storedEnchants) || hasEnchants(item.requiredEnchants)) return true;
                return false;
            })();

            if (isEnchantable) {
                if (item.unlistedEnchantsAllowed === false) {
                    lines.push(`¬ß7Unlisted Enchants: ¬ßcForbidden`);
                } else if (item.unlistedEnchantsAllowed === true) {
                    lines.push(`¬ß7Unlisted Enchants: ¬ßaAllowed`);
                }

                // 9) Excluded enchants summary (if present), show in gray with red bullets
                if (item.excludedEnchants && item.excludedEnchants.length > 0) {
                    const ex = item.excludedEnchants.map(e => {
                        let n = e.toString().replace('minecraft:', '').replace(/_/g, ' ');
                        n = n.split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                        return `¬ßc- ${n}`;
                    }).join('\n');
                    lines.push(`¬ß7Excluded Enchants:`);
                    lines.push(ex);
                }
            }

            return lines.join('\n').trim();
        }

        function renderMinecraftText(text) {
            if (!text) return '';
            // Escape raw text to prevent HTML injection when this function's output
            // is assigned to innerHTML. We preserve ¬ß codes and newlines; other
            // special characters are escaped here.
            text = String(text)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;');
            
            const codes = {
                '0': 'mc-0', '1': 'mc-1', '2': 'mc-2', '3': 'mc-3',
                '4': 'mc-4', '5': 'mc-5', '6': 'mc-6', '7': 'mc-7',
                '8': 'mc-8', '9': 'mc-9', 'a': 'mc-a', 'b': 'mc-b',
                'c': 'mc-c', 'd': 'mc-d', 'e': 'mc-e', 'f': 'mc-f',
                'l': 'mc-l', 'm': 'mc-m', 'n': 'mc-n', 'o': 'mc-o',
                'k': 'mc-k', 'r': 'mc-r'
            };

            let html = '';
            let currentClasses = new Set();
            let i = 0;

            while (i < text.length) {
                if (text[i] === '¬ß' && i + 1 < text.length) {
                    const code = text[i + 1].toLowerCase();
                    if (codes[code]) {
                        if (code === 'r') {
                            currentClasses.clear();
                        } else if (['l', 'm', 'n', 'o', 'k'].includes(code)) {
                            currentClasses.add(codes[code]);
                        } else {
                            // In Minecraft, color codes reset all formatting codes
                            currentClasses.forEach(cls => {
                                if (['mc-l', 'mc-m', 'mc-n', 'mc-o', 'mc-k'].includes(cls)) {
                                    currentClasses.delete(cls);
                                }
                            });
                            // Also remove any previous color
                            currentClasses.forEach(cls => {
                                if (cls.startsWith('mc-') && !['l', 'm', 'n', 'o', 'k', 'r'].includes(cls.slice(3))) {
                                    currentClasses.delete(cls);
                                }
                            });
                            currentClasses.add(codes[code]);
                        }
                        i += 2;
                        continue;
                    }
                }

                if (text[i] === '\n') {
                    html += '<br>';
                } else {
                    const char = text[i];
                    if (currentClasses.size > 0) {
                        // For obfuscated text, we replace the character with a random one
                        if (currentClasses.has('mc-k')) {
                            html += `<span class="${Array.from(currentClasses).join(' ')}">?</span>`;
                        } else {
                                html += `<span class="${Array.from(currentClasses).join(' ')}">${char}</span>`;
                        }
                    } else {
                            html += char;
                    }
                }
                i++;
            }
            return html;
        }

        function formatTimeAgo(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 48) return `${hours}h ago`;
            // Show days with one decimal place (e.g. "2.7d ago")
            const daysFloat = ms / (1000 * 60 * 60 * 24);
            if (daysFloat < 30) return `${daysFloat.toFixed(1)}d ago`;
            const months = Math.floor(daysFloat / 30);
            return `${months}mo ago`;
        }

        function formatCount(count, item) {
            let loreText = '';
            if (item && item.lore) {
                loreText = Array.isArray(item.lore) ? item.lore.join(' ') : String(item.lore);
            }
            
            const loreCompacted = (loreText.toLowerCase().includes('compacted')) ||
                                 (item && item.material && item.material.toLowerCase().includes('compacted'));
            
            if (loreCompacted) {
                return { text: `${count}ci`, isCompacted: true };
            }
            
            if (count > 0 && count % 64 === 0) {
                return { text: `${count / 64}ci`, isCompacted: true };
            }
            
            return { text: `${count}`, isCompacted: false };
        }

        const ENCHANTMENTS = [
            "Mending", "Unbreaking", "Efficiency", "Silk Touch", "Fortune",
            "Protection", "Fire Protection", "Blast Protection", "Projectile Protection", "Thorns",
            "Respiration", "Aqua Affinity", "Swift Sneak", "Depth Strider", "Feather Falling", "Frost Walker", "Soul Speed",
            "Smite", "Bane of Arthropods", "Knockback", "Fire Aspect", "Looting", "Sharpness", "Sweeping Edge", 
            "Channeling", "Riptide", "Impaling", "Loyalty",
            "Power", "Punch", "Flame", "Infinity", 
            "Luck of the Sea", "Lure",
            "Curse of Vanishing", "Curse of Binding"
        ].sort();

        function createEnchantFilterRow() {
            const row = document.createElement('div');
            row.className = 'enchant-filter-row';
            
            let options = '<option value="">Any Enchantment</option>';
            ENCHANTMENTS.forEach(e => {
                options += `<option value="${e.toLowerCase().replace(/ /g, '_')}">${e}</option>`;
            });

            row.innerHTML = `
                <select class="govuk-select enchant-name-select">
                    ${options}
                </select>
                <input class="govuk-input enchant-level-input" type="number" placeholder="Lvl" min="1" max="10">
                <button type="button" class="remove-enchant-btn" title="Remove filter">√ó</button>
            `;

            row.querySelector('.enchant-name-select').addEventListener('change', () => applyFiltersAndDisplay());
            row.querySelector('.enchant-level-input').addEventListener('input', () => applyFiltersAndDisplay());
            row.querySelector('.remove-enchant-btn').addEventListener('click', () => {
                row.remove();
                applyFiltersAndDisplay();
            });

            return row;
        }

        document.getElementById('add-enchant-filter').addEventListener('click', () => {
            document.getElementById('enchantment-filters-list').appendChild(createEnchantFilterRow());
        });

        async function performSearch(isIceniaOnly = false) {
            const outputQuery = searchInput.value.trim();
            const inputQuery = document.getElementById('input-search').value.trim();
            const updatedAfterSelect = document.getElementById('updated-after');
            
            // If isIceniaOnly is true (from button), we force the checkbox and fetch
            if (isIceniaOnly) {
                iceniaOnlyCheckbox.checked = true;
            }
            
            const limit = isIceniaOnly ? 1000 : 100;
            
            if (!outputQuery && !inputQuery && !isIceniaOnly) return;

            loadingOverlay.classList.remove('hidden');
            
            try {
                const searchParams = {
                    limit: limit,
                    allowUnstocked: isIceniaOnly ? true : allowUnstockedCheckbox.checked,
                    sortMode: isIceniaOnly ? 'closest' : sortModeSelect.value
                };

                // Search Bypass Logic: If searching for custom items known to be barrels or player heads, search for the base material
                let apiOutputQuery = outputQuery;
                const lowerOutputQuery = outputQuery.toLowerCase();
                if (lowerOutputQuery.includes('repair kit') || lowerOutputQuery.includes('dropbox') || lowerOutputQuery.includes('compactor') || lowerOutputQuery.includes('smelter')) {
                    apiOutputQuery = 'barrel';
                } else if (lowerOutputQuery.includes('head')) {
                    apiOutputQuery = 'player_head';
                } else if (lowerOutputQuery.includes('essence')) {
                    apiOutputQuery = 'eye_of_ender';
                }

                let apiInputQuery = inputQuery;
                const lowerInputQuery = inputQuery.toLowerCase();
                if (lowerInputQuery.includes('repair kit') || lowerInputQuery.includes('dropbox') || lowerInputQuery.includes('compactor') || lowerInputQuery.includes('smelter')) {
                    apiInputQuery = 'barrel';
                } else if (lowerInputQuery.includes('head')) {
                    apiInputQuery = 'player_head';
                } else if (lowerInputQuery.includes('essence')) {
                    apiInputQuery = 'eye_of_ender';
                }

                if (apiOutputQuery) searchParams.output = apiOutputQuery;
                if (apiInputQuery) searchParams.input = apiInputQuery;
                
                const updatedAfterMs = parseInt(updatedAfterSelect.value);
                if (updatedAfterMs > 0) {
                    searchParams.updatedAfter = Date.now() - updatedAfterMs;
                }

                if (sortModeSelect.value === 'closest' || isIceniaOnly) {
                    const pos = userLocation || { x: -3900, z: -4400 };
                    searchParams.pos = {
                        x: Math.round(pos.x),
                        y: 64,
                        z: Math.round(pos.z),
                        world: "overworld"
                    };
                }

                const TARGET_URL = 'https://api.tradex.civinfo.net/exchanges/search';
                
                // List of proxies to try in order. 
                // We include the self-hosted worker as the first backup for speed and reliability.
                const PROXIES = [
                    { name: 'Direct API', url: TARGET_URL },
                    { name: 'AllOrigins (Raw)', url: 'https://api.allorigins.win/raw?url=' + encodeURIComponent(TARGET_URL) },
                    { name: 'YaCDN', url: 'https://yacdn.org/proxy/' + TARGET_URL },
                    { name: 'HTMLDriven', url: 'https://cors-anywhere.htmldriven.com/?url=' + TARGET_URL },
                    { name: 'CodeTabs', url: 'https://api.codetabs.com/v1/proxy?quest=' + encodeURIComponent(TARGET_URL) },
                    { name: 'CORSProxy.io', url: 'https://corsproxy.io/?' + encodeURIComponent(TARGET_URL) },
                    { name: 'ThingProxy', url: 'https://thingproxy.freeboard.io/fetch/' + TARGET_URL },
                    { name: 'AllOrigins (JSON)', url: 'https://api.allorigins.win/get?url=' + encodeURIComponent(TARGET_URL) },
                    { name: 'CORS Bridged', url: 'https://cors.bridged.cc/' + TARGET_URL }
                ];
                
                async function tryFetch(proxy, attemptIndex) {
                    console.log(`Attempting search via ${proxy.name}...`);
                    const isAllOriginsJson = proxy.url.includes('allorigins.win/get');
                    
                    const controller = new AbortController();
                    // Use shorter timeout for first few attempts to speed up fallback, 
                    // but keep 8s for later ones as Tradex can be slow.
                    const timeoutMs = attemptIndex < 2 ? 5000 : 8000;
                    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

                    try {
                        const res = await fetch(proxy.url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(searchParams),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!res.ok) throw new Error(`${proxy.name} returned status ${res.status}`);
                        
                        const text = await res.text();
                        
                        try {
                            let json = JSON.parse(text);
                            // AllOrigins /get wraps the response in a JSON object with a 'contents' field
                            if (isAllOriginsJson && json.contents) {
                                json = JSON.parse(json.contents);
                            }
                            
                            if (json && (json.exchanges || Array.isArray(json))) {
                                return json;
                            }
                            throw new Error('Invalid JSON structure');
                        } catch (e) {
                            throw new Error(`${proxy.name} response was not valid JSON`);
                        }
                    } catch (e) {
                        clearTimeout(timeoutId);
                        throw e;
                    }
                }

                let data = null;
                let lastError = null;

                for (let i = 0; i < PROXIES.length; i++) {
                    const proxy = PROXIES[i];
                    try {
                        data = await tryFetch(proxy, i);
                        if (data) break;
                    } catch (e) {
                        console.warn(`${proxy.name} failed:`, e.message);
                        lastError = e;
                        continue; // Try next proxy
                    }
                }

                if (!data) {
                    console.error('All search methods failed');
                    throw new Error(lastError ? `Search failed: ${lastError.message}` : 'Search failed. All proxies are currently unavailable.');
                }
                let exchanges = data.exchanges || [];

                // Client-side filtering for better accuracy (Fixes "golden carrot" issue and supports custom names/lore)
                // Uses a multi-word match: all words in the query must appear in the item's metadata
                if (outputQuery) {
                    const words = outputQuery.toLowerCase().split(/\s+/).filter(w => w.length > 0);
                    exchanges = exchanges.filter(ex => {
                        const material = (ex.output.material || '').toLowerCase().replace(/_/g, ' ');
                        const customName = (ex.output.customName || '').toLowerCase();
                        const lore = (Array.isArray(ex.output.lore) ? ex.output.lore.join(' ') : String(ex.output.lore || '')).toLowerCase();
                        const combined = `${material} ${customName} ${lore}`;
                        
                        return words.every(word => combined.includes(word));
                    });
                }
                if (inputQuery) {
                    const words = inputQuery.toLowerCase().split(/\s+/).filter(w => w.length > 0);
                    exchanges = exchanges.filter(ex => {
                        const material = (ex.input.material || '').toLowerCase().replace(/_/g, ' ');
                        const customName = (ex.input.customName || '').toLowerCase();
                        const lore = (Array.isArray(ex.input.lore) ? ex.input.lore.join(' ') : String(ex.input.lore || '')).toLowerCase();
                        const combined = `${material} ${customName} ${lore}`;
                        
                        return words.every(word => combined.includes(word));
                    });
                }

                lastExchanges = exchanges;
                lastQueryLabel = isIceniaOnly ? "Icenia City" : (outputQuery || inputQuery);
                
                // Invalidate size once before applying filters and fitting bounds to ensure correct dimensions
                map.invalidateSize();
                applyFiltersAndDisplay();
            } catch (error) {
                console.error('Search failed:', error);
                resultsContainer.innerHTML = `<div class="results-placeholder"><p class="govuk-body-s" style="color: #d4351c;">Error fetching data from Tradex. Please try again.<br><small>${escapeHtml(error.message)}</small></p></div>`;
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        function selectMarker(marker) {
            // Remove ping and reset z-index from previous marker
            if (activeMarker) {
                const oldEl = activeMarker.getElement();
                if (oldEl) {
                    oldEl.classList.remove('ping-animation');
                    activeMarker.setZIndexOffset(0);
                }
            }
            
            activeMarker = marker;
            const el = marker.getElement();
            if (el) {
                el.classList.remove('ping-animation');
                void el.offsetWidth; // trigger reflow
                el.classList.add('ping-animation');
                marker.setZIndexOffset(1000); // Bring to front
            }
        }

        function applyFiltersAndDisplay() {
            if (lastExchanges.length === 0 && !lastQueryLabel) return;
            const iceniaOnly = iceniaOnlyCheckbox.checked;
            let filtered = [...lastExchanges];
            
            // Enchantment filters
            const enchantRows = document.querySelectorAll('.enchant-filter-row');
            const activeFilters = [];
            enchantRows.forEach(row => {
                const name = row.querySelector('.enchant-name-select').value;
                const levelStr = row.querySelector('.enchant-level-input').value;
                const level = levelStr ? (parseInt(levelStr) || 0) : 0;
                if (name) {
                    activeFilters.push({ name, level });
                }
            });

            if (activeFilters.length > 0) {
                // Helper: robustly find enchant level in various maps (case-insensitive, fuzzy)
                const getEnchantLevel = (item, enchantName) => {
                    if (!item) return 0;
                    const enchantNorm = enchantName.replace(/_/g, ' ').toString().toLowerCase();
                    const sources = ['enchants', 'requiredEnchants', 'storedEnchants'];
                    for (const src of sources) {
                        const map = item[src];
                        if (!map) continue;
                        for (const [k, val] of Object.entries(map)) {
                            if (!k) continue;
                            let keyNorm = k.toString().toLowerCase();
                            if (keyNorm.startsWith('minecraft:')) keyNorm = keyNorm.slice('minecraft:'.length);
                            keyNorm = keyNorm.replace(/_/g, ' ');
                            // Exact match
                            if (keyNorm === enchantNorm) return Number(val) || 0;
                            // Fuzzy: matches like "fortune" in "fortune 3" or keys with minor formatting differences
                            if (keyNorm.includes(enchantNorm) || enchantNorm.includes(keyNorm)) return Number(val) || 0;
                        }
                    }
                    return 0;
                };

                filtered = filtered.filter(ex => {
                    return activeFilters.every(filter => {
                        const itemLevel = getEnchantLevel(ex.output, filter.name);
                        // If no level specified (0), match any item that has the enchant at any level
                        if (filter.level === 0) {
                            return itemLevel > 0;
                        }
                        return itemLevel >= filter.level;
                    });
                });
            }

            if (iceniaOnly) {
                filtered = filtered.filter(ex => 
                    ex.pos.x >= ICENIA_CITY_BOUNDS.minX && 
                    ex.pos.x <= ICENIA_CITY_BOUNDS.maxX && 
                    ex.pos.z >= ICENIA_CITY_BOUNDS.minZ && 
                    ex.pos.z <= ICENIA_CITY_BOUNDS.maxZ
                );
            }
            
            // Client-side sorting (Fixes "Sort by doesn't work" issue)
            const sortMode = sortModeSelect.value;
            if (sortMode === 'cheapest') {
                filtered.sort((a, b) => (a.input.count / a.output.count) - (b.input.count / b.output.count));
            } else if (sortMode === 'latest') {
                // Prefer `time` from API, fall back to `updatedAt`
                filtered.sort((a, b) => (b.time || b.updatedAt || 0) - (a.time || a.updatedAt || 0));
            } else if (sortMode === 'stock') {
                filtered.sort((a, b) => b.stock - a.stock);
            } else if (sortMode === 'closest') {
                const pos = userLocation || { x: -3870, z: -4400 };
                const dist = (p) => Math.sqrt(Math.pow(p.x - pos.x, 2) + Math.pow(p.z - pos.z, 2));
                filtered.sort((a, b) => dist(a.pos) - dist(b.pos));
            }

            displayResults(filtered, lastQueryLabel);
        }

        function displayResults(exchanges, queryLabel) {
            markerGroup.clearLayers();
            markers = [];
            activeMarker = null;
            activeCard = null;

            if (!exchanges || exchanges.length === 0) {
                const updatedAfter = document.getElementById('updated-after').value;
                const allowUnstocked = allowUnstockedCheckbox.checked;
                
                let warning = `<div class="results-placeholder no-results">
                    <div class="warning-icon">‚ö†Ô∏è</div>
                    <p class="govuk-body-s"><strong>No shops found for "${escapeHtml(queryLabel)}"</strong></p>
                    <ul class="govuk-list govuk-list--bullet govuk-body-s">
                        ${!allowUnstocked ? '<li>Try enabling <strong>"Unstocked"</strong> in options</li>' : ''}
                        ${updatedAfter !== '0' ? '<li>Try setting <strong>"Time"</strong> to "Anytime"</li>' : ''}
                        <li>Check for typos in the item name</li>
                    </ul>
                </div>`;
                resultsContainer.innerHTML = warning;
                return;
            }

            const grouped = {};
            exchanges.forEach(ex => {
                const key = `${ex.pos.x},${ex.pos.y},${ex.pos.z}`;
                if (!grouped[key]) grouped[key] = [];
                grouped[key].push(ex);
            });

            Object.entries(grouped).forEach(([key, locExchanges]) => {
                const first = locExchanges[0];
                const latLng = mcToLatLng(first.pos.x, first.pos.z);
                
                const marker = L.marker(latLng, {
                    icon: L.divIcon({
                        className: 'shop-pointer-marker',
                        html: '<div class="pointer-inner"></div>',
                        iconSize: [32, 32],
                        iconAnchor: [16, 32],
                        popupAnchor: [0, -35]
                    })
                }).addTo(markerGroup);
                
                let popupContent = `<div class="shop-popup">
                    <h3>Shop at ${first.pos.x}, ${first.pos.z}</h3>
                    <div class="exchanges-list">`;
                
                locExchanges.forEach(ex => {
                    const inputFmt = formatCount(ex.input.count, ex.input);
                    const outputFmt = formatCount(ex.output.count, ex.output);
                    
                    const inputLore = formatLoreText(ex.input);
                    const outputLore = formatLoreText(ex.output);

                    popupContent += `
                        <div class="exchange-row">
                            <div class="exchange-item-bundle">
                                <div class="item-icon-bg small" ${inputLore ? `data-lore="${inputLore.replace(/"/g, '&quot;')}"` : ''}>
                                    <img class="popup-item-icon" src="${getItemIconUrl(ex.input.material)}" data-material="${escapeHtml(ex.input.material)}" onerror="handleItemImageError.call(this)">
                                </div>
                                <span class="exchange-price">
                                    <span class="count ${inputFmt.isCompacted ? 'compacted' : ''}">${inputFmt.text}</span>
                                    <span class="name">${formatItemName(ex.input)}</span>
                                </span>
                            </div>
                            <span class="exchange-arrow">‚Üí</span>
                            <div class="exchange-item-bundle output">
                                <span class="exchange-output">
                                    <span class="count ${outputFmt.isCompacted ? 'compacted' : ''}">${outputFmt.text}</span>
                                    <span class="name">${formatItemName(ex.output)}</span>
                                </span>
                                <div class="item-icon-bg small" ${outputLore ? `data-lore="${outputLore.replace(/"/g, '&quot;')}"` : ''}>
                                    <img class="popup-item-icon" src="${getItemIconUrl(ex.output.material)}" data-material="${escapeHtml(ex.output.material)}" onerror="handleItemImageError.call(this)">
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                popupContent += `</div></div>`;
                marker.bindPopup(popupContent);
                marker.on('click', () => {
                    const latLng = mcToLatLng(first.pos.x, first.pos.z);
                    flyToWithOffset(latLng, DEFAULT_CLICK_ZOOM);
                    selectMarker(marker);
                });
                markers.push({ key, marker, exchanges: locExchanges });
            });

            resultsContainer.innerHTML = '';
            const fragment = document.createDocumentFragment();
            exchanges.forEach((ex, index) => {
                const card = document.createElement('div');
                card.className = 'shop-result-card';
                card.style.animationDelay = `${index * 0.04}s`;
                
                const stockClass = ex.stock > 64 ? 'stock-high' : (ex.stock > 0 ? 'stock-low' : 'stock-none');
                const stockText = ex.stock > 0 ? `Stock: ${ex.stock}` : 'Out of Stock';
                const outputName = formatItemName(ex.output);
                const inputName = formatItemName(ex.input);
                const inputFmt = formatCount(ex.input.count, ex.input);
                const outputFmt = formatCount(ex.output.count, ex.output);
                
                const inputLore = formatLoreText(ex.input);
                const outputLore = formatLoreText(ex.output);

                // Robust freshness logic ‚Äî accept multiple timestamp fields and numeric strings
                const now = Date.now();
                const rawTs = (ex.time ?? ex.updatedAt ?? ex.timeMillis ?? ex.timestamp ?? null);
                let updatedAt = null;
                if (rawTs !== null && rawTs !== undefined) {
                    const n = Number(rawTs);
                    if (Number.isFinite(n) && n > 0) updatedAt = n;
                }
                const hasUpdated = updatedAt !== null;
                const ageMs = hasUpdated ? (now - updatedAt) : Infinity;
                const ageDays = hasUpdated ? (ageMs / (1000 * 60 * 60 * 24)) : Infinity;

                let freshnessClass = 'fresh-red';
                let freshnessText = 'Old';
                if (!hasUpdated) {
                    freshnessClass = 'fresh-red';
                    freshnessText = 'Unknown';
                } else if (ageMs < 0) {
                    // Future timestamps ‚Äî treat as very recent
                    freshnessClass = 'fresh-green';
                    freshnessText = 'Recent';
                } else if (ageDays < 7) {
                    freshnessClass = 'fresh-green';
                    freshnessText = 'Recent';
                } else if (ageDays < 30) {
                    freshnessClass = 'fresh-yellow';
                    freshnessText = '30d';
                }

                // Human-readable hover title: relative time + full timestamp when available
                const freshnessTitle = hasUpdated
                    ? `${formatTimeAgo(Math.abs(ageMs))} ‚Äî ${new Date(updatedAt).toLocaleString()}`
                    : 'Last updated: Unknown';

                card.innerHTML = `
                    <div class="trade-display">
                        <div class="item-stack">
                            <div class="item-icon-bg" ${inputLore ? `data-lore="${inputLore.replace(/"/g, '&quot;')}"` : ''}>
                                <img class="item-icon" src="${getItemIconUrl(ex.input.material)}" data-material="${escapeHtml(ex.input.material)}" onerror="handleItemImageError.call(this)" alt="">
                                <span class="stack-count ${inputFmt.isCompacted ? 'compacted' : ''}">${inputFmt.text}</span>
                            </div>
                            <span class="item-label">${inputName}</span>
                        </div>
                        <div class="trade-arrow">‚Üí</div>
                        <div class="item-stack">
                            <div class="item-icon-bg" ${outputLore ? `data-lore="${outputLore.replace(/"/g, '&quot;')}"` : ''}>
                                <img class="item-icon" src="${getItemIconUrl(ex.output.material)}" data-material="${escapeHtml(ex.output.material)}" onerror="handleItemImageError.call(this)" alt="">
                                <span class="stack-count ${outputFmt.isCompacted ? 'compacted' : ''}">${outputFmt.text}</span>
                            </div>
                            <span class="item-label">${outputName}</span>
                        </div>
                    </div>
                    <div class="result-meta">
                        <div style="display: flex; gap: 4px; align-items: center;">
                            <span class="stock-badge ${stockClass}">${stockText}</span>
                            <span class="freshness-badge ${freshnessClass}" title="${freshnessTitle}">${freshnessText}</span>
                        </div>
                        <span class="coords-label">üìç ${ex.pos.x}, ${ex.pos.z}</span>
                    </div>
                `;
                
                card.addEventListener('click', () => {
                    const latLng = mcToLatLng(ex.pos.x, ex.pos.z);
                    
                    if (activeCard === card) {
                        // Second click: Zoom out
                        if (markers.length > 0) {
                            const bounds = L.featureGroup(markers.map(m => m.marker)).getBounds();
                            const isMobile = window.innerWidth <= 768;
                            map.fitBounds(bounds, { 
                                paddingTopLeft: isMobile ? [20, 20] : [420, 50],
                                paddingBottomRight: isMobile ? [20, window.innerHeight * 0.45] : [50, 50],
                                maxZoom: 0 
                            });
                        }
                        if (activeMarker) {
                            const oldEl = activeMarker.getElement();
                            if (oldEl) oldEl.classList.remove('ping-animation');
                            activeMarker.setZIndexOffset(0);
                            activeMarker.closePopup();
                        }
                        card.classList.remove('active');
                        activeCard = null;
                        activeMarker = null;
                        return;
                    }

                    flyToWithOffset(latLng, DEFAULT_CLICK_ZOOM);
                    
                    const markerObj = markers.find(m => m.key === `${ex.pos.x},${ex.pos.y},${ex.pos.z}`);
                    if (markerObj) {
                        markerObj.marker.openPopup();
                        selectMarker(markerObj.marker);
                    }
                    
                    if (activeCard) activeCard.classList.remove('active');
                    card.classList.add('active');
                    activeCard = card;
                });
                fragment.appendChild(card);
            });
            resultsContainer.appendChild(fragment);

            if (markers.length > 0) {
                const bounds = L.featureGroup(markers.map(m => m.marker)).getBounds();
                const isMobile = window.innerWidth <= 768;
                map.fitBounds(bounds, { 
                    paddingTopLeft: isMobile ? [20, 20] : [420, 50],
                    paddingBottomRight: isMobile ? [20, window.innerHeight * 0.45] : [50, 50],
                    maxZoom: 0 
                });
            }
        }

        searchButton.addEventListener('click', () => performSearch(false));
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch(false);
        });

        searchInput.addEventListener('input', () => {
            searchInput.placeholder = "I want to buy (e.g. diamond)";
        });
        
        document.getElementById('show-icenia-shops').addEventListener('click', () => {
            searchInput.value = ''; 
            searchInput.placeholder = "Showing all Icenia City shops...";
            performSearch(true);
        });

        sortModeSelect.addEventListener('change', () => applyFiltersAndDisplay());
        allowUnstockedCheckbox.addEventListener('change', () => applyFiltersAndDisplay());
        iceniaOnlyCheckbox.addEventListener('change', () => applyFiltersAndDisplay());
        // Territories overlay button hookup (map controls)
        const toggleTerritoriesBtn = document.getElementById('toggle-territories');
        if (toggleTerritoriesBtn) {
            toggleTerritoriesBtn.addEventListener('click', (e) => {
                const enabled = toggleTerritoriesBtn.classList.toggle('active');
                toggleTerritories(enabled);
                try {
                    toggleTerritoriesBtn.setAttribute('aria-pressed', enabled ? 'true' : 'false');
                    toggleTerritoriesBtn.title = enabled ? 'Hide Territories' : 'Show Territories';
                } catch (err) {}
            });
            // Restore prior setting if present
            try {
                const saved = localStorage.getItem('shop_show_territories');
                if (saved === '1') {
                    toggleTerritoriesBtn.classList.add('active');
                    toggleTerritoriesBtn.setAttribute('aria-pressed', 'true');
                    toggleTerritoriesBtn.title = 'Hide Territories';
                    toggleTerritories(true);
                }
            } catch (e) {
                // ignore storage errors
            }
        }
        
        const toggleOptionsBtn = document.getElementById('toggle-options');
        const advancedOptionsWrapper = document.getElementById('advanced-options-wrapper');
        const advancedOptionsGrid = document.getElementById('advanced-options');

        // Initial state: Open on PC, Closed on Mobile
        if (window.innerWidth <= 768) {
            advancedOptionsWrapper.classList.add('collapsed');
            toggleOptionsBtn.classList.remove('active');
        } else {
            toggleOptionsBtn.classList.add('active');
        }

        toggleOptionsBtn.addEventListener('click', () => {
            advancedOptionsWrapper.classList.toggle('collapsed');
            toggleOptionsBtn.classList.toggle('active');
            // Update scroll indicator when toggled
            setTimeout(updateAdvancedScroll, 450);
        });

        // --- Custom Scroll Indicator Logic ---
        function setupScrollIndicator(scrollEl, indicatorEl) {
            if (!scrollEl || !indicatorEl) return;
            
            const scrollThumb = indicatorEl.querySelector('.scroll-thumb');
            let hideTimeout;
            
            // Use passive listener for better scroll performance
            const scrollOptions = { passive: true };
            
            function updateScrollIndicator() {
                const { scrollTop, scrollHeight, clientHeight } = scrollEl;
                const scrollableHeight = scrollHeight - clientHeight;
                
                // Hide indicator if no scrolling needed
                if (scrollableHeight <= 0) {
                    indicatorEl.style.display = 'none';
                    return;
                }
                indicatorEl.style.display = 'block';
                
                // Calculate thumb position (0 to 70% to leave room for thumb height)
                const scrollPercent = scrollTop / scrollableHeight;
                const thumbTop = scrollPercent * 70;
                scrollThumb.style.top = thumbTop + '%';
                
                // Add/remove at-bottom class to stop glow animation
                if (scrollPercent > 0.98) {
                    indicatorEl.classList.add('at-bottom');
                } else {
                    indicatorEl.classList.remove('at-bottom');
                }
                
                // Show indicator briefly when scrolling
                indicatorEl.classList.add('visible');
                
                // Don't hide if it's the info panel
                if (scrollEl.id !== 'info-content') {
                    clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(() => {
                        indicatorEl.classList.remove('visible');
                    }, 1500);
                } else {
                    // For info panel, keep it visible if scrollable
                    indicatorEl.classList.add('visible');
                    // Force opacity for info panel indicator
                    indicatorEl.style.opacity = '1';
                }
            }
            
            scrollEl.addEventListener('scroll', updateScrollIndicator, scrollOptions);
            
            // Initial check
            updateScrollIndicator();
            
            return updateScrollIndicator;
        }

        const updateResultsScroll = setupScrollIndicator(
            document.getElementById('results-container'),
            document.getElementById('results-scroll-indicator')
        );

        const updateAdvancedScroll = setupScrollIndicator(
            document.getElementById('advanced-options'),
            document.getElementById('advanced-scroll-indicator')
        );

        const updateInfoScroll = setupScrollIndicator(
            document.getElementById('info-content'),
            document.getElementById('info-scroll-indicator')
        );

        // Update indicators when content changes
        const resultsObserver = new MutationObserver(() => {
            setTimeout(updateResultsScroll, 100);
        });
        resultsObserver.observe(document.getElementById('results-container'), { childList: true, subtree: true });

        const advancedObserver = new MutationObserver(() => {
            setTimeout(updateAdvancedScroll, 100);
        });
        advancedObserver.observe(document.getElementById('advanced-options'), { childList: true, subtree: true });

        const infoObserver = new MutationObserver(() => {
            setTimeout(updateInfoScroll, 100);
        });
        infoObserver.observe(document.getElementById('info-content'), { childList: true, subtree: true });

        // Update all scroll indicators on window resize
        window.addEventListener('resize', () => {
            updateResultsScroll();
            updateAdvancedScroll();
            updateInfoScroll();
        });

        centerIceniaBtn.addEventListener('click', () => flyToWithOffset(ICENIA_CITY_COORDS, 0));

        setLocationBtn.addEventListener('click', () => {
            isSettingLocation = !isSettingLocation;
            setLocationBtn.classList.toggle('active', isSettingLocation);
            document.getElementById('shop-map').style.cursor = isSettingLocation ? 'crosshair' : '';
        });

        function updateDarkMode() {
            const container = document.querySelector('.shop-explorer-container');
            const sunIcon = darkModeToggle.querySelector('.sun-icon');
            const moonIcon = darkModeToggle.querySelector('.moon-icon');
            if (isDarkMode) {
                container.classList.add('dark-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                container.classList.remove('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
        }

        darkModeToggle.addEventListener('click', () => {
            isDarkMode = !isDarkMode;
            updateDarkMode();
        });

        updateDarkMode();

        // Initialize pin display
        if (pinCoordsEl) pinCoordsEl.textContent = '‚Äî';

        // Update cursor coordinates as the user moves over the map
        if (map && cursorCoordsEl) {
            map.on('mousemove', (e) => {
                try {
                    const x = Math.round(e.latlng.lng);
                    const z = Math.round(-e.latlng.lat);
                    cursorCoordsEl.textContent = `${x}, ${z}`;
                } catch (err) {
                    // ignore
                }
            });
        }

        // --- Tooltip Logic ---
        const tooltip = document.getElementById('item-tooltip');
        let tooltipTimeout;

        function showTooltip(e, text) {
            if (!text) return;
            tooltip.innerHTML = renderMinecraftText(text);
            tooltip.classList.remove('hidden');
            updateTooltipPos(e);
        }

        function hideTooltip() {
            tooltip.classList.add('hidden');
        }

        function updateTooltipPos(e) {
            const x = e.clientX + 15;
            const y = e.clientY + 15;
            
            // Keep on screen
            const width = tooltip.offsetWidth;
            const height = tooltip.offsetHeight;
            
            let finalX = x;
            let finalY = y;
            
            if (x + width > window.innerWidth) finalX = e.clientX - width - 15;
            if (y + height > window.innerHeight) finalY = e.clientY - height - 15;
            
            tooltip.style.left = finalX + 'px';
            tooltip.style.top = finalY + 'px';
        }

        document.addEventListener('mouseover', (e) => {
            const target = e.target.closest('[data-lore]');
            if (target) {
                showTooltip(e, target.dataset.lore);
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (!tooltip.classList.contains('hidden')) {
                updateTooltipPos(e);
            }
        });

        document.addEventListener('mouseout', (e) => {
            const target = e.target.closest('[data-lore]');
            if (target) {
                hideTooltip();
            }
        });

        // Mobile support: toggle on click
        document.addEventListener('click', (e) => {
            const target = e.target.closest('[data-lore]');
            if (target && window.innerWidth <= 768) {
                if (tooltip.classList.contains('hidden')) {
                    showTooltip(e, target.dataset.lore);
                    // Auto hide after 3s on mobile
                    clearTimeout(tooltipTimeout);
                    tooltipTimeout = setTimeout(hideTooltip, 3000);
                } else {
                    hideTooltip();
                }
            } else if (!target) {
                hideTooltip();
            }
        });

        const infoToggle = document.getElementById('info-toggle');
        const infoPanel = document.getElementById('info-panel');

        // PC: Toggled ON by default, Mobile: Toggled OFF
        if (window.innerWidth > 768) {
            infoPanel.classList.remove('hidden');
        }

        infoToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            infoPanel.classList.toggle('hidden');
            if (!infoPanel.classList.contains('hidden')) {
                setTimeout(updateInfoScroll, 100);
            }
        });

        // Close panel when clicking elsewhere on the map
        // But do not close when the user is currently placing a location pin
        map.on('click', () => {
            if (isSettingLocation) return;
            infoPanel.classList.add('hidden');
        });

        document.getElementById('zoom-in').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoom-out').addEventListener('click', () => map.zoomOut());

        map.on('click', (e) => {
            if (isSettingLocation) {
                const x = Math.round(e.latlng.lng);
                const z = Math.round(-e.latlng.lat);
                userLocation = { x, z };
                if (userMarker) map.removeLayer(userMarker);
                userMarker = L.marker(e.latlng, {
                    icon: L.divIcon({
                        className: 'user-location-radar',
                        html: '<div class="radar-ring"></div><div class="radar-dot"></div>',
                        iconSize: [0, 0],
                        iconAnchor: [0, 0]
                    })
                }).addTo(map);
                isSettingLocation = false;
                setLocationBtn.classList.remove('active');
                document.getElementById('shop-map').style.cursor = '';
                // Update pin readout but do NOT trigger a search
                sortModeSelect.value = 'closest';
                if (pinCoordsEl) pinCoordsEl.textContent = `${x}, ${z}`;
            }
        });
    });
</script>
