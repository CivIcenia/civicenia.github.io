---
/**
 * Interactive SVG Map of Icenian Territories
 * Renders polygons from shared territories data with hover effects
 */
import { territories as allTerritories, type Territory } from "@data/territories";

// Filter to only display territories (not markers) and prepare display names
const territories = allTerritories
    .filter(t => t.polygon && t.polygon.length > 0)
    .map(t => ({
        ...t,
        // Use simplified display name for the map
        displayName: t.name === "Icenia" ? "Icenia Federal Territory" : 
                     t.name === "Alenarith Protectorate" ? "Cortesia Del Mar" : 
                     t.name
    }));

// Calculate bounds for viewBox
function calculateBounds(territories: Territory[]) {
    let minX = Infinity, minZ = Infinity, maxX = -Infinity, maxZ = -Infinity;
    
    for (const territory of territories) {
        if (territory.polygon) {
            for (const ring of territory.polygon) {
                for (const [x, z] of ring) {
                    minX = Math.min(minX, x);
                    maxX = Math.max(maxX, x);
                    minZ = Math.min(minZ, z);
                    maxZ = Math.max(maxZ, z);
                }
            }
        }
    }
    
    // Add padding
    const padding = 500;
    return {
        minX: minX - padding,
        minZ: minZ - padding,
        width: maxX - minX + padding * 2,
        height: maxZ - minZ + padding * 2
    };
}

// Convert polygon to SVG points string
function polygonToPoints(ring: number[][]): string {
    return ring.map(([x, z]) => `${x},${z}`).join(' ');
}

const bounds = calculateBounds(territories);
---

<div class="interactive-map-container">
    <svg 
        viewBox={`${bounds.minX} ${bounds.minZ} ${bounds.width} ${bounds.height}`}
        class="interactive-map"
        preserveAspectRatio="xMidYMid meet"
    >
        <defs>
            <filter id="glow">
                <feGaussianBlur stdDeviation="30" result="coloredBlur"/>
                <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>
        </defs>
        
        <!-- Background -->
        <rect 
            x={bounds.minX} 
            y={bounds.minZ} 
            width={bounds.width} 
            height={bounds.height} 
            fill="#1a1a2e"
        />
        
        <!-- Territory polygons -->
        {territories.map((territory) => (
            territory.polygon && territory.polygon.map((ring, i) => (
                <polygon
                    points={polygonToPoints(ring)}
                    fill={territory.color}
                    fill-opacity="0.6"
                    stroke={territory.color}
                    stroke-width="15"
                    class="territory-polygon"
                    data-name={territory.displayName}
                    data-id={territory.id}
                />
            ))
        ))}
        
        <!-- Labels -->
        {territories.map((territory) => {
            if (!territory.polygon || territory.polygon.length === 0) return null;
            // Calculate centroid of first ring
            const ring = territory.polygon[0];
            const cx = ring.reduce((sum, [x]) => sum + x, 0) / ring.length;
            const cz = ring.reduce((sum, [, z]) => sum + z, 0) / ring.length;
            return (
                <text
                    x={cx}
                    y={cz}
                    text-anchor="middle"
                    dominant-baseline="middle"
                    fill="white"
                    font-size="120"
                    font-weight="bold"
                    class="territory-label"
                    style="pointer-events: none; text-shadow: 2px 2px 4px rgba(0,0,0,0.8);"
                >
                    {territory.displayName}
                </text>
            );
        })}
    </svg>
    
    <!-- Tooltip -->
    <div class="map-tooltip" id="map-tooltip"></div>
    
    <!-- Legend -->
    <div class="map-legend">
        <h4>Territories</h4>
        {territories.map((territory) => (
            <div class="legend-item" data-id={territory.id}>
                <span class="legend-color" style={`background-color: ${territory.color};`}></span>
                <span class="legend-name">{territory.displayName}</span>
            </div>
        ))}
    </div>
</div>

<style>
    .interactive-map-container {
        position: relative;
        width: 100%;
        background: #1a1a2e;
        border-radius: 8px;
        overflow: hidden;
        margin: 20px 0;
    }
    
    .interactive-map {
        width: 100%;
        height: 500px;
        cursor: grab;
    }
    
    .interactive-map:active {
        cursor: grabbing;
    }
    
    .territory-polygon {
        cursor: pointer;
        transition: fill-opacity 0.2s, filter 0.2s;
    }
    
    .territory-polygon:hover {
        fill-opacity: 0.9;
        filter: url(#glow);
    }
    
    .territory-label {
        font-family: "nta", Arial, sans-serif;
    }
    
    .map-tooltip {
        position: absolute;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s;
        z-index: 100;
        white-space: nowrap;
    }
    
    .map-legend {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border-radius: 6px;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
    }
    
    .map-legend h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
        color: #0b0c0c;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 0;
        cursor: pointer;
        transition: background 0.2s;
        border-radius: 3px;
        padding: 4px 6px;
        margin: 0 -6px;
    }
    
    .legend-item:hover {
        background: rgba(0, 0, 0, 0.05);
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 3px;
        flex-shrink: 0;
    }
    
    .legend-name {
        color: #0b0c0c;
    }
    
    @media (max-width: 768px) {
        .interactive-map {
            height: 350px;
        }
        
        .map-legend {
            position: relative;
            top: auto;
            right: auto;
            margin: 10px;
            max-height: none;
        }
        
        .territory-label {
            font-size: 80px;
        }
    }
</style>

<script>
    // Interactive map functionality
    document.addEventListener('DOMContentLoaded', () => {
        const tooltip = document.getElementById('map-tooltip');
        const polygons = document.querySelectorAll('.territory-polygon');
        const legendItems = document.querySelectorAll('.legend-item');
        
        // Tooltip on hover
        polygons.forEach(polygon => {
            polygon.addEventListener('mouseenter', (e) => {
                const name = polygon.getAttribute('data-name');
                if (tooltip && name) {
                    tooltip.textContent = name;
                    tooltip.style.opacity = '1';
                }
            });
            
            polygon.addEventListener('mousemove', (e) => {
                if (tooltip) {
                    const rect = (e.target as Element).closest('.interactive-map-container')?.getBoundingClientRect();
                    if (rect) {
                        tooltip.style.left = (e.clientX - rect.left + 10) + 'px';
                        tooltip.style.top = (e.clientY - rect.top - 30) + 'px';
                    }
                }
            });
            
            polygon.addEventListener('mouseleave', () => {
                if (tooltip) {
                    tooltip.style.opacity = '0';
                }
            });
        });
        
        // Legend hover highlights corresponding territory
        legendItems.forEach(item => {
            const id = item.getAttribute('data-id');
            
            item.addEventListener('mouseenter', () => {
                polygons.forEach(polygon => {
                    if (polygon.getAttribute('data-id') === id) {
                        (polygon as SVGElement).style.fillOpacity = '0.9';
                        (polygon as SVGElement).style.filter = 'url(#glow)';
                    } else {
                        (polygon as SVGElement).style.fillOpacity = '0.3';
                    }
                });
            });
            
            item.addEventListener('mouseleave', () => {
                polygons.forEach(polygon => {
                    (polygon as SVGElement).style.fillOpacity = '0.6';
                    (polygon as SVGElement).style.filter = '';
                });
            });
        });
    });
</script>
