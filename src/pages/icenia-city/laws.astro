---
import PageLayout from "@layouts/page.astro";
import CityCard from "@components/laws/city-card.astro";
import { CityLaws } from "../../lib/city-laws";
import { CityActs } from "../../lib/city-acts";
import { ScrapedItems } from "../../lib/scraped-items";
import { Strings } from "@helpers";
import { getActChangeColours } from "@comptime";

const BASE = (import.meta.env.BASE_URL ?? "/");

// Get city laws and recent acts
const cityLaws = await CityLaws.getCityLaws();

const allActs = await CityActs.getCityActs();
const recentActs = allActs.filter(act => (act.data as CityActs.CityAct).changes.length > 0).slice(0, 5);

const currentLaws = cityLaws.filter((law) => law.hidden !== true);
const expiredLaws = cityLaws.filter((law) => law.hidden === true);

// Organize laws by type
const charterLaws = currentLaws.filter((law) => law.kind === "charter");
const ordinanceLaws = currentLaws.filter((law) => law.kind === "ordinance");

// Count total pending changes
let totalPending = 0;
for (const law of currentLaws) {
    const pending = await CityLaws.getPendingChanges(law);
    totalPending += pending.length;
}

const pendingScrapedCount = ScrapedItems.getPendingCityCount();
---
<style>
    .pending-banner {
        background: #fef7f3;
        border-left: 6px solid #f47738;
        padding: 15px 20px;
        margin-bottom: 30px;
    }

    .scraped-tracker {
        background: #fef7f3;
        border-left: 6px solid #f47738;
        padding: 15px 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .scraped-tracker-text {
        margin: 0;
    }

    .scraped-count-badge {
        background: #f47738;
        color: white;
        padding: 2px 10px;
        border-radius: 15px;
        font-weight: bold;
    }

</style>

<PageLayout chin={false} title="City Laws - Icenia City" description="View the charter, ordinances, and regulations governing Icenia City.">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="govuk-heading-xl" style="margin-bottom: 10px;">Icenia City Laws</h1>
        <p class="govuk-body-l">The charter, ordinances, and regulations governing the capital city.</p>
    </div>

    <!-- Scraped Items Tracker -->
    {pendingScrapedCount > 0 && (
        <div class="scraped-tracker">
            <p class="scraped-tracker-text govuk-body">
                <span class="scraped-count-badge">{pendingScrapedCount}</span>
                {pendingScrapedCount === 1 ? " item has" : " items have"} been scraped and {pendingScrapedCount === 1 ? "is" : "are"} awaiting review.
            </p>
            <a href={BASE + "icenia-city/news/scraped/"} class="govuk-link">View Scraped Items →</a>
        </div>
    )}

    <!-- Pending Incorporations Banner -->
    {totalPending > 0 && (
        <div class="pending-banner">
            <strong>{totalPending} pending incorporation{totalPending > 1 ? 's' : ''}</strong> — 
            Some amendments need to be added to master documents.
            <a href={BASE + "icenia-city/laws/incorporations/"} class="govuk-link" style="margin-left: 10px;">
                View tracker →
            </a>
        </div>
    )}

    <!-- Recent Changes Section -->
    <div class="recent-changes-section">
        <h2 class="govuk-heading-m" style="margin-top: 0;">Recent Changes to City Legislation</h2>
        {recentActs.length > 0 ? recentActs.map((act) => {
            const actData = act.data as CityActs.CityAct;
            const actNumber = CityActs.formatActNumber(actData);
            return (
                <div class="change-item">
                    <div class="change-info">
                        <div class="change-date">
                            {Strings.formatDate(act.data.date, "dS mmmm yyyy")}
                            {actNumber && <span style="margin-left: 10px; font-weight: 600; color: #1C70B8;">Act {actNumber}</span>}
                        </div>
                        <div class="change-title">
                            <a href={BASE + "icenia-city/news/" + act.slug} class="govuk-link">
                                {act.data.headline}
                            </a>
                        </div>
                    </div>
                    <div class="change-tags">
                            {actData.changes.map((change) => (
                                <strong class="govuk-tag govuk-tag--small" style={`background-color: #${getActChangeColours(change.kind).background}; margin-left: 5px;`}>
                                    {change.kind === "passage" ? "Enacted" : change.kind === "amendment" ? "Amended" : change.kind === "repeal" ? "Repealed" : "Changed"}
                                </strong>
                            ))}
                        </div>
                    </div>
                );
            }) : (
                <div class="change-item">
                    <div class="change-info">
                        <div class="change-title" style="color: #6f777b; font-weight: 400;">
                            No recent changes to city legislation.
                        </div>
                    </div>
                </div>
            )}
    </div>

    <!-- Laws Grid -->
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
            <h2 class="govuk-heading-l">City Charter</h2>
            {charterLaws.length > 0 ? (
                charterLaws.map((law) => <CityCard law={law} />)
            ) : (
                <p class="govuk-body">No city charter documents available.</p>
            )}
        </div>
        <div class="govuk-grid-column-one-half">
            <h2 class="govuk-heading-l">City Ordinances</h2>
            {ordinanceLaws.length > 0 ? (
                ordinanceLaws.map((law) => <CityCard law={law} />)
            ) : (
                <p class="govuk-body">No city ordinances available.</p>
            )}
        </div>
    </div>

    <!-- Expired/Repealed Laws Section -->
    {expiredLaws.length > 0 && (
        <>
            <hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible" />
            <details class="govuk-details" data-module="govuk-details">
                <summary class="govuk-details__summary">
                    <span class="govuk-details__summary-text">
                        View repealed ordinances ({expiredLaws.length})
                    </span>
                </summary>
                <div class="govuk-details__text">
                    {expiredLaws.map((law) => (
                        <div class="repealed-card">
                            <CityCard law={law} />
                        </div>
                    ))}
                </div>
            </details>
        </>
    )}

    <!-- Link to Republic Laws -->
    <div class="govuk-grid-row govuk-!-margin-top-6">
        <div class="govuk-grid-column-full">
            <div class="govuk-inset-text">
                <p class="govuk-body">
                    Looking for national legislation? View the <a href={BASE + "laws/"} class="govuk-link">Republic of Icenia Laws</a>, 
                    including the Constitution, statutes, and international treaties.
                </p>
            </div>
        </div>
    </div>
</PageLayout>
