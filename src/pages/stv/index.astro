---
import PageLayout from "@layouts/page.astro";
---

<PageLayout chin={false} title="Icenian STV Calculator" description="This calculator implements Single Transferable Vote (STV) as used in Icenian elections.">

    <!-- Page Header -->
    <div class="page-header">
        <h1 class="govuk-heading-xl" style="margin-bottom: 10px;">Icenian STV Calculator</h1>
        <p class="govuk-body-l">This calculator implements Single Transferable Vote (STV) as used in Icenian elections.</p>
    </div>

    <div class="govuk-width-container">
        <main class="govuk-main-wrapper govuk-body" id="main-content">
            
            <!-- Mode Selection -->
            <div class="mode-selection govuk-form-group">
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                        Input Mode
                    </legend>
                    <div class="govuk-radios govuk-radios--inline">
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" id="mode-simple" name="input-mode" type="radio" value="simple" checked>
                            <label class="govuk-label govuk-radios__label" for="mode-simple">
                                Simple Format
                            </label>
                        </div>
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" id="mode-discord" name="input-mode" type="radio" value="discord">
                            <label class="govuk-label govuk-radios__label" for="mode-discord">
                                Discord Paste
                            </label>
                        </div>
                    </div>
                </fieldset>
                
                <!-- Import Election -->
                <div class="govuk-!-margin-top-6" id="import-section">
                    <h2 class="govuk-heading-s">Or Import Previous Election</h2>
                    <p class="govuk-body-s">Load a previously exported election file to resume your work.</p>
                    <input
                        type="file"
                        id="import-file-input"
                        accept=".json"
                        style="display: none;"
                    />
                    <div class="icenia-button-group">
                        <button class="icenia-btn icenia-btn-secondary" id="import-election-button" type="button">
                            Import Election File
                        </button>
                        <button class="icenia-btn icenia-btn-warning" id="clear-session-start" type="button">
                            Clear Session
                        </button>
                    </div>
                </div>
            </div>

            <!-- Simple Mode (original interface) -->
            <div id="simple-mode" class="stv-calculator">
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" for="candidates">
                        Candidates (one per line)
                    </label>
                    <textarea 
                        class="icenia-textarea" 
                        id="candidates" 
                        rows="8"
                        placeholder="Enter candidate names, one per line"
                    ></textarea>
                </div>
                
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" for="seats">
                        Number of Seats to Fill
                    </label>
                    <input 
                        class="icenia-input govuk-input--width-5" 
                        id="seats" 
                        type="number" 
                        value="5"
                        min="1"
                    />
                </div>
                
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" for="ballots">
                        Ballots (one per line, format: "voter: cand1, cand2, cand3")
                    </label>
                    <textarea 
                        class="icenia-textarea" 
                        id="ballots" 
                        rows="15"
                        placeholder="recycler: Ratat0ing, Dr_Bacon_hair, hsmnewfriend&#10;alzubloxxer11: Dr_Bacon_hair, hsmnewfriend, Ratat0ing"
                    ></textarea>
                </div>
                
                <button class="icenia-btn" id="calculate" type="button">
                    Calculate Results
                </button>
                
                <button class="icenia-btn icenia-btn-secondary" id="loadExample" type="button">
                    Load Example Data
                </button>
            </div>

            <!-- Discord Mode -->
            <div id="discord-mode" class="stv-calculator" style="display: none;">
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" for="discord-candidates">
                        Official Candidates (paste from Discord, one per line)
                    </label>
                    <div class="govuk-hint">
                        Include @mentions or plain names. Example: @Mayor Ratat0ing or DinoCompactor
                    </div>
                    <textarea 
                        class="icenia-textarea" 
                        id="discord-candidates" 
                        rows="10"
                        placeholder="@DinoCompactor&#10;@IsraelGPT&#10;@CreepilyCreep&#10;@Dr Bacon Hair(real)"
                    ></textarea>
                </div>

                <div class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" for="discord-seats">
                        Number of Seats to Fill
                    </label>
                    <input 
                        class="icenia-input govuk-input--width-5" 
                        id="discord-seats" 
                        type="number" 
                        value="5"
                        min="1"
                    />
                </div>
                
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" for="discord-ballots">
                        Raw Discord Ballot Data (paste entire voting channel)
                    </label>
                    <div class="govuk-hint">
                        Copy and paste the entire Discord channel content including usernames, timestamps, and votes
                    </div>
                    <textarea 
                        class="icenia-textarea" 
                        id="discord-ballots" 
                        rows="20"
                        placeholder="Ex-Councilor TheRecycler — 03/01/2026 06:12&#10;Ratat0ing&#10;Dr Bacon Hair&#10;HsmNewfriend"
                    ></textarea>
                </div>
                
                <button class="icenia-btn" id="parse-discord" type="button">
                    Parse Discord Data
                </button>
            </div>

            <!-- Name Matching Interface -->
            <div id="name-matching" style="display: none;">
                <div class="icenia-button-group govuk-!-margin-bottom-6">
                    <button class="icenia-btn icenia-btn-secondary" id="export-election" type="button">
                        Export Election
                    </button>
                    <button class="icenia-btn icenia-btn-warning" id="clear-session" type="button">
                        Clear Session
                    </button>
                </div>
                
                <h2 class="govuk-heading-m">Review Candidate Name Matches</h2>
                <p class="govuk-body">
                    The following names were found in ballots. Please confirm matches or mark as invalid.
                </p>
                
                <!-- Correlation Table -->
                <div id="correlation-table-section" style="display: none;" class="govuk-!-margin-bottom-6">
                    <details class="govuk-details">
                        <summary class="govuk-details__summary">
                            <span class="govuk-details__summary-text">
                                View Learned Name Correlations (<span id="correlation-count">0</span>)
                            </span>
                        </summary>
                        <div class="govuk-details__text">
                            <p class="govuk-body-s">These name patterns have been learned during this session:</p>
                            <table class="govuk-table">
                                <thead class="govuk-table__head">
                                    <tr class="govuk-table__row">
                                        <th scope="col" class="govuk-table__header">Voter Name Pattern</th>
                                        <th scope="col" class="govuk-table__header">Matched Candidate</th>
                                    </tr>
                                </thead>
                                <tbody class="govuk-table__body" id="correlation-table-body">
                                </tbody>
                            </table>
                        </div>
                    </details>
                </div>
                
                <div id="name-match-list"></div>
                <div class="icenia-button-group govuk-!-margin-top-6">
                    <button class="icenia-btn icenia-btn-secondary" id="back-to-discord" type="button">
                        ← Back to Edit
                    </button>
                    <!-- <button class="icenia-btn" id="confirm-matches" type="button">
                        Review Ballots →
                    </button> -->
                </div>
            </div>
            
            <!-- Duplicate Voter Resolution Interface -->
            <div id="duplicate-voters" style="display: none;">
                <h2 class="govuk-heading-m">Resolve Duplicate Voters</h2>
                <p class="govuk-body">
                    Some voters submitted multiple ballots. Please select which ballot to use for each voter.
                </p>
                
                <div id="duplicate-voters-content"></div>
                
                <div class="icenia-button-group govuk-!-margin-top-6">
                    <button class="icenia-btn icenia-btn-secondary" id="back-to-name-matching-from-duplicates" type="button">
                        ← Back to Name Matching
                    </button>
                    <button class="icenia-btn" id="proceed-to-ballot-review" type="button">
                        Proceed to Ballot Review →
                    </button>
                </div>
            </div>
            
            <!-- Ballot Review Interface -->
            <div id="ballot-review" style="display: none;">
                <div class="icenia-button-group govuk-!-margin-bottom-6">
                    <button class="icenia-btn icenia-btn-secondary" id="export-election-review" type="button">
                        Export Election
                    </button>
                    <button class="icenia-btn icenia-btn-warning" id="clear-session-review" type="button">
                        Clear Session
                    </button>
                </div>
                
                <h2 class="govuk-heading-m">Review Ballots</h2>
                <p class="govuk-body">
                    Review each voter's ballot with the name mappings applied. You can edit mappings using the dropdowns.
                </p>
                
                <div id="ballot-review-progress" class="match-progress"></div>
                <div id="ballot-review-content"></div>
                
                <div class="icenia-button-group govuk-!-margin-top-6">
                    <button class="icenia-btn icenia-btn-secondary" id="back-to-name-matching" type="button">
                        ← Back to Name Matching
                    </button>
                    <!-- <button class="icenia-btn" id="calculate-from-review" type="button">
                        Calculate Results →
                    </button> -->
                </div>
            </div>
                
                <div id="results" style="display: none;">
                    <h2 class="govuk-heading-m">Results</h2>

                    <div class="govuk-form-group" style="max-width: 480px; margin-bottom: 20px;">
                        <label class="govuk-label" for="election-name">
                            Election name (for exports)
                        </label>
                        <div class="govuk-hint">Used in exported file names and RCVis metadata.</div>
                        <input class="govuk-input" id="election-name" name="election-name" type="text" placeholder="e.g. 2026-01 Senate Election">
                    </div>
                    
                    <div class="govuk-form-group" style="max-width: 300px; margin-bottom: 20px;">
                        <label class="govuk-label" for="results-seats">
                            Number of winners
                        </label>
                        <input class="govuk-input" id="results-seats" name="results-seats" type="number" min="1" value="5" style="width: 100px;">
                        <button class="icenia-btn" id="recalculate-results" type="button" style="margin-left: 10px;">
                            Recalculate
                        </button>
                    </div>
                    
                    <div id="log" class="stv-log"></div>
                    <div id="winners" class="stv-winners"></div>
                    
                    <div class="icenia-button-group govuk-!-margin-top-6">
                        <button class="icenia-btn" id="export-results" type="button">
                            Export Election
                        </button>
                        <button class="icenia-btn" id="export-rcvis" type="button">
                            Export for RCVis
                        </button>
                        <button class="icenia-btn icenia-btn-secondary" id="return-to-start" type="button">
                            Return to Start (Remember to Export!)
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <style is:global>
        .stv-calculator {
            max-width: 800px;
        }
        
        .mode-selection {
            max-width: 800px;
            margin-bottom: 30px;
        }
        
        .stv-log {
            background: #f3f2f1;
            padding: 20px;
            border-radius: 4px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .stv-winners {
            background: #00703c;
            color: white !important;
            padding: 20px;
            border-radius: 4px;
            font-weight: bold !important;
        }

        .stv-winners strong {
            font-weight: 900 !important;
            color: white !important;
        }
        
        .stv-log-win {
            color: #00703c;
            font-weight: 700;
        }
        
        .stv-log-elim {
            color: #d4351c;
        }

        #name-matching {
            max-width: 900px;
        }

        .name-match-item {
            background: white;
            border: 2px solid #1d70b8;
            padding: 25px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .match-progress {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.1em;
            color: #505a5f;
            font-weight: bold;
        }

        .match-navigation {
            margin-top: 25px;
        }

        .icenia-button-group {
            display: flex !important;
            gap: 16px !important;
            flex-wrap: wrap;
            align-items: center;
        }

        .match-navigation.icenia-button-group {
            display: flex;
            gap: 16px;
        }

        .icenia-button-group > button {
            margin: 0 !important;
        }

        .icenia-button-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .match-nav-button {
            flex: 1;
            max-width: 200px;
        }

        .match-nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .confirmation-list {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #b1b4b6;
            border-radius: 4px;
            padding: 15px;
            background: #f8f8f8;
        }

        .confirmation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .confirmation-item .found-name {
            font-weight: bold;
            color: #0b0c0c;
        }

        .confirmation-item .arrow {
            color: #505a5f;
            margin: 0 10px;
        }

        .confirmation-item .matched-name {
            color: #00703c;
            font-weight: 600;
        }

        .confirmation-item .matched-name.invalid {
            color: #d4351c;
            font-style: italic;
        }

        .confirmation-item .edit-link {
            cursor: pointer;
            color: #1d70b8;
            text-decoration: underline;
            font-size: 0.9em;
        }

        .confirmation-item .edit-link:hover {
            color: #003078;
        }

        .name-match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .found-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .match-count {
            color: #505a5f;
            font-size: 0.9em;
        }

        .match-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .match-option {
            padding: 8px 12px;
            border: 2px solid #b1b4b6;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: normal;
        }

        .match-option:hover,
        .match-option:focus {
            border-color: #1d70b8;
            background: #f3f6fc;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            outline: none;
        }

        .match-option.selected {
            background: #1d70b8 !important;
            color: white !important;
            border-color: #1d70b8 !important;
            font-weight: bold !important;
            box-shadow: 0 2px 6px rgba(29, 112, 184, 0.3) !important;
        }

        .match-option.selected::before {
            content: '✓ ';
            font-weight: bold;
            margin-right: 4px;
        }

        .match-option.invalid {
            background: #d4351c !important;
            color: white !important;
            border-color: #d4351c !important;
            font-weight: bold !important;
            box-shadow: 0 2px 6px rgba(212, 53, 28, 0.3) !important;
        }

        .match-option.invalid::before {
            content: '✗ ';
            font-weight: bold;
            margin-right: 4px;
        }

        .correlation-warning {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 4px 8px;
            margin: 0;
            display: inline-block;
            font-size: 0.85em;
        }

        .correlation-warning::before {
            content: '⚠ ';
            color: #856404;
        }

        .correlation-warning-text {
            color: #856404;
        }

        .correlation-warning-text {
            color: #856404;
            font-weight: 600;
            flex: 1;
        }

        .manual-select-wrapper {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .manual-select-wrapper label {
            display: block;
            font-size: 0.9em;
            color: #505a5f;
            margin-bottom: 5px;
        }

        /* Duplicate Voters Styles */
        #duplicate-voters {
            max-width: 1200px;
        }

        .duplicate-voter-card {
            background: white;
            border: 2px solid #f47738;
            border-radius: 8px;
            margin-bottom: 30px;
            padding: 20px;
        }

        .duplicate-voter-card h3 {
            margin-top: 0;
            color: #f47738;
            font-size: 1.25em;
        }

        .duplicate-ballot-option {
            border: 2px solid #b1b4b6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .duplicate-ballot-option:hover {
            border-color: #1d70b8;
            background: #f3f2f1;
        }

        .duplicate-ballot-option.selected {
            border-color: #1d70b8;
            background: #e8f4f8;
            border-width: 3px;
        }

        .duplicate-ballot-option.selected::before {
            content: '✓ ';
            color: #1d70b8;
            font-weight: bold;
            font-size: 1.2em;
        }

        .duplicate-ballot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .duplicate-ballot-timestamp {
            color: #66d9ef;
            font-family: monospace;
        }

        .duplicate-ballot-rankings {
            background: #2b2b2b;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 200px;
            overflow-y: auto;
        }

        .duplicate-ballot-rankings div {
            padding: 2px 0;
        }

        .duplicate-ballot-warning {
            color: #d4351c;
            font-style: italic;
            margin-top: 5px;
        }

        /* Ballot Review Styles */
        #ballot-review {
            max-width: 1200px;
        }

        .ballot-review-card {
            background: white;
            border: 2px solid #1d70b8;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .ballot-review-header {
            background: #1d70b8;
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            font-size: 1.1em;
        }

        .ballot-column {
            min-width: 0; /* Ensure columns can shrink */
            /* No width or display properties here to avoid conflicts */
        }

        .ballot-column-header {
            font-weight: bold;
            font-size: 0.9em;
            color: #505a5f;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ballot-original {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            box-sizing: border-box;
        }

        .ballot-mapping {
            background: #f3f6fc;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 15px 10px;
            min-width: 200px;
        }

        .ballot-result {
            background: white;
            border-left: 1px solid #ddd;
        }

        .ballot-original-entry {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-family: monospace;
            font-size: 0.9em;
        }

        .ballot-mapping-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            width: 100%;
            border-bottom: 1px solid #e0e6f0;
        }

        .ballot-mapping-row:last-child {
            border-bottom: none;
        }

        .mapping-arrow {
            color: #1d70b8;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .mapping-count {
            background: #e0e6f0;
            color: #1d70b8;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
            font-weight: bold;
            flex-shrink: 0;
        }

        .mapping-dropdown {
            flex: 1;
            font-size: 0.85em;
            padding: 4px 6px;
            border: 1px solid #b1b4b6;
            border-radius: 4px;
            max-width: 150px;
        }

        .ballot-result-entry {
            padding: 8px 10px;
            margin-bottom: 5px;
            background: #e8f5e9;
            border-radius: 4px;
            border: 1px solid #c8e6c9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ballot-result-rank {
            background: #00703c;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .ballot-result-name {
            color: #00703c;
            font-weight: 600;
        }

        .ballot-result-skipped {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .ballot-result-skipped .ballot-result-name {
            color: #856404;
            font-style: italic;
        }

        .ballot-result-removed {
            background: #f8d7da;
            border-color: #f5c6cb;
        }

        .ballot-result-removed .ballot-result-name {
            color: #721c24;
            font-style: italic;
            text-decoration: line-through;
        }

        .ballot-nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        .ballot-summary {
            background: #f3f2f1;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .ballot-summary-stat {
            display: inline-block;
            margin-right: 20px;
        }

        .ballot-summary-stat strong {
            color: #1d70b8;
        }

        /* NEW: Redesigned Ballot Review Styles */
        .ballot-review-card {
            max-width: 100%;
        }

        .ballot-review-card.ballot-modified {
            border-color: #ffc107;
        }

        .ballot-review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modified-badge {
            background: #ffc107;
            color: #000;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .ballot-review-body {
            display: flex !important;
            flex-direction: column !important;
            gap: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        .ballot-row {
            display: grid !important;
            grid-template-columns: 1fr 1fr !important;
            gap: 0 !important;
            width: 100% !important;
        }

        .ballot-row-original,
        .ballot-row-structured {
            padding: 2px 10px !important;
            border-bottom: 1px solid #444 !important;
            min-height: 28px !important;
            display: flex !important;
            align-items: center !important;
        }

        .ballot-row-original {
            background: #2b2b2b !important;
            color: #f8f8f2 !important;
            font-family: 'Courier New', Consolas, monospace !important;
            font-size: 0.85em !important;
        }

        .ballot-row-structured {
            background: #1e1e1e !important;
            color: #e0e0e0 !important;
        }

        .ballot-original-full {
            background: #2b2b2b;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 500px;
            overflow-y: auto;
            overflow-x: auto;
            min-width: 0; /* Allow to shrink */
        }

        .voter-line {
            color: #66d9ef;
            font-weight: bold;
            min-height: 28px;
            display: flex;
            align-items: center;
        }

        .ranking-line {
            color: #f8f8f2;
            min-height: 44px;
            display: flex;
            align-items: center;
            padding: 8px 0;
        }

        .ballot-structured {
            background: #ffffff;
            padding: 15px;
            border-radius: 6px;
            border: 2px solid #1d70b8;
            min-width: 0 !important; /* Allow to shrink */
            box-sizing: border-box;
        }

        .structured-header {
            display: none; /* Hidden since voter is now in header */
        }

        .structured-rankings {
            max-height: 450px;
            overflow-y: auto;
        }

        .rank-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-height: 44px;
        }

        .rank-row.modified {
            border-color: #ffc107;
            background: #fff3cd;
        }

        .rank-row.spacer {
            background: #f8f8f8;
            border: 1px dashed #999;
            padding: 8px;
            margin-bottom: 8px;
            min-height: 44px;
            opacity: 0.7;
        }

        .rank-row.spacer .rank-number {
            color: #999;
        }

        .rank-row.spacer .spacer-label {
            color: #999;
            font-style: italic;
            font-size: 0.85em;
        }

        .rank-number {
            font-weight: bold;
            color: #1d70b8;
            width: 30px;
            flex-shrink: 0;
        }

        .rank-dropdown {
            flex: 1;
            padding: 6px 8px;
            border: 1px solid #b1b4b6;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .rank-move-btn {
            background: #f3f2f1;
            border: 1px solid #b1b4b6;
            border-radius: 4px;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .rank-move-btn:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .rank-move-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .rank-remove {
            background: #d4351c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rank-remove:hover {
            background: #942514;
        }

        .add-ranking-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
            display: flex;
            gap: 10px;
        }

        .add-ranking-dropdown {
            flex: 1;
            padding: 8px;
            border: 1px solid #b1b4b6;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .add-ranking {
            padding: 8px 16px;
            background: #00703c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
        }

        .add-ranking:hover {
            background: #005a30;
        }

        .reset-ballot-btn {
            margin-top: 15px;
            width: 100%;
            padding: 10px;
            background: #505a5f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .reset-ballot-btn:hover {
            background: #383f43;
        }

    </style>

    <script>
        import { Ballot, STV, getCandidateNumber } from "../../lib/stv";
        import { cleanCandidateName, simplifyVoterName, extractVoterName, parseDiscordBallots } from "../../lib/discord-parser";

        // State for Discord mode
        let inputMode: 'simple' | 'discord' = 'simple';
        let currentBallotIndex = 0;
        
        let parsedData: {
            candidates: string[];
            ballots: Array<{voter: string, rankings: string[]}>;
            seats: number;
            electionName: string;
            nameMatches: Map<string, string | null>;
            uniqueNames: string[];
            currentNameIndex: number;
            nameCounts: Map<string, number>;
            learnedCorrelations: Map<string, string | null>;
            correlationInfluences: Map<string, Set<string>>;
            hasCorrelationWarning: boolean;
            ballotOverrides: Map<string, {rank: number, candidate: string}[]>;
            originalBallotText: Map<string, string>;
            reviewedNames: Set<string>;
            duplicateSelections: Map<string, number>;
            roundResults?: any[];
        } = {
            candidates: [],
            ballots: [],
            seats: 5,
            electionName: '',
            nameMatches: new Map(),
            uniqueNames: [],
            currentNameIndex: 0,
            nameCounts: new Map(),
            learnedCorrelations: new Map(),
            correlationInfluences: new Map(),
            hasCorrelationWarning: false,
            ballotOverrides: new Map(),
            originalBallotText: new Map(),
            reviewedNames: new Set(),
            duplicateSelections: new Map()
        };

        // --- Helper Functions ---

        function getElectionName(): string {
            const input = document.getElementById('election-name') as HTMLInputElement;
            const name = (input?.value || parsedData.electionName || '').trim();
            parsedData.electionName = name;
            return name;
        }

        function slugifyElectionName(name: string): string {
            return name
                .toLowerCase()
                .replace(/[^a-z0-9]+/gi, '-')
                .replace(/-{2,}/g, '-')
                .replace(/^-+|-+$/g, '');
        }

        function buildExportFilename(prefix: string, extension = 'json'): string {
            const name = getElectionName();
            const dateStr = new Date().toISOString().split('T')[0];
            const slug = slugifyElectionName(name);
            const base = slug ? `${prefix}-${slug}` : `${prefix}-${dateStr}`;
            return `${base}.${extension}`;
        }

        function parseOfficialCandidatesLocal(text: string) {
            const lines = text.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            const candidates: string[] = [];
            for (let line of lines) {
                const cleaned = cleanCandidateName(line);
                if (cleaned) candidates.push(cleaned);
            }
            return candidates;
        }

        function fuzzyMatch(name1: string, name2: string) {
            const normalizeChars = (str: string) => str
                .replace(/0/g, 'o')
                .replace(/1/g, 'i')
                .replace(/3/g, 'e')
                .replace(/5/g, 's')
                .replace(/7/g, 't');
            
            const n1 = normalizeChars(name1.toLowerCase()).replace(/[^a-z0-9]/g, '');
            const n2 = normalizeChars(name2.toLowerCase()).replace(/[^a-z0-9]/g, '');
            
            if (n1 === n2) return 1.0;
            if (n1.includes(n2) || n2.includes(n1)) return 0.95;
            
            const words1 = name1.toLowerCase().split(/\s+/);
            const words2 = name2.toLowerCase().split(/\s+/);
            const shorter = n1.length < n2.length ? n1 : n2;
            const longer = n1.length < n2.length ? n2 : n1;
            
            if (shorter.length >= 3 && shorter.length <= 5 && longer.includes(shorter)) {
                if (longer.startsWith(shorter)) return 0.9;
                return 0.85;
            }
            
            if (longer.startsWith(shorter) && shorter.length >= 3) return 0.88;
            if (shorter.length >= 4 && longer.includes(shorter)) return 0.82;
            
            let matchedWords = 0;
            let totalWords = Math.max(words1.length, words2.length);
            
            for (let w1 of words1) {
                for (let w2 of words2) {
                    const cleanW1 = w1.replace(/[^a-z0-9]/g, '');
                    const cleanW2 = w2.replace(/[^a-z0-9]/g, '');
                    if (cleanW1 === cleanW2 && cleanW1.length > 0) {
                        matchedWords++;
                        break;
                    }
                    if (cleanW1.length >= 4 && cleanW2.length >= 4) {
                        if (cleanW1.includes(cleanW2) || cleanW2.includes(cleanW1)) {
                            matchedWords += 0.7;
                            break;
                        }
                        if (cleanW1.startsWith(cleanW2) || cleanW2.startsWith(cleanW1)) {
                            matchedWords += 0.6;
                            break;
                        }
                    }
                }
            }
            
            if (matchedWords > 0) return Math.min(0.75, 0.4 + (matchedWords / totalWords) * 0.5);
            
            let commonChars = 0;
            const chars1 = n1.split('');
            const chars2 = n2.split('');
            for (let char of chars1) {
                if (chars2.includes(char)) commonChars++;
            }
            const overlapRatio = commonChars / Math.max(n1.length, n2.length);
            if (overlapRatio > 0.6) return 0.5;
            
            return 0.0;
        }

        // --- UI Rendering Functions ---

        function updateCorrelationTable() {
            const tableBody = document.getElementById('correlation-table-body');
            const section = document.getElementById('correlation-table-section');
            const countEl = document.getElementById('correlation-count');
            if (!tableBody || !section || !countEl) return;
            
            const correlations = Array.from(parsedData.learnedCorrelations.entries());
            countEl.textContent = correlations.length.toString();
            
            if (correlations.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            tableBody.innerHTML = correlations.map(([pattern, candidate]) => `
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">${pattern}</td>
                    <td class="govuk-table__cell">${candidate || '<em>Invalid</em>'}</td>
                </tr>
            `).join('');
        }

        function renderCurrentName() {
            const container = document.getElementById('name-match-list');
            if (!container) return;
            
            if (parsedData.currentNameIndex >= parsedData.uniqueNames.length) {
                checkForDuplicates();
                return;
            }
            
            const foundName = parsedData.uniqueNames[parsedData.currentNameIndex];
            const count = parsedData.nameCounts.get(foundName) || 0;
            
            // Find suggestions
            const suggestions = parsedData.candidates
                .map(c => ({ name: c, score: fuzzyMatch(foundName, c) }))
                .filter(s => s.score > 0.5)
                .sort((a, b) => b.score - a.score);
            
            const currentMatch = parsedData.nameMatches.get(foundName);
            
            container.innerHTML = `
                <div class="name-match-item">
                    <div class="name-match-header">
                        <span class="found-name">${foundName}</span>
                        <span class="match-count">Found in ${count} ballot${count === 1 ? '' : 's'}</span>
                    </div>
                    
                    <p class="govuk-body-s">Match this name to an official candidate:</p>
                    
                    <div class="match-options">
                        ${suggestions.map(s => `
                            <button class="match-option ${currentMatch === s.name ? 'selected' : ''}" 
                                    onclick="window.selectMatch('${foundName.replace(/'/g, "\\'")}', '${s.name.replace(/'/g, "\\'")}')">
                                ${s.name}
                            </button>
                        `).join('')}
                        
                        <button class="match-option invalid ${currentMatch === '__NOT_A_BALLOT__' ? 'selected' : ''}"
                                onclick="window.selectMatch('${foundName.replace(/'/g, "\\'")}', '__NOT_A_BALLOT__')">
                            Invalid / Not a Candidate
                        </button>
                    </div>
                    
                    <div class="manual-select-wrapper">
                        <label for="manual-select-${parsedData.currentNameIndex}">Or select manually:</label>
                        <select class="govuk-select" id="manual-select-${parsedData.currentNameIndex}" 
                                onchange="window.selectMatch('${foundName.replace(/'/g, "\\'")}', this.value)">
                            <option value="">-- Select Candidate --</option>
                            ${parsedData.candidates.map(c => `
                                <option value="${c}" ${currentMatch === c ? 'selected' : ''}>${c}</option>
                            `).join('')}
                        </select>
                    </div>

                    <div class="match-navigation icenia-button-group">
                        <button class="icenia-btn icenia-btn-secondary match-nav-button" onclick="window.prevName()" ${parsedData.currentNameIndex === 0 ? 'disabled' : ''}>
                            Previous
                        </button>
                        <button class="icenia-btn match-nav-button" onclick="window.nextName()">
                            ${parsedData.currentNameIndex === parsedData.uniqueNames.length - 1 ? 'Finish Matching' : 'Next'}
                        </button>
                    </div>
                </div>
            `;
        }

        function checkForDuplicates() {
            const voterBallots = new Map<string, number[]>();
            parsedData.ballots.forEach((b, index) => {
                if (!voterBallots.has(b.voter)) voterBallots.set(b.voter, []);
                voterBallots.get(b.voter)!.push(index);
            });
            
            const duplicates = Array.from(voterBallots.entries()).filter(([voter, indices]) => indices.length > 1);
            
            if (duplicates.length > 0) {
                document.getElementById('name-matching')!.style.display = 'none';
                document.getElementById('duplicate-voters')!.style.display = 'block';
                renderDuplicateVoters(duplicates);
            } else {
                document.getElementById('name-matching')!.style.display = 'none';
                document.getElementById('ballot-review')!.style.display = 'block';
                renderBallotReview();
            }
        }

        function renderDuplicateVoters(duplicates: [string, number[]][]) {
            const container = document.getElementById('duplicate-voters-content');
            if (!container) return;
            
            container.innerHTML = duplicates.map(([voter, indices]) => `
                <div class="duplicate-voter-card">
                    <h3>Voter: ${voter}</h3>
                    <p class="govuk-body-s">This voter submitted ${indices.length} ballots. Select which one to keep:</p>
                    ${indices.map((idx, i) => {
                        const ballot = parsedData.ballots[idx];
                        const isSelected = parsedData.duplicateSelections.get(voter) === idx || (i === indices.length - 1 && !parsedData.duplicateSelections.has(voter));
                        if (isSelected && !parsedData.duplicateSelections.has(voter)) parsedData.duplicateSelections.set(voter, idx);
                        
                        return `
                            <div class="duplicate-ballot-option ${isSelected ? 'selected' : ''}" onclick="window.resolveDuplicate('${voter.replace(/'/g, "\\'")}', ${idx})">
                                <div class="duplicate-ballot-header">
                                    <span>Ballot #${i + 1}</span>
                                </div>
                                <div class="duplicate-ballot-rankings">
                                    ${ballot.rankings.map((r, rIdx) => `<div>${rIdx + 1}. ${r} → ${parsedData.nameMatches.get(r) || '<em>Unmatched</em>'}</div>`).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `).join('');
        }

        function getBallotRankings(voter: string, ballot: {voter: string, rankings: string[]}) {
            if (parsedData.ballotOverrides.has(voter)) {
                return parsedData.ballotOverrides.get(voter)!;
            }
            return ballot.rankings
                .map(r => parsedData.nameMatches.get(r))
                .filter((r): r is string => !!r && r !== '__NOT_A_BALLOT__')
                .map((c, i) => ({ rank: i + 1, candidate: c }));
        }

        function renderBallotReview() {
            const container = document.getElementById('ballot-review-content');
            const progressEl = document.getElementById('ballot-review-progress');
            if (!container || !progressEl) return;
            
            // Filter out duplicate ballots if any
            const activeBallots = parsedData.ballots.filter((b, idx) => {
                const selectedIdx = parsedData.duplicateSelections.get(b.voter);
                if (selectedIdx !== undefined) return idx === selectedIdx;
                return true;
            });

            if (currentBallotIndex >= activeBallots.length) {
                currentBallotIndex = activeBallots.length - 1;
            }
            if (currentBallotIndex < 0) currentBallotIndex = 0;

            const ballot = activeBallots[currentBallotIndex];
            const voter = ballot.voter;
            
            progressEl.textContent = `Ballot ${currentBallotIndex + 1} of ${activeBallots.length}`;
            
            const originalText = parsedData.originalBallotText.get(voter) || ballot.rankings.join('\n');
            const currentRankings = getBallotRankings(voter, ballot);

            container.innerHTML = `
                <div class="ballot-review-card">
                    <div class="ballot-review-header">
                        <span>Voter: ${voter}</span>
                        ${parsedData.ballotOverrides.has(voter) ? '<span class="modified-badge">Modified</span>' : ''}
                    </div>
                    <div class="ballot-review-body">
                        <div class="ballot-row">
                            <div class="ballot-column">
                                <div class="ballot-column-header">Original Discord Text</div>
                                <div class="ballot-original-full">${originalText}</div>
                            </div>
                            <div class="ballot-column">
                                <div class="ballot-column-header">Structured Rankings</div>
                                <div class="ballot-structured">
                                    <div class="structured-rankings">
                                        ${currentRankings.map((r, i) => `
                                            <div class="rank-row">
                                                <span class="rank-number">${r.rank}.</span>
                                                <select class="rank-dropdown" onchange="window.updateBallotRanking('${voter.replace(/'/g, "\\'")}', ${i}, this.value)">
                                                    ${parsedData.candidates.map(c => `<option value="${c}" ${c === r.candidate ? 'selected' : ''}>${c}</option>`).join('')}
                                                </select>
                                                <button class="rank-move-btn" onclick="window.moveRanking('${voter.replace(/'/g, "\\'")}', ${i}, -1)" ${i === 0 ? 'disabled' : ''}>↑</button>
                                                <button class="rank-move-btn" onclick="window.moveRanking('${voter.replace(/'/g, "\\'")}', ${i}, 1)" ${i === currentRankings.length - 1 ? 'disabled' : ''}>↓</button>
                                                <button class="rank-remove" onclick="window.removeRanking('${voter.replace(/'/g, "\\'")}', ${i})">×</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                    
                                    <div class="add-ranking-container">
                                        <select class="add-ranking-dropdown" id="add-ranking-select">
                                            <option value="">-- Add Candidate --</option>
                                            ${parsedData.candidates.filter(c => !currentRankings.find(r => r.candidate === c)).map(c => `<option value="${c}">${c}</option>`).join('')}
                                        </select>
                                        <button class="add-ranking" onclick="window.addRanking('${voter.replace(/'/g, "\\'")}')">Add</button>
                                    </div>
                                    
                                    <button class="reset-ballot-btn" onclick="window.resetBallot('${voter.replace(/'/g, "\\'")}')">Reset to Original</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ballot-nav-buttons icenia-button-group govuk-!-padding-4">
                        <button class="icenia-btn icenia-btn-secondary" onclick="window.prevBallot()" ${currentBallotIndex === 0 ? 'disabled' : ''}>Previous Ballot</button>
                        <button class="icenia-btn" onclick="window.calculateResults()">Calculate Results</button>
                        <button class="icenia-btn icenia-btn-secondary" onclick="window.nextBallot()" ${currentBallotIndex === activeBallots.length - 1 ? 'disabled' : ''}>Next Ballot</button>
                    </div>
                </div>
            `;
        }

        function proceedToBallotReview() {
            document.getElementById('duplicate-voters')!.style.display = 'none';
            document.getElementById('ballot-review')!.style.display = 'block';
            renderBallotReview();
        }

        function calculateResults() {
            const logEl = document.getElementById('log');
            const winnersEl = document.getElementById('winners');
            if (!logEl || !winnersEl) return;
            
            logEl.innerHTML = '';
            winnersEl.innerHTML = 'Calculating...';
            
            try {
                const candidateReferences = parsedData.candidates;
                
                // Filter out duplicate ballots
                const activeBallots = parsedData.ballots.filter((b, idx) => {
                    const selectedIdx = parsedData.duplicateSelections.get(b.voter);
                    if (selectedIdx !== undefined) return idx === selectedIdx;
                    return true;
                });

                const stvBallots = activeBallots.map(b => {
                    let rankingNumbers: number[] = [];
                    
                    if (parsedData.ballotOverrides.has(b.voter)) {
                        const overrides = parsedData.ballotOverrides.get(b.voter)!;
                        rankingNumbers = overrides.map(o => getCandidateNumber(o.candidate, candidateReferences));
                    } else {
                        rankingNumbers = b.rankings.map(r => {
                            const matchedName = parsedData.nameMatches.get(r);
                            if (!matchedName || matchedName === '__NOT_A_BALLOT__') return null;
                            return getCandidateNumber(matchedName, candidateReferences);
                        }).filter((n): n is number => n !== null && n > 0);
                    }
                    
                    return new Ballot(b.voter, rankingNumbers, 1, candidateReferences.length);
                }).filter(b => b.rankingList.length > 0);

                if (stvBallots.length === 0) {
                    winnersEl.innerHTML = `<p class="govuk-error-message">No valid ballots to calculate.</p>`;
                    return;
                }

                const logs: string[] = [];
                const { winners, roundResults } = STV(stvBallots, parsedData.seats, candidateReferences, (msg) => logs.push(msg));
                parsedData.roundResults = roundResults;
                
                winnersEl.innerHTML = `<strong>The winners are:</strong> ${winners.join(', ')}`;
                logEl.innerHTML = logs.join('');
                
                document.getElementById('ballot-review')!.style.display = 'none';
                document.getElementById('duplicate-voters')!.style.display = 'none';
                document.getElementById('results')!.style.display = 'block';
            } catch (e) {
                winnersEl.innerHTML = `<p class="govuk-error-message">Error calculating results: ${(e as Error).message}</p>`;
            }
        }

        // Expose functions to window for HTML event handlers
        (window as any).selectMatch = (foundName: string, matchedName: string) => {
            parsedData.nameMatches.set(foundName, matchedName === '' ? null : matchedName);
            if (matchedName && matchedName !== '__NOT_A_BALLOT__') {
                parsedData.learnedCorrelations.set(foundName, matchedName);
            }
            renderCurrentName();
            updateCorrelationTable();
        };

        (window as any).nextName = () => {
            parsedData.currentNameIndex++;
            renderCurrentName();
        };

        (window as any).prevName = () => {
            if (parsedData.currentNameIndex > 0) {
                parsedData.currentNameIndex--;
                renderCurrentName();
            }
        };

        (window as any).resolveDuplicate = (voter: string, idx: number) => {
            parsedData.duplicateSelections.set(voter, idx);
            checkForDuplicates();
        };

        (window as any).updateBallotRanking = (voter: string, rankIndex: number, newCandidate: string) => {
            const ballot = parsedData.ballots.find(b => b.voter === voter);
            if (!ballot) return;
            const current = [...getBallotRankings(voter, ballot)];
            current[rankIndex] = { ...current[rankIndex], candidate: newCandidate };
            parsedData.ballotOverrides.set(voter, current);
            renderBallotReview();
        };

        (window as any).moveRanking = (voter: string, rankIndex: number, direction: number) => {
            const ballot = parsedData.ballots.find(b => b.voter === voter);
            if (!ballot) return;
            const current = [...getBallotRankings(voter, ballot)];
            const targetIndex = rankIndex + direction;
            if (targetIndex >= 0 && targetIndex < current.length) {
                const temp = current[rankIndex].candidate;
                current[rankIndex] = { ...current[rankIndex], candidate: current[targetIndex].candidate };
                current[targetIndex] = { ...current[targetIndex], candidate: temp };
                parsedData.ballotOverrides.set(voter, current);
                renderBallotReview();
            }
        };

        (window as any).removeRanking = (voter: string, rankIndex: number) => {
            const ballot = parsedData.ballots.find(b => b.voter === voter);
            if (!ballot) return;
            const current = [...getBallotRankings(voter, ballot)];
            current.splice(rankIndex, 1);
            // Re-rank
            const updated = current.map((r, i) => ({ rank: i + 1, candidate: r.candidate }));
            parsedData.ballotOverrides.set(voter, updated);
            renderBallotReview();
        };

        (window as any).addRanking = (voter: string) => {
            const select = document.getElementById('add-ranking-select') as HTMLSelectElement;
            const candidate = select.value;
            if (!candidate) return;
            
            const ballot = parsedData.ballots.find(b => b.voter === voter);
            if (!ballot) return;
            const current = [...getBallotRankings(voter, ballot)];
            current.push({ rank: current.length + 1, candidate });
            parsedData.ballotOverrides.set(voter, current);
            renderBallotReview();
        };

        (window as any).resetBallot = (voter: string) => {
            parsedData.ballotOverrides.delete(voter);
            renderBallotReview();
        };

        (window as any).nextBallot = () => {
            currentBallotIndex++;
            renderBallotReview();
        };

        (window as any).prevBallot = () => {
            currentBallotIndex--;
            renderBallotReview();
        };

        (window as any).calculateResults = calculateResults;

        // --- Export/Import Logic ---

        function exportElection() {
            const electionName = getElectionName();
            let currentSection = 'import';
            if (document.getElementById('name-matching')?.style.display !== 'none') currentSection = 'name-matching';
            else if (document.getElementById('ballot-review')?.style.display !== 'none') currentSection = 'ballot-review';
            else if (document.getElementById('results')?.style.display !== 'none') currentSection = 'results';
            
            const exportData = {
                version: '2.1',
                timestamp: new Date().toISOString(),
                inputMode: inputMode,
                electionName,
                candidates: parsedData.candidates,
                ballots: parsedData.ballots ? parsedData.ballots.map((b: any) => ({
                    voter: b.voter,
                    rankings: b.rankings
                })) : [],
                rawDiscordInput: {
                    candidates: (document.getElementById('discord-candidates') as HTMLTextAreaElement)?.value || '',
                    ballots: (document.getElementById('discord-ballots') as HTMLTextAreaElement)?.value || '',
                    seats: parsedData.seats
                },
                nameMatches: Object.fromEntries(parsedData.nameMatches),
                learnedCorrelations: Object.fromEntries(parsedData.learnedCorrelations),
                ballotOverrides: Object.fromEntries(parsedData.ballotOverrides),
                originalBallotText: Object.fromEntries(parsedData.originalBallotText),
                reviewedNames: Array.from(parsedData.reviewedNames),
                uniqueNames: parsedData.uniqueNames,
                nameCounts: Object.fromEntries(parsedData.nameCounts),
                currentState: {
                    section: currentSection,
                    currentNameIndex: parsedData.currentNameIndex,
                    currentBallotIndex: currentBallotIndex
                }
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = buildExportFilename('stv-election');
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportForRCVis() {
            const roundResults = (parsedData as any).roundResults;
            if (!roundResults || roundResults.length === 0) {
                alert('No results to export. Please calculate results first.');
                return;
            }
            
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0];
            const electionName = getElectionName();
            const contestName = electionName || 'Icenian Election';
            
            const rcvisData = {
                config: {
                    contest: contestName,
                    date: dateStr,
                    jurisdiction: "Icenia",
                    office: contestName,
                    threshold: (parsedData.ballots.length / (parsedData.seats + 1)).toFixed(3)
                },
                results: roundResults.map((round: any) => ({
                    round: round.round,
                    tally: Object.fromEntries(
                        Object.entries(round.tally).map(([candidate, votes]) => [
                            candidate,
                            (votes as number).toFixed(3)
                        ])
                    ),
                    quota: round.quota ? parseFloat(round.quota.toFixed(3)) : undefined,
                    exhausted: round.exhausted ? parseFloat(round.exhausted.toFixed(3)) : 0,
                    isFinalRound: round.isFinalRound || false,
                    tallyResults: round.tallyResults
                }))
            };
            
            const blob = new Blob([JSON.stringify(rcvisData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = buildExportFilename('rcvis-election');
            a.click();
            URL.revokeObjectURL(url);
        }

        function importElection(file: File) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importData = JSON.parse(e.target?.result as string);
                    if (importData.inputMode) {
                        inputMode = importData.inputMode;
                        localStorage.setItem('input-mode', inputMode);
                        const modeRadio = document.querySelector(`input[name="input-mode"][value="${importData.inputMode}"]`) as HTMLInputElement;
                        if (modeRadio) modeRadio.checked = true;
                        if (inputMode === 'discord') {
                            (document.getElementById('simple-mode') as HTMLElement).style.display = 'none';
                            (document.getElementById('discord-mode') as HTMLElement).style.display = 'block';
                        } else {
                            (document.getElementById('simple-mode') as HTMLElement).style.display = 'block';
                            (document.getElementById('discord-mode') as HTMLElement).style.display = 'none';
                        }
                    }
                    if (importData.rawDiscordInput) {
                        const candidatesInput = document.getElementById('discord-candidates') as HTMLTextAreaElement;
                        const ballotsInput = document.getElementById('discord-ballots') as HTMLTextAreaElement;
                        if (candidatesInput) candidatesInput.value = importData.rawDiscordInput.candidates || '';
                        if (ballotsInput) ballotsInput.value = importData.rawDiscordInput.ballots || '';
                    }
                    if (importData.learnedCorrelations) parsedData.learnedCorrelations = new Map(Object.entries(importData.learnedCorrelations));
                    if (importData.electionName) {
                        parsedData.electionName = importData.electionName;
                        const electionNameInput = document.getElementById('election-name') as HTMLInputElement;
                        if (electionNameInput) electionNameInput.value = parsedData.electionName;
                    }
                    if (importData.candidates) parsedData.candidates = importData.candidates;
                    if (importData.ballots) parsedData.ballots = importData.ballots;
                    if (importData.rawDiscordInput?.seats) parsedData.seats = importData.rawDiscordInput.seats;
                    if (importData.nameMatches) {
                        parsedData.nameMatches = new Map(Object.entries(importData.nameMatches).map(([k, v]) => [k, v === 'null' ? null : v as string | null]));
                    }
                    if (importData.ballotOverrides) parsedData.ballotOverrides = new Map(Object.entries(importData.ballotOverrides).map(([k, v]) => [k, v as any]));
                    if (importData.originalBallotText) parsedData.originalBallotText = new Map(Object.entries(importData.originalBallotText).map(([k, v]) => [k, v as string]));
                    if (importData.reviewedNames) parsedData.reviewedNames = new Set(importData.reviewedNames);
                    if (importData.uniqueNames) parsedData.uniqueNames = importData.uniqueNames;
                    if (importData.nameCounts) parsedData.nameCounts = new Map(Object.entries(importData.nameCounts).map(([k, v]) => [k, v as number]));
                    
                    if (importData.currentState) {
                        parsedData.currentNameIndex = importData.currentState.currentNameIndex || 0;
                        currentBallotIndex = importData.currentState.currentBallotIndex || 0;
                        const section = importData.currentState.section;
                        document.getElementById('import-section')!.style.display = 'none';
                        document.getElementById('simple-mode')!.style.display = 'none';
                        document.getElementById('discord-mode')!.style.display = 'none';
                        if (section === 'name-matching') {
                            document.getElementById('name-matching')!.style.display = 'block';
                            renderCurrentName();
                        } else if (section === 'ballot-review') {
                            document.getElementById('ballot-review')!.style.display = 'block';
                            renderBallotReview();
                        } else if (section === 'results') {
                            document.getElementById('results')!.style.display = 'block';
                            calculateResults();
                        }
                    }
                    updateCorrelationTable();
                    alert('Election imported successfully!');
                } catch (err) {
                    alert('Failed to import election: ' + (err as Error).message);
                }
            };
            reader.readAsText(file);
        }

        function clearSession() {
            if (!confirm('Are you sure you want to clear all data?')) return;
            parsedData = {
                candidates: [], ballots: [], seats: 0, electionName: '', nameMatches: new Map(),
                uniqueNames: [], currentNameIndex: 0, learnedCorrelations: new Map(),
                correlationInfluences: new Map(), hasCorrelationWarning: false, nameCounts: new Map(),
                ballotOverrides: new Map(), originalBallotText: new Map(), reviewedNames: new Set(),
                duplicateSelections: new Map()
            };
            localStorage.removeItem('election-name');
            const electionNameInput = document.getElementById('election-name') as HTMLInputElement;
            if (electionNameInput) electionNameInput.value = '';
            document.getElementById('name-matching')!.style.display = 'none';
            document.getElementById('ballot-review')!.style.display = 'none';
            document.getElementById('results')!.style.display = 'none';
            document.getElementById('import-section')!.style.display = 'block';
            inputMode = 'simple';
            localStorage.setItem('input-mode', 'simple');
            (document.getElementById('mode-simple') as HTMLInputElement).checked = true;
            (document.getElementById('simple-mode') as HTMLElement).style.display = 'block';
            (document.getElementById('discord-mode') as HTMLElement).style.display = 'none';
            updateCorrelationTable();
        }

        // --- Event Listeners ---

        window.addEventListener('DOMContentLoaded', function() {
            // Mode switching
            document.querySelectorAll('input[name="input-mode"]').forEach(radio => {
                radio.addEventListener('change', function(this: HTMLInputElement) {
                    inputMode = this.value as 'simple' | 'discord';
                    localStorage.setItem('input-mode', this.value);
                    document.getElementById('simple-mode')!.style.display = inputMode === 'simple' ? 'block' : 'none';
                    document.getElementById('discord-mode')!.style.display = inputMode === 'discord' ? 'block' : 'none';
                });
            });

            // Restore saved data
            const savedMode = localStorage.getItem('input-mode');
            if (savedMode) {
                const radio = document.querySelector(`input[name="input-mode"][value="${savedMode}"]`) as HTMLInputElement;
                if (radio) { radio.checked = true; radio.dispatchEvent(new Event('change')); }
            }
            const savedCandidates = localStorage.getItem('discord-candidates');
            if (savedCandidates) (document.getElementById('discord-candidates') as HTMLTextAreaElement).value = savedCandidates;
            const savedBallots = localStorage.getItem('discord-ballots');
            if (savedBallots) (document.getElementById('discord-ballots') as HTMLTextAreaElement).value = savedBallots;
            const savedElectionName = localStorage.getItem('election-name');
            if (savedElectionName) {
                (document.getElementById('election-name') as HTMLInputElement).value = savedElectionName;
                parsedData.electionName = savedElectionName;
            }

            // Input listeners
            document.getElementById('discord-candidates')?.addEventListener('input', function(this: HTMLTextAreaElement) { localStorage.setItem('discord-candidates', this.value); });
            document.getElementById('discord-ballots')?.addEventListener('input', function(this: HTMLTextAreaElement) { localStorage.setItem('discord-ballots', this.value); });
            document.getElementById('election-name')?.addEventListener('input', function(this: HTMLInputElement) {
                parsedData.electionName = this.value.trim();
                localStorage.setItem('election-name', parsedData.electionName);
            });

            // Buttons
            document.getElementById('import-election-button')?.addEventListener('click', () => (document.getElementById('import-file-input') as HTMLInputElement).click());
            document.getElementById('import-file-input')?.addEventListener('change', (e) => {
                const file = (e.target as HTMLInputElement).files?.[0];
                if (file) { importElection(file); (e.target as HTMLInputElement).value = ''; }
            });
            document.getElementById('export-election')?.addEventListener('click', exportElection);
            document.getElementById('export-election-review')?.addEventListener('click', exportElection);
            document.getElementById('export-results')?.addEventListener('click', exportElection);
            document.getElementById('export-rcvis')?.addEventListener('click', exportForRCVis);
            document.getElementById('clear-session')?.addEventListener('click', clearSession);
            document.getElementById('clear-session-start')?.addEventListener('click', clearSession);
            document.getElementById('clear-session-review')?.addEventListener('click', clearSession);
            document.getElementById('back-to-discord')?.addEventListener('click', () => {
                document.getElementById('name-matching')!.style.display = 'none';
                document.getElementById('discord-mode')!.style.display = 'block';
            });
            document.getElementById('back-to-name-matching-from-duplicates')?.addEventListener('click', () => {
                document.getElementById('duplicate-voters')!.style.display = 'none';
                document.getElementById('name-matching')!.style.display = 'block';
                parsedData.currentNameIndex = 0; renderCurrentName();
            });
            document.getElementById('proceed-to-ballot-review')?.addEventListener('click', proceedToBallotReview);
            document.getElementById('back-to-name-matching')?.addEventListener('click', () => {
                document.getElementById('ballot-review')!.style.display = 'none';
                document.getElementById('name-matching')!.style.display = 'block';
                parsedData.currentNameIndex = 0; renderCurrentName();
            });
            document.getElementById('recalculate-results')?.addEventListener('click', () => {
                const seatsInput = document.getElementById('results-seats') as HTMLInputElement;
                if (seatsInput) parsedData.seats = parseInt(seatsInput.value);
                calculateResults();
            });
            document.getElementById('return-to-start')?.addEventListener('click', () => {
                document.getElementById('results')!.style.display = 'none';
                document.getElementById('import-section')!.style.display = 'block';
                if (inputMode === 'simple') document.getElementById('simple-mode')!.style.display = 'block';
                else document.getElementById('discord-mode')!.style.display = 'block';
            });

            // Parse Discord
            document.getElementById('parse-discord')?.addEventListener('click', function() {
                const candidatesText = (document.getElementById('discord-candidates') as HTMLTextAreaElement).value;
                const ballotsText = (document.getElementById('discord-ballots') as HTMLTextAreaElement).value;
                const seats = parseInt((document.getElementById('discord-seats') as HTMLInputElement).value);
                if (!candidatesText.trim() || !ballotsText.trim()) { alert('Please enter candidates and ballots'); return; }
                const officialCandidates = parseOfficialCandidatesLocal(candidatesText);
                if (officialCandidates.length === 0) { alert('No valid candidates found'); return; }
                const { ballots, originalBallotText } = parseDiscordBallots(ballotsText);
                if (ballots.length === 0) { alert('No valid ballots found'); return; }
                parsedData.candidates = officialCandidates;
                parsedData.ballots = ballots;
                parsedData.seats = seats;
                parsedData.originalBallotText = originalBallotText;
                const counts = new Map<string, number>();
                const foundNamesSet = new Set<string>();
                ballots.forEach(b => b.rankings.forEach(name => {
                    counts.set(name, (counts.get(name) || 0) + 1);
                    foundNamesSet.add(name);
                }));
                parsedData.nameCounts = counts;
                parsedData.uniqueNames = Array.from(foundNamesSet).sort();
                document.getElementById('discord-mode')!.style.display = 'none';
                document.getElementById('name-matching')!.style.display = 'block';
                renderCurrentName();
                updateCorrelationTable();
            });

            // Simple Mode Calculate
            document.getElementById('calculate')?.addEventListener('click', function() {
                const candidatesText = (document.getElementById('candidates') as HTMLTextAreaElement).value;
                const ballotsText = (document.getElementById('ballots') as HTMLTextAreaElement).value;
                const seats = parseInt((document.getElementById('seats') as HTMLInputElement).value);
                if (!candidatesText.trim() || !ballotsText.trim()) { alert('Please enter candidates and ballots'); return; }
                const candidates = candidatesText.split('\n').map(c => c.trim()).filter(c => c.length > 0);
                const ballotLines = ballotsText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                const ballots: Array<{voter: string, rankings: string[]}> = [];
                const nameMatches = new Map<string, string>();
                for (let line of ballotLines) {
                    const parts = line.split(':');
                    if (parts.length < 2) continue;
                    const voter = parts[0].trim();
                    const rankings = parts[1].split(',').map(r => r.trim()).filter(r => r.length > 0);
                    ballots.push({ voter, rankings });
                    rankings.forEach(r => nameMatches.set(r, r));
                }
                parsedData.candidates = candidates;
                parsedData.ballots = ballots;
                parsedData.seats = seats;
                parsedData.nameMatches = nameMatches;
                calculateResults();
            });

            // Load Example Data
            document.getElementById('loadExample')?.addEventListener('click', function() {
                (document.getElementById('candidates') as HTMLTextAreaElement).value = "Ratat0ing\nDr_Bacon_hair\nhsmnewfriend\nCreepilyCreep\nIsraelGPT";
                (document.getElementById('ballots') as HTMLTextAreaElement).value = "recycler: Ratat0ing, Dr_Bacon_hair, hsmnewfriend\nalzubloxxer11: Dr_Bacon_hair, hsmnewfriend, Ratat0ing\nuser3: hsmnewfriend, Ratat0ing\nuser4: CreepilyCreep, IsraelGPT\nuser5: IsraelGPT, CreepilyCreep";
                (document.getElementById('seats') as HTMLInputElement).value = "2";
            });
        });
    </script>
</PageLayout>
