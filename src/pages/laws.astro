---
import PageLayout from "@layouts/page.astro";
import LawSection from "@components/laws/section.astro";
import Card from "@components/laws/card.astro";

import { Arrays, Strings } from "@helpers";
import { getActChangeColours } from "@comptime";

// Had to rename because it weirdly conflicts with laws.astro
// There's probably some weird Astro shenanigans going on
import { Laws as AllLaws, LawIncorporations } from "../lib/laws";
import { Acts } from "../lib/acts";
import { ScrapedItems } from "../lib/scraped-items";
const laws = await AllLaws.getLaws();

const allActs = await Acts.getActs();
// Type guard: ensure the act has a `changes` array before treating it as an Act
function isActWithChanges(act: any): act is { data: Acts.Act } {
    return act && act.data && Array.isArray((act.data as any).changes);
}

const recentActs = allActs.filter(isActWithChanges).filter(act => (act.data as Acts.Act).changes.length > 0).slice(0, 5);

const currentLaws = laws.filter((law) => law.hidden !== true);
const expiredLaws = laws.filter((law) => law.hidden === true);

// Calculate pending incorporations count
let pendingCount = 0;
for (const law of currentLaws) {
    const pending = await AllLaws.getPendingChanges(law);
    pendingCount += pending.length;
}

const pendingScrapedCount = ScrapedItems.getPendingRepublicCount();

const BASE = import.meta.env.BASE_URL ?? "/";
---
<style>
    .laws-info {
        background: #f3f2f1;
        padding: 20px;
        margin-bottom: 30px;
        border-left: 6px solid #1C70B8;
    }

    div.law-card {
        display: block;
        margin-bottom: 25px;
        box-shadow: 0 1px 1px 0 rgba(60, 64, 67, .08), 0 1px 3px 1px rgba(60, 64, 67, .16);
        color: #373151;
        text-decoration: none;
        font-family: "nta", Arial, sans-serif;
        font-size: 16px;
        line-height: 1.25;
    }

    div.law-card-internal {
        position: relative;
        display: flex;
        padding: 10px 15px 10px 15px;
        border-left: 10px solid #1C70B8;
        justify-content: space-between;
        flex-direction: column;
    }

    div.law-card-content {
        flex-grow: 1;
    }

    div.law-card-title {
        font-size: 20px;
        font-weight: 500;
    }

    div.law-card-supplement {
        padding-right: 15px;
        padding-top: 7px;
        padding-bottom: 7px;
        border-top: 1px dotted rgb(203, 201, 205);
        margin-top: 7px;
        margin-right: -15px;
        margin-bottom: -10px;
        color: #717171;
        font-size: 18px;
        font-weight: 400;
    }

    details.law-details {
        margin-bottom: 0 !important;
    }

    a.open-law-link {
        float: right;
    }

    .pending-banner {
        background: #fef7f3;
        border-left: 6px solid #f47738;
        padding: 15px 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .pending-banner-text {
        margin: 0;
    }

    .pending-count-badge {
        background: #f47738;
        color: white;
        padding: 2px 10px;
        border-radius: 15px;
        font-weight: bold;
    }

    .scraped-tracker {
        background: #fef7f3;
        border-left: 6px solid #f47738;
        padding: 15px 20px;
        margin-bottom: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    .scraped-tracker-text {
        margin: 0;
    }

    .scraped-count-badge {
        background: #f47738;
        color: white;
        padding: 2px 10px;
        border-radius: 15px;
        font-weight: bold;
    }

</style>

<PageLayout chin={false} title="Republic Laws - Republic of Icenia" description="The Constitution, statutes, and treaties of the Republic of Icenia.">
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="govuk-heading-xl" style="margin-bottom: 10px;">Republic Laws</h1>
        <p class="govuk-body-l">The Constitution, statutes, and treaties of the Republic of Icenia.</p>
    </div>

    <!-- Scraped Items Tracker -->
    {pendingScrapedCount > 0 && (
        <div class="scraped-tracker">
            <p class="scraped-tracker-text govuk-body">
                <span class="scraped-count-badge">{pendingScrapedCount}</span>
                {pendingScrapedCount === 1 ? " item has" : " items have"} been scraped and {pendingScrapedCount === 1 ? "is" : "are"} awaiting review.
            </p>
            <a href={BASE + "news/scraped/"} class="govuk-link">View Scraped Items →</a>
        </div>
    )}

    <!-- Pending Incorporations Banner -->
    {pendingCount > 0 && (
        <div class="pending-banner">
            <p class="pending-banner-text govuk-body">
                <span class="pending-count-badge">{pendingCount}</span>
                {pendingCount === 1 ? " amendment needs" : " amendments need"} to be incorporated into master documents.
            </p>
            <a href={BASE + "laws/incorporations/"} class="govuk-link">View Tracker →</a>
        </div>
    )}

    <!-- Laws Information -->
    <div class="laws-info">
        <h2 class="govuk-heading-m" style="margin-top: 0;">About Icenian Law</h2>
        <p class="govuk-body" style="margin-bottom: 0;">
            Icenian law is organised into Constitutional documents, ordinary statutes, statehood acts, 
            and international treaties. All laws are enacted by the Senate and signed by the President 
            in accordance with the Constitution.
        </p>
    </div>

    <!-- Recent Changes Section -->
    <div class="recent-changes-section">
        <h2 class="govuk-heading-m" style="margin-top: 0;">Recent Changes to Legislation</h2>
        {recentActs.length > 0 ? recentActs.map((act) => (
            <div class="change-item">
                <div class="change-info">
                    <div class="change-date">
                        {Strings.formatDate(act.data.date, "dS mmmm yyyy")}
                    </div>
                    <div class="change-title">
                        <a href={BASE + "news/" + act.slug} class="govuk-link">
                            {act.data.headline}
                        </a>
                    </div>
                </div>
                <div class="change-tags">
                    {(act.data as Acts.Act).changes.map((change) => (
                        <strong class="govuk-tag govuk-tag--small" style={`background-color: #${getActChangeColours(change.kind).background}; margin-left: 5px;`}>
                            {change.kind === "passage" ? "Enacted" : change.kind === "amendment" ? "Amended" : change.kind === "repeal" ? "Repealed" : "Changed"}
                        </strong>
                    ))}
                </div>
            </div>
        )) : (
            <div class="change-item">
                <div class="change-info">
                    <div class="change-title" style="color: #6f777b; font-weight: 400;">
                        No recent changes to legislation.
                    </div>
                </div>
            </div>
        )}
    </div>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
            <LawSection
                    header="Constitution"
                    fallback="Icenia currently has no Constitutional documents."
                    laws={currentLaws.filter((law) => law.kind === "constitution")}/>
        </div>
        <div class="govuk-grid-column-one-half">
            <LawSection
                    header="States"
                    fallback="Icenia currently has no States."
                    laws={currentLaws.filter((law) => law.kind === "statehood")}/>
        </div>
    </div>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-one-half">
            <LawSection
                    header="Ordinary Law"
                    fallback="Icenia currently has no statutes."
                    laws={currentLaws.filter((law) => law.kind === "statute")}/>
        </div>
        <div class="govuk-grid-column-one-half">
            <LawSection
                    header="Treaties"
                    fallback="Icenia currently has no treaties."
                    laws={currentLaws.filter((law) => law.kind === "treaty")}/>
        </div>
    </div>

    {Arrays.hasElements(expiredLaws) ? (
        <div>
            <hr/>
            <details class="govuk-details" data-module="govuk-details">
                <summary class="govuk-details__summary">
                <span class="govuk-details__summary-text">
                    Expired Laws
                </span>
                </summary>
                <div class="govuk-details__text">
                    {expiredLaws.map((law) => <Card law={law}/>)}
                </div>
            </details>
        </div>
    ) : ""}

    <!-- Links Section -->
    <div class="govuk-grid-row govuk-!-margin-top-6">
        <div class="govuk-grid-column-one-third">
            <div class="govuk-inset-text">
                <h3 class="govuk-heading-s">Government Officials</h3>
                <p class="govuk-body-s">
                    Meet the elected representatives of the Republic.
                </p>
                <a href={BASE + "government/officials/"} class="govuk-link">View Officials &rarr;</a>
            </div>
        </div>
        <div class="govuk-grid-column-one-third">
            <div class="govuk-inset-text">
                <h3 class="govuk-heading-s">City Laws</h3>
                <p class="govuk-body-s">
                    View ordinances and regulations specific to Icenia City.
                </p>
                <a href={BASE + "icenia-city/laws/"} class="govuk-link">View City Laws &rarr;</a>
            </div>
        </div>
        <div class="govuk-grid-column-one-third">
            <div class="govuk-inset-text">
                <h3 class="govuk-heading-s">Incorporation Tracker</h3>
                <p class="govuk-body-s">
                    Track pending updates to master legal documents.
                </p>
                <a href={BASE + "laws/incorporations/"} class="govuk-link">View Tracker &rarr;</a>
            </div>
        </div>
    </div>
</PageLayout>
