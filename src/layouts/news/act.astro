---
import { type MarkdownLayoutProps } from "astro";
import { Nullish, Arrays, Strings } from "@helpers";
import { type Act, type Law } from "@schemas";
import { News } from "@helpers";
// We still need to fetch laws data, but we should do it in a way that doesn't trigger a circular dependency
import { Laws } from "../../lib/laws";
import { ScrapedItems } from "../../lib/scraped-items";
import { getActChangeColours } from "@comptime";

import PostLayout from "@layouts/news/post.astro";

export type Props = MarkdownLayoutProps<Act>;
const { frontmatter } = Astro.props as Props;
const act = News.ensureAct(frontmatter);
const laws = Arrays.toMap(await Laws.getLaws(), (law) => law.slug);
const BASE = (import.meta.env.BASE_URL ?? "/");

const isUnchecked = ScrapedItems.isUnchecked(act.headline, act.date, false);

---
<PostLayout chin={false}>
    <div class="govuk-panel govuk-panel--confirmation">
        <h1 class="govuk-panel__title">
            {isUnchecked && (
                <div style="margin-bottom: 15px;">
                    <strong class="govuk-tag" style="background-color: #f47738; color: #ffffff;" title="This item was automatically scraped and has not been human-checked.">
                        Awaiting Review
                    </strong>
                </div>
            )}
            {act.headline}
        </h1>
        <div class="govuk-panel__body">
            {Strings.formatDate(act.date, "dS mmmm yyyy")}
        </div>
    </div>

    <div class="govuk-width-container">
        <div class="govuk-grid-row">

            <div class="govuk-grid-column-two-thirds">
                {act.document.value === "" ? <slot><br/></slot> : (<>{function(){
                    switch (act.document.type) {
                        case "markdown":
                            return <>
                                <style>
                                    added {
                                        font-style: italic;
                                        color: #38761d;
                                    }
                                    added:before { content: "\""; }
                                    added:after { content: "\""; }
                                    removed {
                                        font-style: italic;
                                        color: #FF0000;
                                    }
                                    removed:before { content: "\""; }
                                    removed:after { content: "\""; }
                                </style>
                                <div set:html={Strings.parseMarkdown(act.document.value)}/>
                            </>;
                        case "local-file": {
                            // Local files are stored under the site root (e.g. `/archive/...`).
                            // Prepend the build-time BASE so project-site deployments include the repo path.
                            const url = act.document.value?.startsWith("/") ? BASE + act.document.value.replace(/^\//, "") : act.document.value;
                            return <iframe src={url} style="width: 100%; min-width: 100%; max-width: 100%; aspect-ratio: 1 / 1.4142;"></iframe>;
                        }
                        case "remote-file": {
                            // Normalize Google Docs URLs: convert /edit to /preview or append /preview if missing
                            let url = act.document.value;
                            if (url.includes('docs.google.com')) {
                                // Replace /edit with /preview
                                url = url.replace(/\/edit(\?.*)?$/, '/preview');
                                // If no /preview or /edit, append /preview
                                if (!url.includes('/preview') && !url.includes('/edit')) {
                                    url = url.replace(/\/?$/, '/preview');
                                }
                            }
                            return <iframe src={url} style="width: 100%; min-width: 100%; max-width: 100%; aspect-ratio: 1 / 1.4142;"></iframe>;
                        }
                        default:
                            return "UNKNOWN DOCUMENT EMBED!";
                    }
                }()}</>)}
            </div>

            <div class="govuk-grid-column-one-third">
                <style>
                    a.law-link {
                        text-decoration: none;
                    }
                    a.law-link:hover {
                        filter: brightness(85%);
                    }

                    div.law-change {
                        width: 100%;
                        text-align: center;
                        padding: 15px 0;
                        margin-bottom: 10px;
                    }
                    div.law-change:active {
                        border-bottom: 4px solid #000;
                        margin-bottom: 6px;
                    }
                </style>

                {act.changes.map((change) => {
                    // const law = Nullish.mustExist(laws.get(change.target));
                    const law = laws.get(change.target);
                    if (!law) return null;
                    const colours = getActChangeColours(change.kind);
                    const isDocx = law.masterdoc && (law.masterdoc.endsWith('.docx') || law.masterdoc.startsWith('/documents/'));
                    const linkUrl = isDocx 
                        ? `${BASE}laws/viewer?file=${encodeURIComponent(law.masterdoc)}` 
                        : law.masterdoc;
                    return (
                        <a class="govuk-link law-link" href={linkUrl} target="_blank">
                            <div class="law-change" style={`background: #${colours.background}; color: #${colours.text};`}>
                                <b>
                                    {function () {
                                        switch (change.kind) {
                                            case "passage":
                                                return "Enacted";
                                            case "amendment":
                                                return "Amended";
                                            case "repeal":
                                                return "Repealed";
                                            default:
                                                return "UNKNOWN";
                                        }
                                    }()}
                                </b>
                                <br/>
                                {law.name}
                            </div>
                        </a>
                    );
                })}
                
                {act.document.value !== "" ? <slot><br/></slot> : ``}

                <div class="govuk-inset-text" style="margin-top: 20px;">
                    <p class="govuk-body-s">
                        <a href={BASE + "laws/"} class="govuk-link">&larr; Back to Republic Laws</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</PostLayout>
