---
import { Astros, Structs } from "@helpers";
import { TITLE, DESCRIPTION, getBordersLink } from "@comptime";

interface Props {
    title?: string,
    description?: string,
    keywords?: string[],
    noheader?: boolean
}

const {
    title = TITLE,
    description = DESCRIPTION,
    keywords = [],
    noheader = false
} = Astro.props;

// Use the build-time base (import.meta.env.BASE_URL) so links and assets
// resolve correctly when this is deployed as a GitHub Pages project site
// under https://<user>.github.io/<repo>/
const BASE = (import.meta.env.BASE_URL ?? "/");

// Navigation structure with dropdowns
interface NavItem {
    label: string;
    href?: string;
    target?: "_self" | "_blank" | "_parent" | "_top";
    children?: NavItem[];
}

const navigationItems: NavItem[] = [
    {
        label: "Government",
        // href: BASE + "government/officials/",
        children: [
            { label: "Officials", href: BASE + "government/officials/" },
            { label: "News", href: BASE + "news/" },
            { label: "Legislation", href: BASE + "laws/" },
        ]
    },
    {
        label: "Explore Icenia",
        // href: BASE,
        children: [
            { label: "The Republic", href: BASE + "union/" },
            { label: "CivMap", href: Astros.isDevMode() ? BASE + "government/map" : getBordersLink(Astro), target: "_blank" },
        ]
    },
    {
        label: "Icenia City",
        // href: BASE + "icenia-city/",
        children: [
            { label: "Home", href: BASE + "icenia-city/" },
            { label: "City Council", href: BASE + "icenia-city/council/" },
            { label: "City Laws", href: BASE + "icenia-city/laws/" },
            { label: "Shops", href: BASE + "icenia-city/shops/" },
        ]
    },
    {
        label: "Join Us",
        // href: BASE + "guide/",
        children: [
            { label: "New Player Guide", href: BASE + "guide/" },
            { label: "Discord", href: "https://discord.gg/dfwSjCjRN5", target: "_blank" }
        ]
    }
];

// Add Admin link in dev mode only
// if (Astros.isDevMode()) {
//     navigationItems.push({
//         label: "Admin",
//         href: BASE + "admin/index.html"
//     });
// }

// CSS variable for primary nav toggle font size - change this value to adjust
const navToggleFontSize = "16px";

// Header height constants (in pixels) - used for both CSS and JS calculations
const HEADER_HEIGHT_DESKTOP = 56;
const HEADER_HEIGHT_MOBILE = 44;
---
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>{title}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content={description}>
        <meta name="keywords" content={keywords.join(",")}>
        <link rel="canonical" href={Astro.url}>
        <link rel="shortcut icon" href={BASE + "favicon.ico"}/>
        <link rel="stylesheet" href={BASE + "assets/css/sanitize-13.0.0.css"}/>
    <link rel="stylesheet" href={BASE + "assets/css/govuk-frontend-4.3.1.min.css"}/>
    <link rel="stylesheet" href={BASE + "assets/css/icenia-theme.css"}/>
    <script is:inline src="/assets/js/govuk-frontend-4.3.1.min.js"></script>
        <style define:vars={{ 
            navToggleFontSize, 
            headerHeightDesktop: HEADER_HEIGHT_DESKTOP + 'px',
            headerHeightMobile: HEADER_HEIGHT_MOBILE + 'px'
        }}>
            body {
               min-height: 100vh;
               overflow-y: scroll; /* Show scrollbars */
               padding-top: var(--headerHeightDesktop); /* space for fixed header */
            }
            
            @media (max-width: 768px) {
                body {
                    padding-top: var(--headerHeightMobile);
                }
            }
        </style>
    </head>
    <body data-base={BASE} data-header-height-desktop={HEADER_HEIGHT_DESKTOP} data-header-height-mobile={HEADER_HEIGHT_MOBILE}>
        <a class="govuk-skip-link" href="#main-content">Skip to main content</a>
        <script is:inline>document.body.className = ((document.body.className) ? document.body.className + " js-enabled" : "js-enabled");</script>

            <style define:vars={{ navToggleFontSize }}>
                /* Custom Header - maintains govuk visual style */
                .icenia-header {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    z-index: 9999;
                    background: #0b0c0c;
                    color: #ffffff;
                    font-family: arial, sans-serif;
                    -webkit-font-smoothing: antialiased;
                    -moz-osx-font-smoothing: grayscale;
                }
                
                .icenia-header__container {
                    max-width: 960px;
                    margin: 0 auto;
                    padding: 0px 0px;
                    box-sizing: border-box;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }
                                
                .icenia-header__logo {
                    display: flex;
                    align-items: center;
                }
                
                .icenia-header__link {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    color: #ffffff;
                    text-decoration: none;
                    font-weight: 700;
                    font-size: 32px;
                    line-height: 1;
                }
                
                .icenia-header__link:hover {
                    text-decoration: underline;
                    text-decoration-thickness: 3px;
                    text-underline-offset: 4px;
                }
                
                .icenia-header__link:focus {
                    outline: 3px solid transparent;
                    color: #0b0c0c;
                    background-color: #fd0;
                    box-shadow: 0 -2px #fd0, 0 4px #0b0c0c;
                    text-decoration: none;
                }
                
                .icenia-header__logo-img {
                    width: calc(var(--headerHeightDesktop, 56px) - 0px);
                    height: calc(var(--headerHeightDesktop, 56px) - 0px);
                }
                
                @media (max-width: 768px) {
                    .icenia-header__container {
                        padding: 0px 0px 3px 0px;
                    }
                    
                    .icenia-header__link {
                        font-size: 24px;
                    }
                    
                    .icenia-header__logo-img {
                        width: 44px;
                        height: 44px;
                    }
                }
                
                /* Menu Toggle Button (hamburger) */
                .icenia-menu-toggle {
                    display: none; /* Hidden by default, shown via JS when needed */
                    background: transparent;
                    border: none;
                    padding: 8px;
                    cursor: pointer;
                    color: #ffffff;
                    z-index: 10001;
                }
                
                .icenia-menu-toggle:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                }
                
                .icenia-menu-toggle:focus {
                    outline: 3px solid transparent;
                    color: #0b0c0c;
                    background-color: #fd0;
                    box-shadow: 0 -2px #fd0, 0 4px #0b0c0c;
                }
                
                .icenia-menu-toggle__icon {
                    display: block;
                    width: 24px;
                    height: 20px;
                    position: relative;
                }
                
                .icenia-menu-toggle__icon span {
                    display: block;
                    position: absolute;
                    height: 3px;
                    width: 100%;
                    background: currentColor;
                    border-radius: 2px;
                    left: 0;
                    transition: transform 0.25s ease, opacity 0.25s ease;
                }
                
                .icenia-menu-toggle__icon span:nth-child(1) {
                    top: 0;
                }
                
                .icenia-menu-toggle__icon span:nth-child(2) {
                    top: 8px;
                }
                
                .icenia-menu-toggle__icon span:nth-child(3) {
                    top: 16px;
                }
                
                /* Hamburger to X animation */
                .icenia-menu-toggle.is-active .icenia-menu-toggle__icon span:nth-child(1) {
                    transform: rotate(45deg);
                    top: 8px;
                }
                
                .icenia-menu-toggle.is-active .icenia-menu-toggle__icon span:nth-child(2) {
                    opacity: 0;
                }
                
                .icenia-menu-toggle.is-active .icenia-menu-toggle__icon span:nth-child(3) {
                    transform: rotate(-45deg);
                    top: 8px;
                }
                
                /* Separate Navigation Bar */
                .icenia-navbar {
                    background: #0b0c0c;
                    position: sticky;
                    top: var(--headerHeightDesktop, 56px);
                    z-index: 998;
                }
                
                @media (max-width: 768px) {
                    .icenia-navbar {
                        top: var(--headerHeightMobile, 44px);
                    }
                }
                
                .icenia-navbar__container {
                    max-width: 960px;
                    margin: 0 auto;
                    padding: 0 15px;
                    box-sizing: border-box;
                    border-bottom: 10px solid var(--icenia-blue, #1C70B8);
                }
                
                @media (min-width: 40.0625em) {
                    .icenia-navbar__container {
                        padding: 0 0px;
                    }
                }
                
                /* Navigation list - default: single row, right-aligned */
                .icenia-navbar__list {
                    width: 100%;
                    display: flex;
                    flex-wrap: nowrap;
                    justify-content: flex-end;
                    align-items: stretch;
                    gap: 0;
                    margin: 0;
                    padding: 0;
                    list-style: none;
                }
                
                /* Navigation items */
                .icenia-navbar__item {
                    position: relative;
                    display: flex;
                    align-items: stretch;
                }
                
                /* Primary navigation link styling */
                .icenia-navbar__item > .icenia-navbar__link {
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                    padding: 12px 16px;
                    color: #ffffff;
                    text-decoration: none;
                    font-family: arial, sans-serif;
                    font-weight: 700;
                    font-size: var(--navToggleFontSize) !important;
                    line-height: 1.25;
                    white-space: nowrap;
                    cursor: pointer;
                    transition: background-color 0.15s ease;
                }
                
                .icenia-navbar__item > .icenia-navbar__link:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                    text-decoration: underline;
                    text-decoration-thickness: 3px;
                    text-underline-offset: 4px;
                }
                
                .icenia-navbar__item > .icenia-navbar__link:focus {
                    outline: 3px solid transparent;
                    color: #0b0c0c;
                    background-color: #fd0;
                    box-shadow: 0 -2px #fd0, 0 4px #0b0c0c;
                    text-decoration: none;
                }
                
                /* Dropdown arrow */
                .icenia-navbar__link.has-dropdown::after {
                    content: '';
                    display: inline-block;
                    width: 0;
                    height: 0;
                    margin-left: 4px;
                    border-left: 4px solid transparent;
                    border-right: 4px solid transparent;
                    border-top: 5px solid currentColor;
                    transition: transform 0.2s ease;
                }
                
                .icenia-navbar__item:hover > .icenia-navbar__link.has-dropdown::after {
                    transform: rotate(180deg);
                }
                
                /* Active state for current section */
                .icenia-navbar__item.active > .icenia-navbar__link {
                    background-color: var(--off-white, #eeeeee);
                    color: #0b0c0c;
                }
                
                .icenia-navbar__item.active > .icenia-navbar__link.has-dropdown::after {
                    border-top-color: #0b0c0c;
                }
                
                /* Dropdown menu - default (horizontal layout) */
                .icenia-navbar__dropdown {
                    position: absolute;
                    top: 100%;
                    left: 0;
                    background: #0b0c0c;
                    padding: 0;
                    margin: 0;
                    list-style: none;
                    clip-path: inset(0 0 100% 0);
                    opacity: 1;
                    visibility: visible;
                    transition: clip-path 0.3s ease;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    /* Width is set dynamically via JS to match parent link */
                }
                
                .icenia-navbar__item:hover > .icenia-navbar__dropdown {
                    clip-path: inset(0 0 0 0);
                }
                
                .icenia-navbar__dropdown li {
                    margin: 0;
                    padding: 0;
                }
                
                .icenia-navbar__dropdown a {
                    display: block;
                    padding: 12px 16px;
                    color: #ffffff;
                    text-decoration: none;
                    font-family: arial, sans-serif;
                    font-weight: 400;
                    font-size: 14px;
                    line-height: 1.25;
                    white-space: nowrap;
                    transition: background-color 0.15s ease;
                }
                
                .icenia-navbar__dropdown a:hover,
                .icenia-navbar__dropdown a:focus {
                    background-color: rgba(255, 255, 255, 0.1);
                    color: #ffffff;
                    text-decoration: underline;
                    text-decoration-thickness: 3px;
                    text-underline-offset: 4px;
                }
                
                .icenia-navbar__dropdown a:focus {
                    outline: 3px solid transparent;
                    background-color: #fd0;
                    color: #0b0c0c;
                    box-shadow: 0 -2px #fd0, 0 4px #0b0c0c;
                    text-decoration: none;
                }
                
                /* Active child item (current page) */
                .icenia-navbar__dropdown a.active {
                    background-color: var(--icenia-blue, #1C70B8);
                    color: #ffffff;
                }
                
                .icenia-navbar__dropdown a.active:hover,
                .icenia-navbar__dropdown a.active:focus {
                    background-color: var(--icenia-blue, #1C70B8);
                }
                
                /* ========================================
                   SLIDE-OUT MENU (when horizontal doesn't fit)
                   ======================================== */
                
                /* Overlay backdrop */
                .icenia-menu-overlay {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 9997;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                }
                
                .icenia-menu-overlay.is-visible {
                    display: block;
                    opacity: 1;
                }
                
                /* Slide-out menu panel */
                .icenia-slide-menu {
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 280px;
                    max-width: 85vw;
                    height: 100%;
                    background: #0b0c0c;
                    z-index: 10000;
                    transform: translateX(-100%);
                    transition: transform 0.3s ease;
                    overflow-y: auto;
                    display: none;
                }
                
                .icenia-slide-menu.is-open {
                    transform: translateX(0);
                }
                
                .icenia-slide-menu__header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px;
                    border-bottom: 1px solid #333;
                }
                
                .icenia-slide-menu__title {
                    color: #ffffff;
                    font-family: arial, sans-serif;
                    font-weight: 700;
                    font-size: 18px;
                    margin: 0;
                }
                
                .icenia-slide-menu__close {
                    background: transparent;
                    border: none;
                    color: #ffffff;
                    font-size: 24px;
                    cursor: pointer;
                    padding: 4px 8px;
                    line-height: 1;
                }
                
                .icenia-slide-menu__close:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                }
                
                .icenia-slide-menu__close:focus {
                    outline: 3px solid transparent;
                    color: #0b0c0c;
                    background-color: #fd0;
                }
                
                .icenia-slide-menu__nav {
                    padding: 0;
                    margin: 0;
                    list-style: none;
                }
                
                .icenia-slide-menu__item {
                    border-bottom: 1px solid #333;
                }
                
                .icenia-slide-menu__link {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 16px;
                    color: #ffffff;
                    text-decoration: none;
                    font-family: arial, sans-serif;
                    font-weight: 700;
                    font-size: 16px;
                    cursor: pointer;
                    transition: background-color 0.15s ease;
                }
                
                .icenia-slide-menu__link:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                }
                
                .icenia-slide-menu__link:focus {
                    outline: 3px solid transparent;
                    color: #0b0c0c;
                    background-color: #fd0;
                }
                
                .icenia-slide-menu__link.has-children::after {
                    content: '';
                    width: 0;
                    height: 0;
                    border-top: 5px solid transparent;
                    border-bottom: 5px solid transparent;
                    border-left: 6px solid currentColor;
                    transition: transform 0.2s ease;
                }
                
                .icenia-slide-menu__link.has-children.is-expanded::after {
                    transform: rotate(90deg);
                }
                
                .icenia-slide-menu__link.active {
                    background-color: var(--off-white, #eeeeee);
                    color: #0b0c0c;
                }
                
                /* Submenu in slide menu */
                .icenia-slide-menu__submenu {
                    display: none;
                    padding: 0;
                    margin: 0;
                    list-style: none;
                    background: #1a1a1a;
                }
                
                .icenia-slide-menu__submenu.is-open {
                    display: block;
                }
                
                .icenia-slide-menu__submenu li {
                    margin: 0;
                    padding: 0;
                }
                
                .icenia-slide-menu__submenu a {
                    display: block;
                    padding: 12px 16px 12px 32px;
                    color: #ffffff;
                    text-decoration: none;
                    font-family: arial, sans-serif;
                    font-weight: 400;
                    font-size: 14px;
                    transition: background-color 0.15s ease;
                }
                
                .icenia-slide-menu__submenu a:hover {
                    background-color: rgba(255, 255, 255, 0.1);
                }
                
                .icenia-slide-menu__submenu a:focus {
                    outline: 3px solid transparent;
                    color: #0b0c0c;
                    background-color: #fd0;
                }
                
                .icenia-slide-menu__submenu a.active {
                    background-color: var(--icenia-blue, #1C70B8);
                    color: #ffffff;
                }
                
                /* When menu mode is active */
                body.menu-mode .icenia-menu-toggle {
                    display: block;
                }
                
                body.menu-mode .icenia-navbar {
                    display: none;
                }
                
                body.menu-mode .icenia-slide-menu {
                    display: block;
                }
                
                /* Prevent body scroll when menu is open */
                body.menu-open {
                    overflow: hidden;
                }
            </style>
            
            <!-- Custom Header bar with logo -->
            <header class="icenia-header" role="banner">
                <div class="icenia-header__container">
                    <div class="icenia-header__logo">
                        <a href={BASE} class="icenia-header__link">
                            <img src={BASE + "assets/images/icenia_logo.png"} class="icenia-header__logo-img" alt="" />
                            <span>Icenia</span>
                        </a>
                    </div>
                    <button class="icenia-menu-toggle" id="menuToggle" aria-label="Open menu" aria-expanded="false">
                        <span class="icenia-menu-toggle__icon">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                    </button>
                </div>
            </header>
            
            <!-- Slide-out menu (for mobile/narrow screens) -->
            <div class="icenia-menu-overlay" id="menuOverlay"></div>
            <nav class="icenia-slide-menu" id="slideMenu" aria-label="Mobile navigation">
                <div class="icenia-slide-menu__header">
                    <span class="icenia-slide-menu__title">Menu</span>
                    <button class="icenia-slide-menu__close" id="menuClose" aria-label="Close menu">&times;</button>
                </div>
                <ul class="icenia-slide-menu__nav">
                    {navigationItems.map((item) => (
                        item.children ? (
                            <li class="icenia-slide-menu__item">
                                <span class="icenia-slide-menu__link has-children" data-toggle="submenu">
                                    {item.label}
                                </span>
                                <ul class="icenia-slide-menu__submenu">
                                    {item.children.map((child) => (
                                        <li>
                                            <a href={child.href} target={child.target || "_self"}>
                                                {child.label}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </li>
                        ) : (
                            <li class="icenia-slide-menu__item">
                                <a class="icenia-slide-menu__link" href={item.href} target={item.target || "_self"}>
                                    {item.label}
                                </a>
                            </li>
                        )
                    ))}
                </ul>
            </nav>
            
            <!-- Separate Navigation Bar (for desktop/wide screens) -->
            <nav class="icenia-navbar" aria-label="Main navigation">
                <div class="icenia-navbar__container govuk-width-container">
                    <ul class="icenia-navbar__list" id="navigation">
                        {navigationItems.map((item) => (
                            item.children ? (
                                <li class="icenia-navbar__item">
                                    {item.href ? (
                                        <a class="icenia-navbar__link has-dropdown" href={item.href} target={item.target || "_self"}>
                                            {item.label}
                                        </a>
                                    ) : (
                                        <span class="icenia-navbar__link has-dropdown">
                                            {item.label}
                                        </span>
                                    )}
                                    <ul class="icenia-navbar__dropdown">
                                        {item.children.map((child) => (
                                            <li>
                                                <a href={child.href} target={child.target || "_self"}>
                                                    {child.label}
                                                </a>
                                            </li>
                                        ))}
                                    </ul>
                                </li>
                            ) : (
                                <li class="icenia-navbar__item">
                                    <a class="icenia-navbar__link" href={item.href} target={item.target || "_self"}>
                                        {item.label}
                                    </a>
                                </li>
                            )
                        ))}
                    </ul>
                </div>
            </nav>
        </>

        <slot/>

        <script is:inline>GOVUKFrontend.initAll()</script>
        <script is:inline>
            (function(){
                const BASE = (document.body && document.body.dataset && document.body.dataset.base) ? document.body.dataset.base : "/";
                if(!BASE) return;
                try {
                    document.querySelectorAll('img[src^="/"], a[href^="/"]')
                        .forEach((el) => {
                            ["src","href"].forEach((attr) => {
                                if(!el.hasAttribute(attr)) return;
                                const val = el.getAttribute(attr);
                                if(!val || !val.startsWith('/')) return;
                                if(val.startsWith(BASE)) return; // already rewritten
                                el.setAttribute(attr, BASE + val.replace(/^\//, ''));
                            });
                        });
                } catch (e) {
                    // noop
                }
            })();
        </script>
        <script is:inline>
            (function(){
                // For each dropdown item, measure both the link and dropdown menu width
                // and set both to the larger of the two
                const dropdownItems = document.querySelectorAll('.icenia-navbar__item');

                function normalize(p){ return p ? p.replace(/\/+$/, '/') : '/'; }

                dropdownItems.forEach(item => {
                    const menu = item.querySelector('.icenia-navbar__dropdown');
                    const parentLink = item.querySelector('.icenia-navbar__link');
                    if (!menu || !parentLink) return;

                    // Make menu measurable without affecting layout
                    const origMenuStyles = {
                        position: menu.style.position || '',
                        visibility: menu.style.visibility || '',
                        display: menu.style.display || '',
                        clipPath: menu.style.clipPath || '',
                        width: menu.style.width || '',
                        minWidth: menu.style.minWidth || ''
                    };
                    
                    menu.style.position = 'absolute';
                    menu.style.visibility = 'hidden';
                    menu.style.display = 'block';
                    menu.style.clipPath = 'none';
                    menu.style.width = 'auto';
                    menu.style.minWidth = '0';

                    // Measure the widest item inside the dropdown menu
                    let maxDropdownWidth = 0;
                    const links = menu.querySelectorAll('a');
                    links.forEach(a => {
                        // Temporarily ensure auto width for measurement
                        const origWidth = a.style.width;
                        a.style.width = 'auto';
                        const w = a.scrollWidth;
                        a.style.width = origWidth;
                        if (w > maxDropdownWidth) maxDropdownWidth = w;
                    });
                    
                    // Also check menu's natural width
                    const menuNaturalWidth = menu.scrollWidth || 0;
                    maxDropdownWidth = Math.max(maxDropdownWidth, menuNaturalWidth);

                    // Measure the parent link's natural width
                    const origLinkStyles = {
                        width: parentLink.style.width || '',
                        minWidth: parentLink.style.minWidth || ''
                    };
                    parentLink.style.width = 'auto';
                    parentLink.style.minWidth = '0';
                    
                    // Force reflow
                    void parentLink.offsetWidth;
                    
                    const linkNaturalWidth = parentLink.scrollWidth || 0;

                    // Determine the final width (the larger of the two)
                    const finalWidth = Math.max(maxDropdownWidth, linkNaturalWidth);

                    // Apply the same width to both elements
                    parentLink.style.width = finalWidth + 'px';
                    parentLink.style.minWidth = finalWidth + 'px';
                    menu.style.width = finalWidth + 'px';
                    menu.style.minWidth = '0'; // No minimum width on dropdown
                   
                    // Restore other menu styles
                    menu.style.position = origMenuStyles.position;
                    menu.style.visibility = origMenuStyles.visibility;
                    menu.style.display = origMenuStyles.display;
                    menu.style.clipPath = origMenuStyles.clipPath;
                });

                // Active-state detection (mark dropdown and matching child link)
                // Note: Only mark child dropdown links active on an exact path match
                // to avoid highlighting the index/parent child when a deeper route is active.
                const currentPathRaw = window.location.pathname || '/';
                const currentPath = normalize(currentPathRaw);

                dropdownItems.forEach(item => {
                    const menuLinks = item.querySelectorAll('.icenia-navbar__dropdown a');
                    let hasActiveChild = false;

                    menuLinks.forEach(link => {
                        const href = link.getAttribute('href');
                        if (!href) return;
                        let linkPath;
                        try { linkPath = new URL(href, window.location.origin).pathname; } catch (e) { linkPath = href; }
                        const normLink = normalize(linkPath);

                        // Mark child link active only on exact match (avoid prefix matches like
                        // '/icenia-city/' matching '/icenia-city/laws/')
                        if (normLink === currentPath) {
                            link.classList.add('active');
                            hasActiveChild = true;
                        }
                    });

                    const toggle = item.querySelector('.icenia-navbar__link');
                    // Keep existing behavior for marking the parent item active when the current
                    // path is within that section (so the parent nav shows the active section)
                    if (toggle && toggle.getAttribute('href')) {
                        try {
                            const tPath = new URL(toggle.getAttribute('href'), window.location.origin).pathname.replace(/\/+$/, '/');
                            if (tPath !== '/' && currentPath.startsWith(tPath)) hasActiveChild = true;
                        } catch (e) {
                            // ignore
                        }
                    }

                    if (hasActiveChild) item.classList.add('active');
                });
            })();
        </script>
        <script is:inline>
            // Responsive navbar: horizontal navbar OR slide-out menu
            (function(){
                const navList = document.querySelector('.icenia-navbar__list');
                const navbar = document.querySelector('.icenia-navbar');
                const navContainer = document.querySelector('.icenia-navbar__container');
                const menuToggle = document.getElementById('menuToggle');
                const menuClose = document.getElementById('menuClose');
                const slideMenu = document.getElementById('slideMenu');
                const menuOverlay = document.getElementById('menuOverlay');
                
                if (!navList || !menuToggle || !slideMenu || !navbar) return;
                
                // Measure the total width needed for horizontal navbar
                function measureHorizontalWidth() {
                    let total = 0;
                    const items = navList.querySelectorAll('.icenia-navbar__item');
                    items.forEach(item => {
                        const link = item.querySelector('.icenia-navbar__link');
                        if (link) {
                            // Get computed styles to account for padding
                            const style = window.getComputedStyle(link);
                            const paddingLeft = parseFloat(style.paddingLeft) || 0;
                            const paddingRight = parseFloat(style.paddingRight) || 0;
                            // Use scrollWidth for the content width, which includes padding
                            total += link.scrollWidth;
                        }
                    });
                    return total;
                }
                
                // Get the actual available width in the navbar container
                function getAvailableWidth() {
                    if (!navContainer) return window.innerWidth;
                    
                    const style = window.getComputedStyle(navContainer);
                    const paddingLeft = parseFloat(style.paddingLeft) || 0;
                    const paddingRight = parseFloat(style.paddingRight) || 0;
                    
                    // The container has max-width: 960px, so we need to consider that
                    const maxWidth = 960;
                    const screenWidth = window.innerWidth;
                    
                    // Calculate container width (min of screen width and max-width)
                    let containerWidth = Math.min(screenWidth, maxWidth);
                    
                    // Subtract padding
                    return containerWidth - paddingLeft - paddingRight;
                }
                
                // Check if horizontal navbar fits
                function checkNavbarFit() {
                    // Temporarily ensure navbar is visible for measurement
                    const wasMenuMode = document.body.classList.contains('menu-mode');
                    const wasMenuOpen = slideMenu.classList.contains('is-open');
                    
                    // Remove menu mode temporarily to measure navbar
                    document.body.classList.remove('menu-mode');
                    
                    // Force reflow to ensure styles are applied
                    void navList.offsetWidth;
                    
                    // Wait a tiny bit for styles to settle, then measure
                    const horizontalWidth = measureHorizontalWidth();
                    const availableWidth = getAvailableWidth();
                    
                    
                    // Small tolerance to avoid edge-case flickering
                    const tolerance = 10;
                    
                    const needsMenuMode = horizontalWidth > availableWidth - tolerance;
                    
                    // Debug logging (can be removed in production)
                    // console.log('Horizontal width:', horizontalWidth, 'Available:', availableWidth, 'Needs menu:', needsMenuMode);
                    
                    if (needsMenuMode) {
                        document.body.classList.add('menu-mode');
                    } else {
                        document.body.classList.remove('menu-mode');
                        // Also close the menu if it was open
                        closeMenu();
                    }
                }
                
                // Open slide menu
                function openMenu() {
                    slideMenu.classList.add('is-open');
                    menuOverlay.classList.add('is-visible');
                    menuToggle.classList.add('is-active');
                    menuToggle.setAttribute('aria-expanded', 'true');
                    document.body.classList.add('menu-open');
                }
                
                // Close slide menu
                function closeMenu() {
                    slideMenu.classList.remove('is-open');
                    menuOverlay.classList.remove('is-visible');
                    menuToggle.classList.remove('is-active');
                    menuToggle.setAttribute('aria-expanded', 'false');
                    document.body.classList.remove('menu-open');
                }
                
                // Toggle slide menu
                function toggleMenu() {
                    if (slideMenu.classList.contains('is-open')) {
                        closeMenu();
                    } else {
                        openMenu();
                    }
                }
                
                // Event listeners for menu toggle
                menuToggle.addEventListener('click', toggleMenu);
                menuClose.addEventListener('click', closeMenu);
                menuOverlay.addEventListener('click', closeMenu);
                
                // Handle submenu toggles in slide menu
                const submenuToggles = document.querySelectorAll('.icenia-slide-menu__link.has-children');
                submenuToggles.forEach(toggle => {
                    toggle.addEventListener('click', function() {
                        const submenu = this.nextElementSibling;
                        if (submenu && submenu.classList.contains('icenia-slide-menu__submenu')) {
                            this.classList.toggle('is-expanded');
                            submenu.classList.toggle('is-open');
                        }
                    });
                });
                
                // Close menu on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && slideMenu.classList.contains('is-open')) {
                        closeMenu();
                        menuToggle.focus();
                    }
                });
                
                // Run on load (with a small delay to ensure styles are loaded)
                // Use requestAnimationFrame to ensure DOM is fully rendered
                requestAnimationFrame(function() {
                    requestAnimationFrame(function() {
                        checkNavbarFit();
                    });
                });
                
                let resizeTimeout;
                window.addEventListener('resize', function() {
                    clearTimeout(resizeTimeout);
                    resizeTimeout = setTimeout(checkNavbarFit, 100);
                });
            })();
        </script>
    </body>
</html>
