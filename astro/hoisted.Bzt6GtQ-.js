class X{name;rankingList;votingPower;candidateCount;constructor(a,i,t,l){this.name=a,this.rankingList=[...i],this.votingPower=t,this.candidateCount=l}getRankedChoice(a){for(let i of this.rankingList)if(i!==-1){if(a===1)return i;a--}return 0}eliminate(a){for(let i=0;i<this.rankingList.length;i++)this.rankingList[i]===a&&(this.rankingList[i]=-1)}isExhausted(){for(let a of this.rankingList)if(a!==-1&&a!==0)return!1;return!0}}function O(e,a){let i=0,t=0,l=[];for(let n of e)n.getRankedChoice(1)===a&&(i+=n.votingPower*1,l.push(n)),n.getRankedChoice(2)===a&&(t+=n.votingPower*.001),n.getRankedChoice(3)===a&&(t+=n.votingPower*1e-6);return{primaryVotes:i,tieBreakerValue:t,totalScore:i+t,counted:l}}function K(e,a,i){if(!e||e.length===0)return-1;const t=new Array(i).fill(0);for(let n=0;n<t.length;n++)t[n]=O(e,n+1).totalScore;let l=-1;for(let n=0;n<t.length;n++)if(t[n]!==0){l=n+1;break}if(l===-1)return a===1?-1:1;for(let n=0;n<t.length;n++)a*t[n]>a*t[l-1]&&t[n]!==0&&(l=n+1);return l}function G(e,a){for(let i of e)i.eliminate(a)}function ee(e,a){const i=e.trim().toLowerCase();for(let t=0;t<a.length;t++)if(a[t].toLowerCase()===i)return t+1;return 0}function te(e,a,i,t){const l=i.length;t(`STV with ${a} winners, ${l} candidates, ${e.length} ballots

`);const n=[];let s=e.length;const r=[];let p=1,m=0;for(;n.length<a;){t(`--- Round ${p} ---
`);const c={};for(let v=0;v<l;v++){const E=v+1,{primaryVotes:T}=O(e,E);T>0&&(c[i[v]]=T)}const u=Object.entries(c).sort((v,E)=>E[1]-v[1]);for(const[v,E]of u)t(`  ${v}: ${E.toFixed(3)} votes
`);t(`
`);const g=K(e,1,l);if(g===-1){t(`
ERROR: Cannot determine top candidate. Stopping election.
`,"error");break}const{primaryVotes:f,totalScore:w,counted:b}=O(e,g),h=s/(a+1),L={round:p,tally:c,quota:h,exhausted:m,tallyResults:[]};if(w>=h){const v=i[g-1];n.push(v),t(`<span class="stv-log-win">✓ WIN: ${v} (${w.toFixed(3)} votes, Quota: ${h.toFixed(3)})
</span>`,"win"),L.tallyResults.push({elected:v,transfers:{}}),G(e,g);const E=Math.max(0,(f-h)/f);for(let T of b)T.votingPower*=E}else{const v=K(e,-1,l);if(v===-1){t(`
ERROR: Cannot determine bottom candidate. Stopping election.
`,"error");break}const E=i[v-1],{primaryVotes:T,counted:z}=O(e,v);t(`<span class="stv-log-elim">✗ ELIM: ${E} (${T.toFixed(3)} votes from ${z.length} ballots)
</span>`,"elim"),L.tallyResults.push({eliminated:E,transfers:{}}),G(e,v);for(let q of z){const U=q.getRankedChoice(1),Z=U>0?i[U-1]:"[exhausted]";t(`  ${q.name} (power: ${q.votingPower.toFixed(3)}) → ${Z}
`)}}r.push(L),p++;let k=0,_=0;for(let v of e)v.isExhausted()&&v.votingPower>0&&(k++,_+=v.votingPower,s-=v.votingPower,v.votingPower=0);m+=_,k>0&&t(`  ${k} ballot(s) exhausted (total power: ${_.toFixed(3)})
`),t(`  Total remaining voting power: ${s.toFixed(3)}

`)}const y={};for(const c of n){const u=r.find(g=>g.tallyResults.some(f=>f.elected===c));u&&(y[c]=u.quota)}const d=s/(a+1);return r.push({round:p,tally:y,quota:d,exhausted:m,tallyResults:[],isFinalRound:!0}),{winners:n,roundResults:r}}function S(e){return e.replace(/@/g,"").replace(/^\d+\.?\s*/,"").replace(/\([^)]*\)/g,"").replace(/["']/g,"").trim().replace(/\s+/g," ")}function C(e){const a=["ex-councilor","ex councilor","councilor","council","mayor","president","ceo","speaker","turbo janny","senator","judge","trial_len","lord","sir"];let i=e.trim();for(const t of a){const l=new RegExp(`^${t}\\s+`,"i");i=i.replace(l,"")}return i=i.replace(/[^a-zA-Z0-9_\s]/g,"").replace(/\s+/g,"").toLowerCase(),i||e.toLowerCase().replace(/[^a-z0-9]/g,"")}function P(e){const a=e.match(/^(.+?)\s*—\s*(\d{1,2}:\d{2}|\d{1,2}\/\d{1,2}\/\d{4}|Yesterday at|Today at)/i);if(a)return a[1].trim();const i=e.split(/\s*—\s*/);return i.length>0?i[0].trim():e.trim()}function ne(e){const a=e.split(`
`),i=[],t=new Set,l=new Map;let n=null,s=[],r=0;const p=new Map,m=c=>/—\s*(\d{1,2}:\d{2}|\d{1,2}\/\d{1,2}\/\d{4}|Yesterday at|Today at)/i.test(c),y=c=>{for(let u=c+1;u<a.length;u++){const g=a[u].trim();if(g)return{line:g,index:u}}return null},d=(c,u,g)=>{const f=(p.get(c)||0)+1;p.set(c,f);const w=f>1?`${c}#${f}`:c;i.push({voter:w,rankings:[...u]}),l.set(w,a.slice(r,g+1).join(`
`))};for(let c=0;c<a.length;c++){const u=a[c].trim();if(!u)continue;const g=m(u),f=S(u);let w=!1;if(!g&&f){const b=y(c);if(b&&m(b.line)){const h=P(b.line);(!h||h.length<2||h.startsWith("—"))&&(w=!0)}}if(g||w){if(n&&s.length>0&&d(n,s,c-1),r=c,g){n=C(P(u)),s=[];const b=u.split(/\d{2}:\d{2}/)[1];if(b){const h=S(b);h&&h!==n&&(s.push(h),t.add(h))}}else if(w){n=C(f),s=[];const b=y(c);b&&(c=b.index)}}else{const b=S(u);if(!b||b.length<2||/^[\d\.\)\-]+$/.test(b))continue;const h=b.toLowerCase();if(h.includes("barred from")||h.includes("write-in"))continue;n&&(s.push(b),t.add(b))}}return n&&s.length>0&&d(n,s,a.length-1),{ballots:i,allFoundNames:Array.from(t),originalBallotText:l}}let $="simple",I=0,o={candidates:[],ballots:[],seats:5,electionName:"",nameMatches:new Map,uniqueNames:[],currentNameIndex:0,nameCounts:new Map,learnedCorrelations:new Map,correlationInfluences:new Map,hasCorrelationWarning:!1,ballotOverrides:new Map,originalBallotText:new Map,reviewedNames:new Set,duplicateSelections:new Map,ballotStructuredLines:new Map,ballotManuallyModified:new Set};function H(){const a=(document.getElementById("election-name")?.value||o.electionName||"").trim();return o.electionName=a,a}function oe(e){return e.toLowerCase().replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/^-+|-+$/g,"")}function Q(e,a="json"){const i=H(),t=new Date().toISOString().split("T")[0],l=oe(i);return`${l?`${e}-${l}`:`${e}-${t}`}.${a}`}function ae(e){const a=e.split(`
`).map(t=>t.trim()).filter(t=>t.length>0),i=[];for(let t of a){const l=S(t);l&&i.push(l)}return i}function le(e,a){const i=f=>f.replace(/0/g,"o").replace(/1/g,"i").replace(/3/g,"e").replace(/5/g,"s").replace(/7/g,"t"),t=i(e.toLowerCase()).replace(/[^a-z0-9]/g,""),l=i(a.toLowerCase()).replace(/[^a-z0-9]/g,"");if(t===l)return 1;if(t.includes(l)||l.includes(t))return .95;const n=e.toLowerCase().split(/\s+/),s=a.toLowerCase().split(/\s+/),r=t.length<l.length?t:l,p=t.length<l.length?l:t;if(r.length>=3&&r.length<=5&&p.includes(r))return p.startsWith(r)?.9:.85;if(p.startsWith(r)&&r.length>=3)return .88;if(r.length>=4&&p.includes(r))return .82;let m=0,y=Math.max(n.length,s.length);for(let f of n)for(let w of s){const b=f.replace(/[^a-z0-9]/g,""),h=w.replace(/[^a-z0-9]/g,"");if(b===h&&b.length>0){m++;break}if(b.length>=4&&h.length>=4){if(b.includes(h)||h.includes(b)){m+=.7;break}if(b.startsWith(h)||h.startsWith(b)){m+=.6;break}}}if(m>0)return Math.min(.75,.4+m/y*.5);let d=0;const c=t.split(""),u=l.split("");for(let f of c)u.includes(f)&&d++;return d/Math.max(t.length,l.length)>.6?.5:0}function D(){const e=document.getElementById("correlation-table-body"),a=document.getElementById("correlation-table-section"),i=document.getElementById("correlation-count");if(!e||!a||!i)return;const t=Array.from(o.learnedCorrelations.entries());if(i.textContent=t.length.toString(),t.length===0){a.style.display="none";return}a.style.display="block",e.innerHTML=t.map(([l,n])=>`
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">${l}</td>
                    <td class="govuk-table__cell">${n===null?'<em style="color: #d4351c;">(Not a candidate)</em>':n==="__NOT_A_BALLOT__"?'<em style="color: #505a5f;">(Not a ballot entry)</em>':n}</td>
                </tr>
            `).join("")}function B(){const e=document.getElementById("name-match-list");if(!e)return;if(o.currentNameIndex>=o.uniqueNames.length){M();return}const a=o.uniqueNames[o.currentNameIndex],i=o.nameCounts.get(a)||0,t=o.candidates.map(s=>({name:s,score:le(a,s)})).filter(s=>s.score>.5).sort((s,r)=>r.score-s.score);o.nameMatches.get(a)===void 0&&t.length>0&&t[0].score>.7&&(o.nameMatches.set(a,t[0].name),o.learnedCorrelations.set(a,t[0].name));const n=o.nameMatches.get(a);e.innerHTML=`
                <div class="match-progress">
                    Reviewing name ${o.currentNameIndex+1} of ${o.uniqueNames.length}
                </div>
                
                <div class="govuk-inset-text" style="margin-top: 10px; font-size: 0.85em;">
                    <strong>Keyboard shortcuts:</strong>
                    <span style="display: block; margin-top: 5px;">
                        <kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">←</kbd><kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">→</kbd> or <kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">Enter</kbd><kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">Shift+Enter</kbd> Navigate • 
                        <kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">1</kbd>-<kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">9</kbd> Quick select
                        <br>
                        <kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">N</kbd> Not candidate • 
                        <kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">M</kbd> Not Ballot Entry • 
                        <kbd style="background: #f3f2f1; padding: 2px 6px; border: 1px solid #b1b4b6; border-radius: 3px; font-family: monospace;">W</kbd> Focus dropdown
                    </span>
                </div>
                
                <div class="name-match-item">
                    <div class="name-match-header">
                        <span class="found-name">${a}</span>
                        <span class="match-count">Found in ${i} ballot${i===1?"":"s"}</span>
                    </div>
                    
                    <p class="govuk-body-s">Match this name to an official candidate:</p>
                    
                    <div class="match-options">
                        ${t.map((s,r)=>`
                            <button class="match-option ${n===s.name?"selected":""}" 
                                    data-index="${r+1}"
                                    onclick="window.selectMatch('${a.replace(/'/g,"\\'")}', '${s.name.replace(/'/g,"\\'")}')">
                                ${r+1}. ${s.name} (${Math.round(s.score*100)}%)
                            </button>
                        `).join("")}

                        <button data-type="invalid" class="match-option ${n===null?"invalid selected":""}"
                            onclick="window.selectMatch('${a.replace(/'/g,"\\'")}', '__INVALID__')">
                            N. Not a Candidate (skip)
                        </button>

                        <button data-type="not-ballot" class="match-option ${n==="__NOT_A_BALLOT__"?"not-ballot selected":""}"
                            onclick="window.selectMatch('${a.replace(/'/g,"\\'")}', '__NOT_A_BALLOT__')">
                            M. Not a Ballot Entry (remove)
                        </button>
                    </div>
                    
                    <div class="manual-select-wrapper">
                        <label for="manual-select-${o.currentNameIndex}">Or select manually:</label>
                        <select class="govuk-select" id="manual-select-${o.currentNameIndex}" 
                                onchange="window.selectMatch('${a.replace(/'/g,"\\'")}', this.value)">
                            <option value="">-- Select Candidate --</option>
                            ${o.candidates.map(s=>`
                                <option value="${s}" ${n===s?"selected":""}>${s}</option>
                            `).join("")}
                            <option value="__INVALID__" ${n===null?"selected":""}>Not a candidate - skip ranking</option>
                            <option value="__NOT_A_BALLOT__" ${n==="__NOT_A_BALLOT__"?"selected":""}>Not a ballot entry - remove</option>
                        </select>
                    </div>

                    <div class="match-navigation icenia-button-group">
                        <button class="icenia-btn icenia-btn-secondary match-nav-button" onclick="window.prevName()" ${o.currentNameIndex===0?"disabled":""}>
                            ← Previous
                        </button>
                        <button class="icenia-btn match-nav-button" onclick="window.nextName()">
                            ${o.currentNameIndex===o.uniqueNames.length-1?"Finish Matching →":"Next →"}
                        </button>
                    </div>
                </div>
            `}function M(){const e=new Map;o.ballots.forEach((i,t)=>{const l=i.voter.replace(/#\d+$/,"");e.has(l)||e.set(l,[]),e.get(l).push(t)});const a=Array.from(e.entries()).filter(([i,t])=>t.length>1);a.length>0?(document.getElementById("name-matching").style.display="none",document.getElementById("duplicate-voters").style.display="block",Y(a)):(document.getElementById("name-matching").style.display="none",document.getElementById("ballot-review").style.display="block",x())}function Y(e){const a=document.getElementById("duplicate-voters-content");a&&(A=e.map(([i,t])=>({voter:i,ballotIndices:t})),a.innerHTML=e.map(([i,t])=>{const l=[...t].sort((n,s)=>{const r=o.ballots[n],p=o.ballots[s],m=o.originalBallotText.get(r.voter)||"",y=o.originalBallotText.get(p.voter)||"",d=m.match(/—\s*(\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}\s+[ap]m)/i)?.[1],c=y.match(/—\s*(\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}\s+[ap]m)/i)?.[1];return!d||!c?0:new Date(c).getTime()-new Date(d).getTime()});if(!o.duplicateSelections.has(i)){let n=-1;for(const s of l)if(o.ballots[s].rankings.filter(m=>{const y=o.nameMatches.get(m);return y&&y!=="__NOT_A_BALLOT__"}).length>0){n=s;break}n===-1&&l.length>0&&(n=l[0]),n!==-1&&o.duplicateSelections.set(i,n)}return`
                <div class="duplicate-voter-card">
                    <h3>Voter: ${i} (${t.length} ballots found)</h3>
                    <p class="govuk-body-s">Select which ballot to keep:</p>
                    ${l.map((n,s)=>{const r=o.ballots[n],p=o.duplicateSelections.get(i)===n,m=o.originalBallotText.get(r.voter)||"";let y="Unknown time";const d=m.match(/—\s*(\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}\s*(?:am|pm))/i);if(d)y=d[1];else{const u=m.match(/—\s*(\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2})/i);if(u){const[g,f]=u[1].split(/\s+/),[w,b]=f.split(":").map(k=>parseInt(k,10)),h=w%12===0?12:w%12,L=w>=12?"pm":"am";y=`${g} ${h}:${String(b).padStart(2,"0")} ${L}`}else{const g=m.match(/—\s*(\d{1,2}:\d{2})(?:\s*(am|pm))?/i);if(g){const f=parseInt(g[1].split(":")[0],10),w=parseInt(g[1].split(":")[1],10),b=g[2],h=new Date,L=h.getMonth()+1,k=h.getDate(),_=h.getFullYear();let v=f,E="am";b?E=b.toLowerCase():(E=f>=12?"pm":"am",v=f%12===0?12:f%12),y=`${L}/${k}/${_} ${v}:${String(w).padStart(2,"0")} ${E}`}}}const c=r.rankings.filter(u=>{const g=o.nameMatches.get(u);return g&&g!=="__NOT_A_BALLOT__"});return`
                            <div class="duplicate-ballot-option ${p?"selected":""}" onclick="window.resolveDuplicate('${i.replace(/'/g,"\\'")}', ${n})">
                                <div class="duplicate-ballot-header">
                                    <span>Ballot #${s+1}</span>
                                    <span class="duplicate-ballot-timestamp">${y}</span>
                                </div>
                                <div class="duplicate-ballot-rankings">
                                    ${r.rankings.length===0?'<div style="color: #999; font-style: italic;">No rankings found</div>':r.rankings.map((u,g)=>{const f=o.nameMatches.get(u);return f&&f!=="__NOT_A_BALLOT__"?`<div style="color: #50fa7b;">${g+1}. ${u} → ${f}</div>`:f==="__NOT_A_BALLOT__"?`<div style="color: #999;">${g+1}. ${u} → (removed)</div>`:`<div style="color: #ff5555;">${g+1}. ${u} → (invalid)</div>`}).join("")}
                                    ${c.length>0?`<div style="margin-top: 8px; color: #50fa7b; font-weight: 600;">${c.length} valid ranking${c.length===1?"":"s"}</div>`:'<div style="margin-top: 8px; color: #ff5555; font-weight: 600;">0 valid rankings</div>'}
                                </div>
                            </div>
                        `}).join("")}
                </div>
            `}).join(""))}function ie(e){return e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):""}function se(e,a,i){if(!e)return{type:"empty"};const t=e.trim();if(t.length===0)return{type:"empty"};if(i){try{const n=C(e||""),s=(a||"").replace(/#\d+$/,""),r=C(s),m=(o.originalBallotText.get(a)||"").split(`
`)[0],y=P(m),d=C(y||"");if(n&&r&&d){if(n===r||n===d||n.startsWith(r)||r.startsWith(n)||n.startsWith(d)||d.startsWith(n))return{type:"voter"}}else if(n&&r&&(n===r||n.startsWith(r)||r.startsWith(n)))return{type:"voter"}}catch{}if(/[\u2013\u2014\-–—]/.test(t)&&/[A-Za-z]/.test(t))return{type:"voter"}}if(/\d{1,2}[:\/]\d{1,2}/.test(t)||/\d{1,4}\/\d{1,4}\/\d{2,4}/.test(t))return{type:"timecode"};const l=S(e||"");if(l){const n=o.nameMatches.get(l);if(n&&n!=="__NOT_A_BALLOT__")return{type:"candidate",value:n};if(n===null)return{type:"not-candidate"};if(n==="__NOT_A_BALLOT__")return{type:"not-ballot"}}return/^@?\w[\w\s\._-]{0,50}$/.test(t)?{type:"not-candidate"}:{type:"not-candidate"}}function V(e){if(o.ballotStructuredLines.has(e))return o.ballotStructuredLines.get(e);const i=(o.originalBallotText.get(e)||"").split(`
`),t=[],l=new Set;let n=!1;for(const s of i){const r=se(s,e,!n);r.type==="voter"&&(n=!0),r.type==="candidate"&&r.value?l.has(r.value)?t.push({type:"duplicate",value:r.value}):(l.add(r.value),t.push(r)):t.push(r)}return o.ballotStructuredLines.set(e,t),t}function re(e){const a=new Set;for(const i of e)i.type==="candidate"&&i.value&&a.add(i.value);return a}function ce(e,a){const i=re(e),t=e[a]?.value;return o.candidates.filter(l=>l===t||!i.has(l))}function de(e){return`rank-row-${e.type}`}function x(){const e=document.getElementById("ballot-review-content"),a=document.getElementById("ballot-review-progress");if(!e||!a)return;const i=o.ballots.filter((d,c)=>{const u=d.voter.replace(/#\d+$/,""),g=o.duplicateSelections.get(u);return g!==void 0?c===g:!0});I>=i.length&&(I=i.length-1),I<0&&(I=0);const t=i[I],l=t.voter;a.textContent=`Ballot ${I+1} of ${i.length}`;const s=(o.originalBallotText.get(l)||t.rankings.join(`
`)).split(`
`),r=V(l),p=o.ballotManuallyModified.has(l);let m="",y=0;for(let d=0;d<s.length;d++){const c=s[d]||"",u=r[d]||{type:"empty"},g=ie(c);let f="";u.type==="candidate"&&u.value?(y++,f=`<span class="rank-number">${y}.</span>`):u.type==="duplicate"?f='<span class="rank-number-duplicate">Dup</span>':f='<span class="rank-number">&nbsp;</span>';const w=ce(r,d),b=r.some((k,_)=>k.type==="voter"&&_!==d),h=[...w.map(k=>`<option value="candidate:${k}" ${u.type==="candidate"&&u.value===k?"selected":""}>${k}</option>`),`<option value="empty" ${u.type==="empty"?"selected":""}>[Empty Line]</option>`,`<option value="voter" ${u.type==="voter"?"selected":""} ${b?"disabled":""}>[Voter Header]</option>`,`<option value="timecode" ${u.type==="timecode"?"selected":""}>[Timecode]</option>`,`<option value="not-candidate" ${u.type==="not-candidate"?"selected":""}>[Not a Candidate]</option>`,`<option value="not-ballot" ${u.type==="not-ballot"?"selected":""}>[Not a Ballot Entry]</option>`,`<option value="duplicate" ${u.type==="duplicate"?"selected":""}>[Duplicate Candidate]</option>`].join(""),L=`
                    <div class="rank-row ${de(u)}">
                        ${f}
                        <select class="rank-dropdown" onchange="window.updateStructuredLine('${l.replace(/'/g,"\\'").replace(/"/g,"&quot;")}', ${d}, this.value)">
                            ${h}
                        </select>
                        <button class="rank-move-btn" onclick="window.moveStructuredLine('${l.replace(/'/g,"\\'").replace(/"/g,"&quot;")}', ${d}, -1)" ${d===0?"disabled":""}>↑</button>
                        <button class="rank-move-btn" onclick="window.moveStructuredLine('${l.replace(/'/g,"\\'").replace(/"/g,"&quot;")}', ${d}, 1)" ${d===s.length-1?"disabled":""}>↓</button>
                    </div>
                `;m+=`
                    <div class="ballot-row">
                        <div class="ballot-row-original">${g}</div>
                        <div class="ballot-row-structured">${L}</div>
                    </div>
                `}e.innerHTML=`
                <div class="ballot-review-card ${p?"ballot-modified":""}">
                    <div class="ballot-review-header">
                        <span>Voter: ${l}</span>
                        ${p?'<span class="modified-badge">Modified</span>':""}
                    </div>
                    <div class="ballot-review-body">
                        <div class="ballot-row ballot-row-header">
                            <div class="ballot-row-original"><div class="ballot-column-header">Original Discord Text</div></div>
                            <div class="ballot-row-structured"><div class="ballot-column-header">Structured Rankings</div></div>
                        </div>
                        ${m}
                        <div style="width:100%; padding: 15px;">
                            <button class="reset-ballot-btn" onclick="window.resetBallot('${l.replace(/'/g,"\\'").replace(/"/g,"&quot;")}')">Reset to Auto-Detected</button>
                        </div>
                    </div>
                    <div class="ballot-nav-buttons icenia-button-group govuk-!-padding-4">
                        <button class="icenia-btn icenia-btn-secondary" onclick="window.prevBallot()" ${I===0?"disabled":""}>Previous Ballot</button>
                        <button class="icenia-btn" onclick="window.calculateResults()">Calculate Results</button>
                        <button class="icenia-btn icenia-btn-secondary" onclick="window.nextBallot()" ${I===i.length-1?"disabled":""}>Next Ballot</button>
                    </div>
                </div>
            `}function W(){document.getElementById("duplicate-voters").style.display="none",document.getElementById("ballot-review").style.display="block",x()}function R(){const e=document.getElementById("log"),a=document.getElementById("winners");if(!(!e||!a)){e.innerHTML="",a.innerHTML="Calculating...";try{const i=o.candidates,l=o.ballots.filter((p,m)=>{const y=p.voter.replace(/#\d+$/,""),d=o.duplicateSelections.get(y);return d!==void 0?m===d:!0}).map(p=>{const d=V(p.voter).filter(c=>c.type==="candidate"&&c.value).map(c=>c.value).map(c=>ee(c,i)).filter(c=>c!==null&&c>0);return new X(p.voter,d,1,i.length)}).filter(p=>p.rankingList.length>0);if(l.length===0){a.innerHTML='<p class="govuk-error-message">No valid ballots to calculate.</p>';return}const n=[],{winners:s,roundResults:r}=te(l,o.seats,i,p=>n.push(p));o.roundResults=r,a.innerHTML=`<strong>The winners are:</strong> ${s.join(", ")}`,e.innerHTML=n.join(""),document.getElementById("ballot-review").style.display="none",document.getElementById("duplicate-voters").style.display="none",document.getElementById("results").style.display="block"}catch(i){a.innerHTML=`<p class="govuk-error-message">Error calculating results: ${i.message}</p>`}}}window.selectMatch=(e,a)=>{const i=a===""||a==="__INVALID__"?null:a==="__NOT_A_BALLOT__"?"__NOT_A_BALLOT__":a;o.nameMatches.set(e,i);const t=e.toLowerCase().replace(/^[\d\.\s]+/,"").replace(/[\d\s]+$/,"");a==="__INVALID__"?o.learnedCorrelations.set(t,null):a==="__NOT_A_BALLOT__"?o.learnedCorrelations.set(t,"__NOT_A_BALLOT__"):a&&a!==""&&o.learnedCorrelations.set(t,a),B(),D()};window.nextName=()=>{o.currentNameIndex++,B()};window.prevName=()=>{o.currentNameIndex>0&&(o.currentNameIndex--,B())};window.resolveDuplicate=(e,a)=>{o.duplicateSelections.set(e,a),M()};window.updateStructuredLine=(e,a,i)=>{const t=V(e);if(!(a<0||a>=t.length)){if(o.ballotManuallyModified.add(e),i.startsWith("candidate:")){const l=i.substring(10);t[a]={type:"candidate",value:l}}else i==="empty"?t[a]={type:"empty"}:i==="voter"?t[a]={type:"voter"}:i==="timecode"?t[a]={type:"timecode"}:i==="not-candidate"?t[a]={type:"not-candidate"}:i==="not-ballot"?t[a]={type:"not-ballot"}:i==="duplicate"&&(t[a]={type:"duplicate"});o.ballotStructuredLines.set(e,t),x()}};window.moveStructuredLine=(e,a,i)=>{const t=V(e);(o.originalBallotText.get(e)||"").split(`
`);const n=a+i;if(n<0||n>=t.length)return;o.ballotManuallyModified.add(e);const s=t[a];t[a]=t[n],t[n]=s,o.ballotStructuredLines.set(e,t),x()};window.resetBallot=e=>{o.ballotStructuredLines.delete(e),o.ballotManuallyModified.delete(e),x()};window.nextBallot=()=>{I++,x()};window.prevBallot=()=>{I--,x()};window.calculateResults=R;let A=[],N=0;function J(e){if(A.length===0)return;const a=A[N];if(!a)return;const i=o.duplicateSelections.get(a.voter),t=i!==void 0?a.ballotIndices.indexOf(i):a.ballotIndices.length-1;let l=t;e==="up"&&t>0&&l--,e==="down"&&t<a.ballotIndices.length-1&&l++,l!==t&&(o.duplicateSelections.set(a.voter,a.ballotIndices[l]),M())}document.addEventListener("keydown",function(e){if(e.target instanceof HTMLSelectElement||e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement||e.target instanceof HTMLButtonElement)return;const a=document.getElementById("duplicate-voters");if(a&&a.style.display==="block"){e.key==="ArrowUp"?(e.preventDefault(),J("up")):e.key==="ArrowDown"?(e.preventDefault(),J("down")):e.key==="Enter"&&!e.shiftKey?(e.preventDefault(),N<A.length-1?(N++,M()):W()):e.key==="Enter"&&e.shiftKey||e.key==="ArrowLeft"?(e.preventDefault(),N>0&&(N--,M())):e.key==="ArrowRight"&&(e.preventDefault(),N<A.length-1?(N++,M()):W());return}const i=document.getElementById("ballot-review");if(i&&i.style.display==="block"){e.key==="ArrowLeft"||e.key==="Enter"&&e.shiftKey?(e.preventDefault(),I>0&&(I--,x())):(e.key==="ArrowRight"||e.key==="Enter")&&(e.preventDefault(),I<o.ballots.length-1&&(I++,x()));return}const t=document.getElementById("name-matching");if(!t||t.style.display!=="block"||o.currentNameIndex>=o.uniqueNames.length)return;if(e.key==="w"||e.key==="W"){const n=document.querySelector(".manual-select-wrapper select");n&&(e.preventDefault(),n.focus());return}if(e.key==="ArrowLeft"&&o.currentNameIndex>0){e.preventDefault();const n=o.uniqueNames[o.currentNameIndex];o.reviewedNames.add(n),o.currentNameIndex--,B()}else if(e.key==="ArrowRight"&&o.currentNameIndex<o.uniqueNames.length){e.preventDefault();const n=o.uniqueNames[o.currentNameIndex];o.reviewedNames.add(n),o.currentNameIndex++,B()}if(e.key==="Enter"&&!e.shiftKey&&o.currentNameIndex<o.uniqueNames.length){e.preventDefault();const n=o.uniqueNames[o.currentNameIndex];o.reviewedNames.add(n),o.currentNameIndex++,B()}else if(e.key==="Enter"&&e.shiftKey&&o.currentNameIndex>0){e.preventDefault();const n=o.uniqueNames[o.currentNameIndex];o.reviewedNames.add(n),o.currentNameIndex--,B()}if(e.key.match(/^[1-9]$/)){const n=parseInt(e.key)-1,s=document.querySelectorAll('.match-option:not([data-type="invalid"]):not([data-type="not-ballot"])');s[n]&&(e.preventDefault(),s[n].click())}if(e.key==="n"||e.key==="N"){const n=document.querySelectorAll(".match-option"),s=Array.from(n).find(r=>(r.textContent||"").toLowerCase().includes("not a candidate"));s&&(e.preventDefault(),s.click())}if(e.key==="m"||e.key==="M"){const n=document.querySelectorAll(".match-option"),s=Array.from(n).find(r=>(r.textContent||"").toLowerCase().includes("not a ballot"));s&&(e.preventDefault(),s.click())}});window.addEventListener("keydown",function(e){(e.key==="Tab"||e.key==="w"||e.key==="W")&&document.body.classList.add("is-keyboard-user")});window.addEventListener("mousedown",function(){document.body.classList.remove("is-keyboard-user")});function j(){const e=H();let a="import";document.getElementById("name-matching")?.style.display!=="none"?a="name-matching":document.getElementById("ballot-review")?.style.display!=="none"?a="ballot-review":document.getElementById("results")?.style.display!=="none"&&(a="results");const i={version:"3.0",timestamp:new Date().toISOString(),inputMode:$,electionName:e,candidates:o.candidates,ballots:o.ballots?o.ballots.map(s=>({voter:s.voter,rankings:s.rankings})):[],rawDiscordInput:{candidates:document.getElementById("discord-candidates")?.value||"",ballots:document.getElementById("discord-ballots")?.value||"",seats:o.seats},nameMatches:Object.fromEntries(o.nameMatches),learnedCorrelations:Object.fromEntries(o.learnedCorrelations),ballotStructuredLines:Object.fromEntries(o.ballotStructuredLines),ballotManuallyModified:Array.from(o.ballotManuallyModified),originalBallotText:Object.fromEntries(o.originalBallotText),reviewedNames:Array.from(o.reviewedNames),uniqueNames:o.uniqueNames,nameCounts:Object.fromEntries(o.nameCounts),currentState:{section:a,currentNameIndex:o.currentNameIndex,currentBallotIndex:I}},t=new Blob([JSON.stringify(i,null,2)],{type:"application/json"}),l=URL.createObjectURL(t),n=document.createElement("a");n.href=l,n.download=Q("stv-election"),n.click(),URL.revokeObjectURL(l)}function ue(){const e=o.roundResults;if(!e||e.length===0){alert("No results to export. Please calculate results first.");return}const i=new Date().toISOString().split("T")[0],l=H()||"Icenian Election",n={config:{contest:l,date:i,jurisdiction:"Icenia",office:l,threshold:(o.ballots.length/(o.seats+1)).toFixed(3)},results:e.map(m=>({round:m.round,tally:Object.fromEntries(Object.entries(m.tally).map(([y,d])=>[y,d.toFixed(3)])),quota:m.quota?parseFloat(m.quota.toFixed(3)):void 0,exhausted:m.exhausted?parseFloat(m.exhausted.toFixed(3)):0,isFinalRound:m.isFinalRound||!1,tallyResults:m.tallyResults}))},s=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),r=URL.createObjectURL(s),p=document.createElement("a");p.href=r,p.download=Q("rcvis-election"),p.click(),URL.revokeObjectURL(r)}function me(e){const a=new FileReader;a.onload=i=>{try{const t=JSON.parse(i.target?.result);if(t.inputMode){$=t.inputMode,localStorage.setItem("input-mode",$);const l=document.querySelector(`input[name="input-mode"][value="${t.inputMode}"]`);l&&(l.checked=!0),$==="discord"?(document.getElementById("simple-mode").style.display="none",document.getElementById("discord-mode").style.display="block"):(document.getElementById("simple-mode").style.display="block",document.getElementById("discord-mode").style.display="none")}if(t.rawDiscordInput){const l=document.getElementById("discord-candidates"),n=document.getElementById("discord-ballots");l&&(l.value=t.rawDiscordInput.candidates||""),n&&(n.value=t.rawDiscordInput.ballots||"")}if(t.learnedCorrelations&&(o.learnedCorrelations=new Map(Object.entries(t.learnedCorrelations))),t.electionName){o.electionName=t.electionName;const l=document.getElementById("election-name");l&&(l.value=o.electionName)}if(t.candidates&&(o.candidates=t.candidates),t.ballots&&(o.ballots=t.ballots),t.rawDiscordInput?.seats&&(o.seats=t.rawDiscordInput.seats),t.nameMatches&&(o.nameMatches=new Map(Object.entries(t.nameMatches).map(([l,n])=>[l,n==="null"?null:n]))),t.ballotStructuredLines&&(o.ballotStructuredLines=new Map(Object.entries(t.ballotStructuredLines).map(([l,n])=>[l,n]))),t.ballotManuallyModified&&(o.ballotManuallyModified=new Set(t.ballotManuallyModified)),t.originalBallotText&&(o.originalBallotText=new Map(Object.entries(t.originalBallotText).map(([l,n])=>[l,n]))),t.reviewedNames&&(o.reviewedNames=new Set(t.reviewedNames)),t.uniqueNames&&(o.uniqueNames=t.uniqueNames),t.nameCounts&&(o.nameCounts=new Map(Object.entries(t.nameCounts).map(([l,n])=>[l,n]))),t.currentState){o.currentNameIndex=t.currentState.currentNameIndex||0,I=t.currentState.currentBallotIndex||0;const l=t.currentState.section;document.getElementById("import-section").style.display="none",document.getElementById("simple-mode").style.display="none",document.getElementById("discord-mode").style.display="none",l==="name-matching"?(document.getElementById("name-matching").style.display="block",B()):l==="ballot-review"?(document.getElementById("ballot-review").style.display="block",x()):l==="results"&&(document.getElementById("results").style.display="block",R())}D(),alert("Election imported successfully!")}catch(t){alert("Failed to import election: "+t.message)}},a.readAsText(e)}function F(){if(!confirm("Are you sure you want to clear all data?"))return;o={candidates:[],ballots:[],seats:0,electionName:"",nameMatches:new Map,uniqueNames:[],currentNameIndex:0,learnedCorrelations:new Map,correlationInfluences:new Map,hasCorrelationWarning:!1,nameCounts:new Map,ballotOverrides:new Map,originalBallotText:new Map,reviewedNames:new Set,duplicateSelections:new Map,ballotStructuredLines:new Map,ballotManuallyModified:new Set},localStorage.removeItem("election-name");const e=document.getElementById("election-name");e&&(e.value=""),document.getElementById("name-matching").style.display="none",document.getElementById("duplicate-voters").style.display="none",document.getElementById("ballot-review").style.display="none",document.getElementById("results").style.display="none",document.getElementById("import-section").style.display="block",$="simple",localStorage.setItem("input-mode","simple"),document.getElementById("mode-simple").checked=!0,document.getElementById("simple-mode").style.display="block",document.getElementById("discord-mode").style.display="none",D()}window.addEventListener("DOMContentLoaded",function(){document.querySelectorAll('input[name="input-mode"]').forEach(l=>{l.addEventListener("change",function(){$=this.value,localStorage.setItem("input-mode",this.value),document.getElementById("simple-mode").style.display=$==="simple"?"block":"none",document.getElementById("discord-mode").style.display=$==="discord"?"block":"none"})});const e=localStorage.getItem("input-mode");if(e){const l=document.querySelector(`input[name="input-mode"][value="${e}"]`);l&&(l.checked=!0,l.dispatchEvent(new Event("change")))}const a=localStorage.getItem("discord-candidates");a&&(document.getElementById("discord-candidates").value=a);const i=localStorage.getItem("discord-ballots");i&&(document.getElementById("discord-ballots").value=i);const t=localStorage.getItem("election-name");t&&(document.getElementById("election-name").value=t,o.electionName=t),document.getElementById("discord-candidates")?.addEventListener("input",function(){localStorage.setItem("discord-candidates",this.value)}),document.getElementById("discord-ballots")?.addEventListener("input",function(){localStorage.setItem("discord-ballots",this.value)}),document.getElementById("election-name")?.addEventListener("input",function(){o.electionName=this.value.trim(),localStorage.setItem("election-name",o.electionName)}),document.getElementById("import-election-button")?.addEventListener("click",()=>document.getElementById("import-file-input").click()),document.getElementById("import-file-input")?.addEventListener("change",l=>{const n=l.target.files?.[0];n&&(me(n),l.target.value="")}),document.getElementById("export-election")?.addEventListener("click",j),document.getElementById("export-election-review")?.addEventListener("click",j),document.getElementById("export-results")?.addEventListener("click",j),document.getElementById("export-rcvis")?.addEventListener("click",ue),document.getElementById("clear-session")?.addEventListener("click",F),document.getElementById("clear-session-start")?.addEventListener("click",F),document.getElementById("clear-session-review")?.addEventListener("click",F),document.getElementById("back-to-discord")?.addEventListener("click",()=>{document.getElementById("name-matching").style.display="none",document.getElementById("discord-mode").style.display="block"}),document.getElementById("back-to-name-matching-from-duplicates")?.addEventListener("click",()=>{document.getElementById("duplicate-voters").style.display="none",document.getElementById("name-matching").style.display="block",o.currentNameIndex=0,B()}),document.getElementById("proceed-to-ballot-review")?.addEventListener("click",W),document.getElementById("back-to-name-matching")?.addEventListener("click",()=>{if(document.getElementById("ballot-review").style.display="none",Array.from(o.duplicateSelections.keys()).length>0){document.getElementById("duplicate-voters").style.display="block";const n=new Map;o.ballots.forEach((r,p)=>{const m=r.voter.replace(/#\d+$/,"");n.has(m)||n.set(m,[]),n.get(m).push(p)});const s=Array.from(n.entries()).filter(([r,p])=>p.length>1);Y(s)}else document.getElementById("name-matching").style.display="block",o.currentNameIndex=0,B()}),document.getElementById("recalculate-results")?.addEventListener("click",()=>{const l=document.getElementById("results-seats");l&&(o.seats=parseInt(l.value)),R()}),document.getElementById("return-to-start")?.addEventListener("click",()=>{document.getElementById("results").style.display="none",document.getElementById("import-section").style.display="block",$==="simple"?document.getElementById("simple-mode").style.display="block":document.getElementById("discord-mode").style.display="block"}),document.getElementById("parse-discord")?.addEventListener("click",function(){const l=document.getElementById("discord-candidates").value,n=document.getElementById("discord-ballots").value,s=parseInt(document.getElementById("discord-seats").value);if(!l.trim()||!n.trim()){alert("Please enter candidates and ballots");return}const r=ae(l);if(r.length===0){alert("No valid candidates found");return}const{ballots:p,originalBallotText:m}=ne(n);if(p.length===0){alert("No valid ballots found");return}o.candidates=r,o.ballots=p,o.seats=s,o.originalBallotText=m;const y=new Map,d=new Set;p.forEach(c=>c.rankings.forEach(u=>{y.set(u,(y.get(u)||0)+1),d.add(u)})),o.nameCounts=y,o.uniqueNames=Array.from(d).sort(),document.getElementById("discord-mode").style.display="none",document.getElementById("name-matching").style.display="block",B(),D()}),document.getElementById("calculate")?.addEventListener("click",function(){const l=document.getElementById("candidates").value,n=document.getElementById("ballots").value,s=parseInt(document.getElementById("seats").value);if(!l.trim()||!n.trim()){alert("Please enter candidates and ballots");return}const r=l.split(`
`).map(d=>d.trim()).filter(d=>d.length>0),p=n.split(`
`).map(d=>d.trim()).filter(d=>d.length>0),m=[],y=new Map;for(let d of p){const c=d.split(":");if(c.length<2)continue;const u=c[0].trim(),g=c[1].split(",").map(f=>f.trim()).filter(f=>f.length>0);m.push({voter:u,rankings:g}),g.forEach(f=>y.set(f,f))}o.candidates=r,o.ballots=m,o.seats=s,o.nameMatches=y,R()}),document.getElementById("loadExample")?.addEventListener("click",function(){document.getElementById("candidates").value=`Ratat0ing
Dr_Bacon_hair
hsmnewfriend
CreepilyCreep
IsraelGPT`,document.getElementById("ballots").value=`recycler: Ratat0ing, Dr_Bacon_hair, hsmnewfriend
alzubloxxer11: Dr_Bacon_hair, hsmnewfriend, Ratat0ing
user3: hsmnewfriend, Ratat0ing
user4: CreepilyCreep, IsraelGPT
user5: IsraelGPT, CreepilyCreep`,document.getElementById("seats").value="2"})});
